<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="一名Android开发小将">
<meta property="og:type" content="website">
<meta property="og:title" content="孟远">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="孟远">
<meta property="og:description" content="一名Android开发小将">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="孟远">
<meta name="twitter:description" content="一名Android开发小将">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>孟远</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">孟远</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">每天进步一点点</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/16/Design-Responsibility/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/16/Design-Responsibility/" itemprop="url">提升代码灵活性-责任链模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-16T15:54:00+08:00">
                2017-11-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="模式介绍"><a href="#模式介绍" class="headerlink" title="模式介绍"></a>模式介绍</h2><p><strong>责任链模式</strong>是行为设计模式之一。</p>
<p>首先我们从字面去理解<strong>责任链模式</strong>：“责任”指的是一个人应尽的义务、分内应做的事；“链”指的是一个个小环首尾相连，组成的长链条。</p>
<p>为什么是“链”？因为“链”的每一环都是可以拆卸的，它们虽然是环环相扣，但是哪天我不想要中间的某一环，我只需要将其去下来即可，这大大提升了代码的灵活性。</p>
<p>所以<strong>责任链模式</strong>通俗来讲，指的是<strong>一件</strong>事情，有顺序地传递给<strong>一群人</strong>，当第一个人无法处理时，再传递给第二个人去做，直到有人可以解决掉这件事情为止。</p>
<h2 id="模式示例"><a href="#模式示例" class="headerlink" title="模式示例"></a>模式示例</h2><p>小明是一家技术公司的测试，他除了完成本职工作外，还负责给技术部的小伙伴购买零食，不过零食钱是先由小明自己垫付的，接着到月底拿着发票去找领导报销的流程。</p>
<p>这个月的月底，小明算了一下，一共花费了2450元。</p>
<p>接着小明拿着零食的发票去找组长报销，结果组长说这金额太大了，只有500以下我才有权限签字，你得去找技术总监。</p>
<p>接着小明找到技术总监，总监说2450太多啦，只有2000以下我才有权限签字，你得去找咱们的老板。</p>
<p>接着小明去到老板的办公室，老板看了一下说非常好，技术部的同学们都非常辛苦，以后都多买一些零食，接着麻溜地就签了字，小明顺利完成了此月的零食报销请求。</p>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><p>通过上述示例，我相信大家已经有些理解<strong>责任链模式</strong>了。</p>
<p>组长、总监、老板针对小明的报销请求，都有自己要做的事情，但是根据小明的报销金额不同，无法第一时间就知道到底是谁来处理这个报销请求。</p>
<p>这就需要小明按照一定的顺序，一个个地去问，直到找到能处理此次报销请求的人为止。</p>
<p>这种情况下，就非常适合使用我们今天要说的<strong>责任链模式</strong>。</p>
<p>通过上面的描述，我们可以得出<strong>责任链模式</strong>的使用场景：</p>
<ul>
<li>一个请求需要多个对象处理，但具体由哪个对象处理需要在运行时动态判断时；</li>
<li>需要动态指定一组对象处理一个请求。</li>
</ul>
<h2 id="所含角色"><a href="#所含角色" class="headerlink" title="所含角色"></a>所含角色</h2><p><strong>责任链模式</strong>包含两个主要角色：</p>
<ul>
<li>处理者抽象(Handler)：抽象的处理者，声明一个处理请求的方法，并在其中保持对下一个处理者的引用。</li>
<li>处理者实现(HandlerImpl)：处理者抽象的具体实现，对请求进行处理，如果无法处理，则通过下一个处理者的引用将其转发下去。</li>
</ul>
<h2 id="具体代码"><a href="#具体代码" class="headerlink" title="具体代码"></a>具体代码</h2><p>针对上述示例和角色描述，我们来将其转化成具体的代码。</p>
<p>首先是处理者的抽象，针对上述示例，我们的抽象的请求处理方法应该为报销：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Leader</span> </span>&#123;</span><br><span class="line">    <span class="comment">//下一个处理者</span></span><br><span class="line">    <span class="keyword">private</span> Leader nextLeader;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理报销请求</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> money 申请报销的金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="function"><span class="keyword">void</span> <span class="title">handlerRequest</span><span class="params">(<span class="keyword">int</span> money)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (money &lt;= getSelfLimit()) &#123;</span><br><span class="line">            <span class="comment">//当申请的金额&lt;=自己的处理额度时,将此次请求消化</span></span><br><span class="line">            <span class="keyword">handler</span>(money);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//否则交给下一个处理者来处理</span></span><br><span class="line">            <span class="keyword">if</span> (nextLeader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                nextLeader.handlerRequest(money);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取自身的额度，由具体实现来设置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 自身能处理的额度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">int</span> <span class="title">getSelfLimit</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 具体处理逻辑在这里实现</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> money 申请报销的金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">void</span> <span class="title">handler</span><span class="params">(<span class="keyword">int</span> money)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">setNextLeader</span><span class="params">(Leader nextLeader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nextLeader = nextLeader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Leader <span class="title">getNextLeader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nextLeader;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>代码还是有些多的，让我们来解释一下这个处理者抽象类：</p>
<ul>
<li>nextLeader：指定了当请求无法处理时，下一级的处理者。这是<strong>责任链模式</strong>中，“链”的核心。对外暴露了set、get方法。</li>
<li>handlerRequest(int money)：注意此方法不是抽象并且是final修饰的，也就是无法重写，无法修改。它其中的逻辑是用来判断此次请求，应该是由自己消化，还是分发给下一个处理者。当你要开始请求时，只需要调用此方法即可。为了适应我们举的示例，这里有一个money参数。这里说一下，每一种设计模式仅仅代表着一种编程思想，具体代码还是要看需求的，如果需求复杂，那么这里分发的逻辑也会复杂、参数也会更多，反之亦然。</li>
<li>getSelfLimit()：抽象方法，指定处理者的最高处理额度。</li>
<li>handler(int money)：当此次请求该由自己消化时，具体的消化逻辑在这里实现。</li>
</ul>
<p>如果还有疑问，不要急，我们先来具体看一个处理者的实现，可能你就会恍然大悟：<br>组长：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">LeaderGroup</span> <span class="keyword">extends</span> <span class="title">Leader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @return 组长报销的处理额度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public int getSelfLimit() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">500</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当报销金额 &lt;= getSelfLimit() 时，请求会到这里来消化</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param money 申请报销的金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public void handler(int money) &#123;</span><br><span class="line">        <span class="type">Toast</span>.makeText(<span class="type">App</span>.context, <span class="string">"小钱，组长报销:"</span> + money, <span class="type">Toast</span>.<span class="type">LENGTH_SHORT</span>).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>组长继承了抽象的处理者，并指定了组长的报销额度以及具体的处理逻辑。<br>同样的，总监和老板也是一样的道理：<br>总监：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">LeaderGeneral</span> <span class="keyword">extends</span> <span class="title">Leader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @return 总监报销的处理额度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public int getSelfLimit() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当报销金额 &lt;= getSelfLimit() 时，请求会到这里来消化</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param money 申请报销的金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public void handler(int money) &#123;</span><br><span class="line">        <span class="type">Toast</span>.makeText(<span class="type">App</span>.context, <span class="string">"金额挺大，总监报销:"</span> + money, <span class="type">Toast</span>.<span class="type">LENGTH_SHORT</span>).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>老板：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">LeaderCEO</span> <span class="keyword">extends</span> <span class="title">Leader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @return 老板报销的处理额度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public int getSelfLimit() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Integer</span>.<span class="type">MAX_VALUE</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当报销金额 &lt;= getSelfLimit() 时，请求会到这里来消化</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param money 申请报销的金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public void handler(int money) &#123;</span><br><span class="line">        <span class="type">Toast</span>.makeText(<span class="type">App</span>.context, <span class="string">"这么多钱，老板报销:"</span> + money, <span class="type">Toast</span>.<span class="type">LENGTH_SHORT</span>).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>至此，我们的处理者抽象，以及处理者实现都已经完成了，下面我们来具体模拟一下报销流程：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取输入框中输入的金额</span></span><br><span class="line">String money = et_money.<span class="keyword">getText</span>().toString();</span><br><span class="line"><span class="keyword">if</span> (TextUtils.isEmpty(money)) &#123;</span><br><span class="line">    Toast.makeText(<span class="keyword">this</span>, <span class="string">"请输入金额"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//组长实例</span></span><br><span class="line">Leader <span class="keyword">group</span> = <span class="keyword">new</span> LeaderGroup();</span><br><span class="line"><span class="comment">//总监实例</span></span><br><span class="line">Leader general = <span class="keyword">new</span> LeaderGeneral();</span><br><span class="line"><span class="comment">//CEO实例</span></span><br><span class="line">Leader CEO = <span class="keyword">new</span> LeaderCEO();</span><br><span class="line"><span class="comment">//组长的下一级是总监</span></span><br><span class="line"><span class="keyword">group</span>.setNextLeader(general);</span><br><span class="line"><span class="comment">//总监的下一级是CEO</span></span><br><span class="line">general.setNextLeader(CEO);</span><br><span class="line"><span class="comment">//由组长优先处理报销</span></span><br><span class="line"><span class="keyword">group</span>.handlerRequest(Integer.valueOf(money));</span><br></pre></td></tr></table></figure></p>
<p>上面的测试代码逻辑也很清晰：</p>
<ol>
<li>获取到具体的报销金额</li>
<li>首先创了组长、总监、CEO的实例</li>
<li>按照组长 -&gt; 总监 -&gt; 老板 的报销顺序将其进行排序</li>
<li>由组长优先处理报销请求，当组长无法处理时，会由组长实例中的下一个处理者来处理。</li>
</ol>
<p>当我们需求发生变化，比如组长的报销金额变成了1000、比如现在组长没有报销权限了等等，你会发现非常地好维护。</p>
<p>这里我们假设总监无法报销了，当组长无法报销时，直接找到CEO来报销：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Leader<span class="built_in"> group </span>= new LeaderGroup();</span><br><span class="line">Leader CEO = new LeaderCEO();</span><br><span class="line"></span><br><span class="line">group.setNextLeader(CEO);</span><br><span class="line"></span><br><span class="line">group.handlerRequest(Integer.valueOf(money));</span><br></pre></td></tr></table></figure></p>
<p>我们仅仅是将组长的下一个处理者改为老板即可，就可以完美删除掉总监的存在。</p>
<p>这种“链”式的写法，完美解耦了请求者和处理者，提高代码了灵活性。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到这里，一个最基本的<strong>责任链模式</strong>就完成了。</p>
<p><a href="https://github.com/YuanTiger/Design-Pattern" target="_blank" rel="noopener">代码已经上传至GitHub</a>。</p>
<p><strong>责任链模式</strong>的优点已经说过了。</p>
<p>缺点就是处理者太多的话，必定会影响性能，尤其是在一些递归调用中，使用时一定要注意。</p>
<h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><p>《Android源码设计模式解析与实战》 何红辉、关爱民 著</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/14/Design-State/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/14/Design-State/" itemprop="url">随时灵活变化-状态模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-14T16:39:52+08:00">
                2017-11-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="模式介绍"><a href="#模式介绍" class="headerlink" title="模式介绍"></a>模式介绍</h2><p><strong>状态模式</strong>的结构和<a href="http://www.jianshu.com/p/5c1f67bc2d66" target="_blank" rel="noopener">策略模式</a>几乎一模一样。</p>
<p>但是它们两者的目的、本质却完全不同。</p>
<p><a href="http://www.jianshu.com/p/5c1f67bc2d66" target="_blank" rel="noopener">策略模式</a>的行为是彼此独立，相互替换的。回想之前举的价格计算器，我们出行时想使用地铁，则使用地铁的价格计算器，如果使用出租车，则使用出租车的价格计算器……</p>
<p>而<strong>状态模式</strong>的行为则是平行的，不可替换的。<strong>状态模式</strong>更像是被封装在对象内部的一个东西，当对象的状态发生变化时，其行为也要发生变化。</p>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ul>
<li>一个对象的行为需要根据状态发生变化，尤其是在运行时状态发生变化，行为需要跟着一起变化时；</li>
<li>代码中有大量判断语句(if、switch)，且这些语句依赖该对象的状态。</li>
</ul>
<h2 id="模式角色"><a href="#模式角色" class="headerlink" title="模式角色"></a>模式角色</h2><ul>
<li>State：状态接口，定义所有行为的抽象。</li>
<li>ConcreteStateA、ConcreteStateB：某个状态的具体行为实现，一个状态对应一个具体行为实现。</li>
</ul>
<h2 id="模式示例"><a href="#模式示例" class="headerlink" title="模式示例"></a>模式示例</h2><p>相信大家在开发中，只要是动态App(和服务器有交互)，都会有登录的需求。</p>
<p>针对这个需求，我们可以得出两个状态：登录状态、未登录状态。</p>
<p>接着我们可以想象一些行为：</p>
<ul>
<li>登录</li>
<li>退出登录</li>
<li>查看账户金币</li>
<li>赚取金币</li>
<li>金币兑换道具</li>
</ul>
<p>针对上述行为，在登录状态和未登录状态下，所做的事情是完全不同的：</p>
<ol>
<li>登录状态：<ul>
<li>登录：提示用户已经登录过了，请勿重复登录</li>
<li>退出登录：清除用户缓存并提示用户退出登录成功</li>
<li>查看账户金币：从服务器查询用户余额</li>
<li>赚取金币：跳转到赚金币页面</li>
<li>金币兑换道具：跳转到兑换道具页</li>
</ul>
</li>
<li>未登录状态：<ul>
<li>登录：判断用户输入的账号密码，正确提示用户登录成功。</li>
<li>退出登录：提示用户已经退出过了。</li>
<li>查看账户金币：提示用户请先登录</li>
<li>赚取金币：跳转到赚金币页(这里也可以提示用户登录，具体看产品定的登录时机)</li>
<li>金币兑换道具：提示用户请先登录</li>
</ul>
</li>
</ol>
<p>想必看完这个示例，大家已经对<strong>状态模式</strong>有了一些自己的见解。</p>
<p>这种情况下，非常适合使用<strong>状态模式</strong>。</p>
<p>如果项目中，还是通过判断语句来进行状态的区分，就说明这个项目没有很好地应用<strong>状态模式</strong>。</p>
<p>下面我们就来将上述案例转化成代码。</p>
<p>首先是状态行为的抽象，该抽象包含了所有的行为：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">UserState</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//登录</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">login</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//登出</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">logout</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询余额</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">seeMoney</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//赚金币</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">earnMoney</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//兑换道具</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exchange</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>针对我们上面描述的示例，有以上5种行为，我们将其进行了抽象。</p>
<p>接着来思考行为的具体实现：登录状态的具体实现、未登录状态的具体实现。</p>
<p>具体做起来也很简单，就是创建两个类去实现我们的行为抽象，在各自的实现下，去实现该状态下，应该做的事情。</p>
<p>首先来看登录状态：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginStateImpl</span> <span class="keyword">implements</span> <span class="title">UserState</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Toast.makeText(App.context, <span class="string">"您已经登录了，无需登录！"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logout</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Toast.makeText(App.context, <span class="string">"退出登录成功！"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">seeMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Toast.makeText(App.context, <span class="string">"您目前有100金币"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">earnMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Toast.makeText(App.context, <span class="string">"跳转到-赚金币"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Toast.makeText(App.context, <span class="string">"跳转到-兑换道具"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据示例需求，我实现了登录状态下，这5种行为的具体实现。</p>
<p>未登录状态也是同理，这里就不列举代码了，可以直接查看<a href="https://github.com/YuanTiger/Design-Pattern" target="_blank" rel="noopener">GitHub</a>。</p>
<p>接下来我们来看一下测试代码：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认是未登录状态</span></span><br><span class="line"><span class="keyword">private</span> UserState userState = <span class="keyword">new</span> LogutStateImpl();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> onClick(View view) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (view.getId()) &#123;</span><br><span class="line">        <span class="keyword">case</span> R.id.<span class="string">bt_login:</span><span class="comment">//登录行为</span></span><br><span class="line">            userState.login();</span><br><span class="line">            <span class="comment">//核心：更换用户状态</span></span><br><span class="line">            userState = <span class="keyword">new</span> LoginStateImpl();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.<span class="string">bt_logout:</span><span class="comment">//退出登录行为</span></span><br><span class="line">            userState.logout();</span><br><span class="line">            userState = <span class="keyword">new</span> LogutStateImpl();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.<span class="string">bt_see_money:</span><span class="comment">//查看余额行为</span></span><br><span class="line">            userState.seeMoney();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.<span class="string">bt_earn_money:</span><span class="comment">//赚取金币行为</span></span><br><span class="line">            userState.earnMoney();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.<span class="string">bt_exchange:</span><span class="comment">//兑换行为</span></span><br><span class="line">            userState.exchange();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里也是利用多态的特性，根据状态的变化，注入不同的实现。</p>
<p>至此，我们已经使用<strong>状态模式</strong>成功实现了上述需求，并且去除了重复、杂乱的判断语句，体现出了<strong>状态模式</strong>的精髓。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>代码已经上传至<a href="https://github.com/YuanTiger/Design-Pattern" target="_blank" rel="noopener">GitHub</a>，可以下载查阅。</p>
<p>其实看到这里，各位看官想必已经了解了状态模式。</p>
<p><strong>状态模式</strong>的关键点在于：不同状态下、同一行为的不同响应。</p>
<p><strong>状态模式</strong>是为了优化代码结构而产生的。我们通过if-else其实可以完美判断用户的登录状态，但是这种实现使得逻辑与具体行为耦合在一起，后期难以维护。</p>
<p><strong>状态模式</strong>就是为了消除这种丑态，实现逻辑与行为的解耦。</p>
<p>当然并不是所有的if-else都适合使用<strong>状态模式</strong>，具体是否使用，还是由你来决定。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/24/JD-Server-Use-Explain-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/24/JD-Server-Use-Explain-1/" itemprop="url">京东云主机使用(1)-使用Java+Tomcat开始开发</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-24T16:40:03+08:00">
                2017-08-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="http://www.jianshu.com/p/7493b1b98c1c" target="_blank" rel="noopener">上一篇</a>介绍了京东云主机的登录和简单的静态网页配置。</p>
<p>这一篇主要讲述服务器开发环境的配置和部署。</p>
<p>首先，实现服务器开发的语言特别多：Java、PHP、Node.JS、Python等。</p>
<p>这里我选择的是Java+Tomcat+IDEA。</p>
<p>所以本篇文章是围绕着这三者展开的。</p>
<p>并且我们的服务器系统是：Ubuntu 16.04 64。 没看<a href="http://www.jianshu.com/p/7493b1b98c1c" target="_blank" rel="noopener">上一篇</a>的看官需要了解。</p>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><h4 id="Java环境配置"><a href="#Java环境配置" class="headerlink" title="Java环境配置"></a>Java环境配置</h4><p>首先我们先输入用户名密码登录我们的服务器：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd_server_use_1.png" alt="登录成功"></p>
<p>接下来，我们先删除之前下载的apache2，这里我们已经用不到了：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="builtin-name">get</span> <span class="builtin-name">remove</span> apache2</span><br></pre></td></tr></table></figure></p>
<p>现在我们开始下载JDK，先切换目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</span><br></pre></td></tr></table></figure></p>
<p>下载JDK：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo wget http:<span class="regexp">//</span>download.oracle.com<span class="regexp">/otn-pub/</span>java<span class="regexp">/jdk/</span><span class="number">8</span>u144-b01<span class="regexp">/090f390dda5b47b9b721c7dfaa008135/</span>jdk-<span class="number">8</span>u144-linux-x64.tar.gz</span><br></pre></td></tr></table></figure></p>
<p>这个http链接对应的是写本篇文章时，最新版本的JDK地址。</p>
<p>下载完成后，将其解压：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvzf jdk-<span class="number">8</span>u144-linux-x64<span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure></p>
<p>解压完成后，删除压缩包：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm jdk-<span class="number">8</span>u144-linux-x64<span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure></p>
<p>到这里，下载步骤就算完成了，接着开始环境变量的配置：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> /etc/<span class="keyword">profile</span></span><br></pre></td></tr></table></figure></p>
<p>Vim是Linux文件编辑模式，该命令会打开文件并可进行编辑。</p>
<p>该命令的功能非常强大，如果之前你没有见过该命令，这次可以先稍微了解一下。</p>
<p><a href="http://pizn.github.io/2012/03/03/vim-commonly-used-command.html" target="_blank" rel="noopener">如果非要现在学习vim，可以参考此文。</a></p>
<p>这里我简单介绍一下该命令。</p>
<p>Vim命令有三种模式：普通模式、编辑模式、命令模式。</p>
<p>顾名思义，想要编辑必须进入编辑模式，想要进行保存或是退出就要进入命令模式，平时浏览时处于普通模式即可。</p>
<p>这里我们以刚才执行的命令开始进行讲解。</p>
<p>在执行完<code>vim /etc/profile</code>后，会打开/etc/profile文件，此时默认处于普通模式。</p>
<p>我们只需一直往下滑动，或是使用Ctrl+F/D，滑动到文件底部。</p>
<p>接着将光标移动至内容的最下方，点击i/c/o进入编辑模式，复制以下内容：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JAVA_HOME=<span class="regexp">/usr/local</span><span class="regexp">/jdk1.8.0_144</span></span><br><span class="line"><span class="regexp">JAVA_BIN=/usr</span><span class="regexp">/local/jdk</span>1.<span class="number">8.0_144</span>/bin</span><br><span class="line">JRE_HOME=<span class="regexp">/usr/local</span><span class="regexp">/jdk1.8.0_144/jre</span></span><br><span class="line">PATH=$<span class="symbol">PATH:</span>$JAVA_HOME/<span class="symbol">bin:</span>$JRE_HOME/bin</span><br><span class="line">CLASSPATH=:$JAVA_HOME/<span class="class"><span class="keyword">lib</span>/<span class="title">dt</span>.<span class="title">jar</span>:$<span class="title">JAVA_HOME</span>/<span class="title">lib</span>/<span class="title">tools</span>.<span class="title">jar</span>:$<span class="title">JRE_HOME</span>/<span class="title">lib</span></span></span><br><span class="line">export JAVA_HOME JAVA_BIN JRE_HOME PATH CLASSPATH</span><br></pre></td></tr></table></figure></p>
<p>如果各位看官修改了安装路径，这里注意要匹配。</p>
<p>复制完成后，点击Esc，即可退出编辑模式。</p>
<p>接着输入冒号（Shift+；），进入命令模式。</p>
<p>输入wq，然后回车，进行文件的保存并退出Vim模式。</p>
<p>至此，Java的环境变量应该已经配置成功，使用命令来刷新环境：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">source</span> <span class="regexp">/etc/</span>profile</span><br></pre></td></tr></table></figure></p>
<p>接着输入：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -<span class="built_in">version</span></span><br></pre></td></tr></table></figure></p>
<p>如果效果如下：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd1_server_use_0.png" alt="Java环境测试"></p>
<p>代表环境变量已经配置成功。</p>
<p>如果失败，请检查环境变量的路径是否正确，或是JDK是否安装成功。</p>
<h4 id="Tomcat环境配置"><a href="#Tomcat环境配置" class="headerlink" title="Tomcat环境配置"></a>Tomcat环境配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</span><br></pre></td></tr></table></figure>
<p>下载Tomcat压缩包:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo wget http:<span class="regexp">//</span>archive.apache.org<span class="regexp">/dist/</span>tomcat<span class="regexp">/tomcat-8/</span>v8.<span class="number">5.20</span><span class="regexp">/bin/</span>apache-tomcat-<span class="number">8.5</span>.<span class="number">20</span>.tar.gz</span><br></pre></td></tr></table></figure></p>
<p>该包的版本是Tomcat8.5.20，如果不适合你，可以去<a href="http://archive.apache.org/dist/tomcat" target="_blank" rel="noopener">Tomcat下载页</a>自行选择。</p>
<p>接着进行解压：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">tar</span> <span class="selector-tag">zxvf</span> <span class="selector-tag">apache-tomcat-8</span><span class="selector-class">.5</span><span class="selector-class">.20</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure></p>
<p>解压完成后，这个文件的名字也太长了，我们重命名一下：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv apache-tomcat<span class="number">-8.5</span><span class="number">.20</span> /usr/local/tomcat</span><br></pre></td></tr></table></figure></p>
<p>接着拷贝catalina.sh<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -p <span class="regexp">/usr/</span>local<span class="regexp">/tomcat/</span>bin<span class="regexp">/catalina.sh /</span>etc<span class="regexp">/init.d/</span>tomcat</span><br></pre></td></tr></table></figure></p>
<p>开始配置环境：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="regexp">/etc/i</span>nit.d<span class="regexp">/tomcat</span></span><br></pre></td></tr></table></figure></p>
<p>操作方式和之前描述的一样，在开头直接添加以下内容：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">JAVA_HOME</span>=/usr/local/jdk1.8.0_144</span><br><span class="line"><span class="attribute">CATALINA_HOME</span>=/usr/local/tomcat</span><br><span class="line"></span><br><span class="line">chmod 755 /etc/init.d/tomcat</span><br><span class="line">chkconfig --<span class="builtin-name">add</span> tomcat</span><br><span class="line">chkconfig tomcat on</span><br></pre></td></tr></table></figure></p>
<p>至此，Tomcat的环境变量配置工作，已经完成。</p>
<p>下面我们来启动Tomcat：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service tomcat <span class="literal">start</span></span><br></pre></td></tr></table></figure></p>
<p>验证启动是否成功：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ps</span> -ef|<span class="keyword">grep</span> tomcat</span><br></pre></td></tr></table></figure></p>
<p>如果输出内容如下,则代表启动成功：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd1_server_use_2.png" alt="Tomcat启动成功"></p>
<p>如果输出内容如下，则代表失败：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd1_server_use_1.png" alt="Tomcat启动失败"></p>
<p>启动失败的原因基本上都是因为环境配置的问题，请仔细检查路径配置。</p>
<p>启动成功后，在浏览器输入IP://8080,比如：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">116<span class="selector-class">.196</span><span class="selector-class">.93</span><span class="selector-class">.148</span><span class="selector-pseudo">:8080</span></span><br></pre></td></tr></table></figure></p>
<p>即可看到如下效果：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd1_server_use_3.png" alt="Tomcat运行效果"></p>
<p>有些人说，我不想输入端口号，怎么办？<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="regexp">/usr/</span>local<span class="regexp">/tomcat/</span>conf<span class="regexp">/server.xml</span></span><br></pre></td></tr></table></figure></p>
<p>执行上述命令打开Tomcat的配置文件，找到如下内容：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/jd1_server_use_4.png" alt="server修改端口号"></p>
<p>进入编辑模式将port 改为 80 即可。</p>
<p>如果你还买了域名，想要监听域名，找到如下内容：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/jd1_server_use_5.png" alt="server修改默认地址"></p>
<p>进入编辑模式将name改为自己的域名即可。</p>
<p>修改完成后进入命令模式输入wq保存并退出。</p>
<p>接着重启Tomcat：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service tomcat stop</span><br><span class="line">service tomcat start</span><br></pre></td></tr></table></figure></p>
<p>之后再访问的话，就不用带端口号了。</p>
<p>如果你修改了Host-name，记得使用你修改的域名。</p>
<p>至此，我们服务器的环境搭建工作就告一段落了。</p>
<h2 id="HelloWeb"><a href="#HelloWeb" class="headerlink" title="HelloWeb"></a>HelloWeb</h2><p>接下来我们就要开始开发我们的Web项目了！</p>
<p>这里我下载了<a href="https://www.jetbrains.com/idea/download/#section=mac" target="_blank" rel="noopener">IntelliJ IDEA</a>作为我的开发软件。</p>
<p>这里注意要下载商业版，也就是Ultimate版。</p>
<p>Community版是不支持Web开发的。</p>
<p>下载完成后，我们需要为本机也装上Java和Tomcat。</p>
<p>接着我们就可以开始开发HelloWorld了！</p>
<p>具体的下载和开发流程，我这里就不介绍了，<a href="http://www.cnblogs.com/carsonzhu/p/5468223.html" target="_blank" rel="noopener">参考此文</a>。</p>
<p>我就是按照一步一步来进行开发的。</p>
<p>按照上述步骤开发完成后，我们的HelloWorld就已经在本机完成了。</p>
<p>效果如下：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd1_server_use_6.png" alt="localhost:8080"></p>
<p>接着我们要将该项目部署到我们自己的服务器上，让所有人都可以访问！</p>
<p>最基本的方法就是将项目达成War包，将War包上传至Linux服务器的Tomcat/webapps文件夹中。</p>
<p>之后在访问时，Tomcat会自动将War包进行解压。</p>
<p>传输的方法，可以参考上次说到的<a href="http://www.jianshu.com/p/1afd25e7459d" target="_blank" rel="noopener">Mac向服务器上传文件</a>。</p>
<p>Windows的话可以使用Xshell。</p>
<p>这里我们就不做过多介绍了，因为这种方式明显过于繁琐，每次修改项目都要重新生成War包并上传服务器。</p>
<p>我希望我们可以像是在本机调试一样，修改完成后点击运行就可以看到效果。</p>
<p>这就是我们接下来要做的事情。</p>
<h2 id="Hello-热部署"><a href="#Hello-热部署" class="headerlink" title="Hello 热部署"></a>Hello 热部署</h2><p>我们首先登录自己的Linux服务器，切换到自己的Tomcat的bin目录下：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/usr/</span>local<span class="regexp">/tomcat/</span>bin<span class="regexp">/</span></span><br></pre></td></tr></table></figure></p>
<p>接下来打开VIM模式，开始编辑<strong>catalina.sh</strong>文件：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> catalina.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure></p>
<p>在文件的100行，也就是<code># OS specific support.  $var _must_ be set to either true or false.</code>之上，添加如下代码：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">export CATALINA_OPTS="-Dcom.sun.management.jmxremote </span><br><span class="line">-<span class="ruby">Dcom.sun.management.jmxremote.port=<span class="number">9999</span> </span></span><br><span class="line"><span class="ruby">-Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span> </span></span><br><span class="line"><span class="ruby">-Dcom.sun.management.jmxremote.authenticate=<span class="literal">false</span> </span></span><br><span class="line"><span class="ruby">-Djava.rmi.server.hostname=<span class="number">116.196</span>.<span class="number">93.148</span><span class="string">"</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">export JAVA_OPTS=<span class="string">"-Dcom.sun.management.jmxremote</span></span></span><br><span class="line"><span class="ruby">-Dcom.sun.management.jmxremote.port=<span class="number">9999</span></span></span><br><span class="line"><span class="ruby">-Dcom.sun.management.jmxremote.ssl=<span class="literal">false</span></span></span><br><span class="line"><span class="ruby">-Dcom.sun.management.jmxremote.authenticate=<span class="literal">false</span><span class="string">"</span></span></span><br></pre></td></tr></table></figure></p>
<p>其中要注意的是，hostname为自己的IP地址，两个port设置为和本机不冲突的端口号即可，注意此端口号不是Tomcat的访问端口，要进行区分，比如我设置的就是9999，你也可以选择使用它。</p>
<p>添加修改完成后保存退出，接下来要对自己的IP地址进行映射。先查看自己的用户名：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">uname -n</span></span><br></pre></td></tr></table></figure></p>
<p>将显示出来的用户名进行复制。</p>
<p>接下来打开hosts文件：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="regexp">/etc/</span>hosts</span><br></pre></td></tr></table></figure></p>
<p>添加如下代码：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-class">.1</span>      复制的用户名</span><br><span class="line"><span class="selector-pseudo">::1</span>     复制的用户名</span><br></pre></td></tr></table></figure></p>
<p>注意不用删除和注释其他映射，只需添加即可。</p>
<p>映射完成后，我们需要重启Tomcat：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service tomcat <span class="built_in">stop</span></span><br></pre></td></tr></table></figure></p>
<p>执行完后请确认是否关闭成功：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ps</span> -ef|<span class="keyword">grep</span> tomcat</span><br></pre></td></tr></table></figure></p>
<p>如果输出</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd1_server_use_2.png" alt="Tomcat关闭失败"></p>
<p>则代表关闭失败，执行下句命令强制关闭：<br><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//port为端口号，像上述图片中，端口为2392</span></span><br><span class="line"><span class="keyword">kill</span> -<span class="number">9</span> port</span><br></pre></td></tr></table></figure></p>
<p>接下来启动Tomcat，因为我们修改了<strong>catalina.sh</strong>，所以我们不能使用<strong>startup.sh</strong>来启动Tomcat，需使用：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注意此时的目录还是在Tomcat/bin目录下</span></span><br><span class="line"><span class="comment">// &gt; /dev/null 2&gt;&amp;1 &amp;  的含义是不显示启动日志</span></span><br><span class="line"><span class="keyword">sh</span> catalina.<span class="keyword">sh</span> <span class="keyword">run</span> &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p>确认启动成功：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ps</span> -ef|<span class="keyword">grep</span> tomcat</span><br></pre></td></tr></table></figure></p>
<p>启动成功后，我们Linux服务器的配置就结束了！</p>
<p>我们回到IDEA中，进行IDEA的配置。</p>
<p>首先打开Configurations：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd1_server_use_7.png" alt="Configurations"></p>
<p>接着创建远端Tomcat：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/jd1_server_use8.png" alt="创建远端Tomcat"></p>
<p>接着开始进行远端Tomcat的配置：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/jd1_server_use_9.png" alt="远端Tomcat配置"></p>
<p>SFTP协议配置：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/jd1_server_use_10.png" alt="SFTP协议配置"></p>
<p>接着添加部署项目：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/jd1_server_use_11.png" alt="添加项目"></p>
<p>点击OK进行保存，接着我们选择使用远端Tomcat来部署并运行项目：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/jd1_server_use_12.png" alt="运行项目"></p>
<p>如果出现以下效果：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd1_server_use_13.png" alt="运行失败"></p>
<p>代表连接远端失败，请仔细检查你的配置，此过程比较耗时。</p>
<p>运行成功Log如下：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd1_server_use_14.png" alt="成功Log"></p>
<p>效果如下：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd1_server_use_15.png" alt="成功效果"></p>
<p>注意上图访问的IP，是我们Linux服务器的地址，也就代表我们成功将项目部署到了我们的服务器上。</p>
<p>接着我们修改index.jsp，再次运行项目：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd1_server_use_16.png" alt="热部署效果"></p>
<p>可以看到我们修改的效果已经成功部署到服务器中。</p>
<p>上文中的IP就是我的服务器IP，大家也可以访问的。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此，我们已经成功使用IDEA+Tomcat+Java实现了项目的开发以及热部署。</p>
<p>接下来就比较自由了，自己的项目就由自己去写了。</p>
<p>可以搭建个人博客，可以搭建资源共享网页等等。</p>
<p>各有各的风格，大家可以自行学习后台开发，搭建过程就不准备再写博客了。</p>
<p>碰巧今天是七夕节，今天看文章的人都是敬业的程序员！</p>
<p>噗哈哈哈，祝大家七夕节开心快乐！</p>
<h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><p><a href="http://wiki.jikexueyuan.com/project/linux/tomcat.html" target="_blank" rel="noopener">搭建JDK+Tomcat</a></p>
<p><a href="http://www.jianshu.com/p/1afd25e7459d" target="_blank" rel="noopener">Mac向服务器上传文件</a></p>
<p><a href="http://blog.csdn.net/tianjun2012/article/details/52795202" target="_blank" rel="noopener">idea部署项目到远程tomcat</a></p>
<p><a href="http://pizn.github.io/2012/03/03/vim-commonly-used-command.html" target="_blank" rel="noopener">Linux VIM命令使用</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/23/JD-Server-Use-Explain-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/23/JD-Server-Use-Explain-0/" itemprop="url">京东云主机使用(0)-搭建简单网页（macOS）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-23T11:37:13+08:00">
                2017-08-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在郭霖大神的带领下，我花了一元钱入手了2个月的京东云主机，也就是个人服务器。</p>
<p>这是我人生第一台服务器，多么值得纪念。。。。。。</p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzA5MzI3NjE2MA==&amp;mid=2650240867&amp;idx=1&amp;sn=d56fceac5b343ccc4a90cd422c490df0&amp;chksm=8863860cbf140f1add1f86fab6267b28e0173350e571ac7192f9a794e2526cadf6dab765d8e2&amp;scene=38#wechat_redirect" target="_blank" rel="noopener">入手地址在这里</a></p>
<p>一直不买的原因也是因为自己的Android水平没有达标，不想去学其他方面的知识而分心。</p>
<p>其实很容易发现这他喵的就是一个不想学习的借口罢了！</p>
<p>更容易发现这明显是没钱买吧！</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/gaoxiao/drop_table.jpeg" alt=""></p>
<p>所以趁此机会，入手了2个月服务器来尝鲜。名额有限，说不定已经没有了。。。</p>
<p>购买流程就不说了，服务器系统选择的是Ubuntu 16.04 64位。</p>
<p>接下来的使用状况都是围绕着Ubuntu 16.04 64位展开的。</p>
<h2 id="登录云主机"><a href="#登录云主机" class="headerlink" title="登录云主机"></a>登录云主机</h2><p>郭霖大神推荐了两款软件用于控制服务器 和 上传下载服务器文件:Xshell和Xftp。</p>
<p>但是两款软件都是Windows系统的，没有macOS系统。</p>
<p>如果你是Windows系统的，可移步郭霖大神的<a href="https://mp.weixin.qq.com/s?__biz=MzA5MzI3NjE2MA==&amp;mid=2650240867&amp;idx=1&amp;sn=d56fceac5b343ccc4a90cd422c490df0&amp;chksm=8863860cbf140f1add1f86fab6267b28e0173350e571ac7192f9a794e2526cadf6dab765d8e2&amp;scene=38#wechat_redirect" target="_blank" rel="noopener">搭建教程</a>，相对比较简单。</p>
<p>那么如何在macOS系统下操作服务器呢？</p>
<p>在<a href="http://www.jcloud.com/help/detail/360/isCateLog/1" target="_blank" rel="noopener">京东云的帮助中心</a>中，macOS系统的登录方式有两种：一种是VNC登录，一种是SSH密钥登录。</p>
<h4 id="VNC登录"><a href="#VNC登录" class="headerlink" title="VNC登录"></a>VNC登录</h4><p>VNC登录是京东云为用户提供的一种通过Web浏览器连接服务器的方式。</p>
<p>很简单，就是在京东云的控制台点击远程连接即可。</p>
<p>接着打开了Ubuntu 16.04 64的控制台，需要先进行登录，用户名为root，密码发送到了你的邮箱和手机当中。<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd_server_use_0.png" alt="登录面板"></p>
<p>如果想要修改密码，可在控制台-操作 进行修改。修改完成后记得重启生效。</p>
<p>输入完成并正确就登录上了服务器，非常简单。<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd_server_use_1.png" alt="登录成功"></p>
<p>不过使用VNC登录的场景很少：</p>
<ul>
<li><p>查看云服务的启动进度</p>
</li>
<li><p>无法通过其他登录方式登录时，才使用VNC来登录服务器</p>
</li>
</ul>
<p>所以这种登录方式，体验体验即可，并不实用。</p>
<p>并且它不支持复制粘贴、不支持文件上传，而且是单点登录，使用起来简直是折磨。</p>
<h4 id="SSH密钥登录"><a href="#SSH密钥登录" class="headerlink" title="SSH密钥登录"></a>SSH密钥登录</h4><p>京东云帮助中心提供了<a href="http://www.jcloud.com/help/detail/346/isCateLog/1" target="_blank" rel="noopener">SSH创建和登录教程</a>。</p>
<p>成功设置SSH密钥后，我们就可以不使用VNC登录，直接在Mac的命令行就可以进行服务器的登录。</p>
<p>下面我们来一步一步设置SSH密钥：</p>
<p>什么是SSH密钥？</p>
<p>就我的理解而言，它是一种网络通讯协议，主要用于计算机之间的加密登录。</p>
<p>使用SSH登录的具体流程如下：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd_server_use_2.png" alt="SSH密钥登录"></p>
<p>可以看出一个SSH串要提供给服务器和本机，当SSH串匹配成功后，就可以实现免密登录。</p>
<p>这样的优点就是当登录请求被恶意拦截时，密码也不会泄露。</p>
<p>接下来，我们就要生成SSH密钥，并保存到本机和服务器。</p>
<p>要说一句的是，SSH密钥登录很多地方都有用到，比如GitHub。</p>
<p>如果你的电脑已经有SSH密钥，那么直接使用这个即可。在我的理解下，一台电脑只能有一个SSH密钥。</p>
<p>具体的SSH成功流程可参考<a href="https://help.github.com/articles/connecting-to-github-with-ssh/" target="_blank" rel="noopener">GitHub官方教程</a>。</p>
<p> 在这里我也简单罗列一下SSH密钥的生成步骤：</p>
<p>1.校验本机是否已经生成SSH密钥：<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ls</span> -al ~<span class="string">/.ssh</span></span><br></pre></td></tr></table></figure></p>
<p>如果输出了<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">id_dsa.pub</span><br><span class="line">id_ecdsa.pub</span><br><span class="line">id_ed25519.pub</span><br><span class="line">id_rsa.pub</span><br></pre></td></tr></table></figure></p>
<p>则代表已经生成过，直接跳过第二步，执行第三步。</p>
<p>2.生成SSH密钥。如果已经生成跳过。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注意修改最后的E-mail地址</span></span><br><span class="line">ssh-keygen -t rsa -<span class="selector-tag">b</span> <span class="number">4096</span> -C <span class="string">"your_email@example.com"</span></span><br></pre></td></tr></table></figure></p>
<p>执行完成后，会让输入保存路径，直接按下回车，使用默认路径进行SSH密钥的保存就可以。</p>
<p>接着会提示你输入该SSH的密钥密码，可以为空，直接回车，想设置的同学也可以进行设置。</p>
<p>该SSH密钥密码用于第一次使用SSH时的校验，并可以在SSH密钥的配置文件中关闭SSH密钥密码校验。</p>
<p>我是设置的，更多细节大家可以自己去查阅一些资料。</p>
<p>3.复制SSH密钥。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pbcopy &lt; ~<span class="regexp">/.ssh/i</span>d_rsa.pub</span><br></pre></td></tr></table></figure></p>
<p>使用该命令后，你的粘贴板内容就会变成SSH密钥。</p>
<p>这次我们要将SSH密钥上传到我们自己的服务器里。</p>
<p>打开京东云的控制板，添加SSH密钥：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/jd_server_use_3.png" alt="京东云添加SSH密钥"></p>
<p>接着点击完成，Over。</p>
<p>4.测试SSH密钥。<br>使用SSH密钥登录也非常简单。<br>打开我们Mac的命令行输入：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ssh</span> <span class="selector-tag">user</span>@<span class="keyword">xxx</span>.<span class="keyword">xxx</span>.<span class="keyword">xxx</span>.<span class="keyword">xxx</span></span><br></pre></td></tr></table></figure></p>
<p>user为用户名，我们的用户名为root。@之后为IP地址，比如：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ssh</span> <span class="selector-tag">root</span>@<span class="keyword">116</span>.<span class="keyword">196</span>.<span class="keyword">93</span>.<span class="keyword">148</span></span><br></pre></td></tr></table></figure></p>
<p>接着会提示输入用户输入服务器的登录密码，正确后就可以登录成功。</p>
<p>如果失败，建议按照<a href="http://www.jcloud.com/help/detail/346/isCateLog/1" target="_blank" rel="noopener">京东云帮助中心教程</a>，走一遍。</p>
<h2 id="简单网页搭建"><a href="#简单网页搭建" class="headerlink" title="简单网页搭建"></a>简单网页搭建</h2><p>我们先为我们的服务器下载一个服务器，这里使用郭神用的apache2。</p>
<p>apache2是专门用来显示静态网页的服务器程序。</p>
<p>在登录服务器成功后输入下面命令：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="builtin-name">get</span> install apache2</span><br></pre></td></tr></table></figure></p>
<p>接着输入Y完成安装。</p>
<p>之后打开浏览器，输入我们服务器的IP，可以看到下面效果：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd_server_use_4.png" alt=""></p>
<p>接着我们来替换这个html文件样式。</p>
<p>它在我们服务器的地址是：/var/www/html/index.html</p>
<p>我们只要自己写一个简单的静态Html文件，然后上传服务器覆盖掉它即可。</p>
<p>这里我们直接拿着郭神的简单html来做示范：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!Doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>京东云测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">      <span class="selector-tag">body</span>&#123;<span class="attribute">text-align</span>:center&#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>欢迎来到郭霖的京东云主页<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">      点击</span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://guolin.tech"</span>&gt;</span>这里<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      跳转到我的博客</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>将该文件保存为index.html。</p>
<p>接着我们将该文件上传至服务器,这里有一篇<a href="http://www.jianshu.com/p/1afd25e7459d" target="_blank" rel="noopener">mac向服务器上传文件的教程</a>。非常好用。<br>上传命令：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span>注意将yourUsername修改为你的mac用户名</span><br><span class="line"><span class="regexp">//</span>并且我的文件保存在桌面Desktop。</span><br><span class="line">put <span class="regexp">/Users/y</span>ourUsername<span class="regexp">/Desktop/i</span>ndex.html <span class="regexp">/var/</span>www<span class="regexp">/html</span></span><br></pre></td></tr></table></figure></p>
<p>按照上述步骤后，我们成功将index.html上传至服务器并覆盖。<br>刷新我们的网页，可以看到下面效果：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd_server_use_5.png" alt="效果"></p>
<p>。。。。。。。</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/gaoxiao/drop_table.jpeg" alt=""></p>
<p>为什么显示源码！？</p>
<p>因为Mac的记事本以.html结尾时，会将内容格式化成文本，不做代码显示。</p>
<p>解决也很简单，<a href="https://www.zhihu.com/question/21887357" target="_blank" rel="noopener">这篇文章</a>。</p>
<p>解决后重新执行上传代码，重新刷新页面，效果如下：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/jd_server_6.png" alt="效果"></p>
<p>简单查阅后，在head中添加如下代码即可：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta <span class="attribute">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attribute">content</span>=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span><br></pre></td></tr></table></figure></p>
<p>接着再次执行文件上传，再次刷新页面，效果如下：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/server/jd_server_use_7.png" alt="效果"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此，一个非常简单的静态网页的个人博客便搭建完成了！</p>
<p>写出这么个静态网页，带上这篇博客的出炉，一共耗时2天，走的弯路没有描述。</p>
<p>其中包括Linux命令行控制、SSH密钥理解等，都是新知识，于我而言还是有很大提升的。</p>
<p>以后如果用这个服务器，搭建一个动态的个人博客。</p>
<p>想想还有些小激动呢！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/02/Design-Strategy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/02/Design-Strategy/" itemprop="url">实现动态替换-策略模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-02T17:15:00+08:00">
                2017-08-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="模式介绍"><a href="#模式介绍" class="headerlink" title="模式介绍"></a>模式介绍</h2><p>通常，我们实现一个功能，可以有多种策略。</p>
<p>我们可以根据实际需求来选择最合适的策略。</p>
<p>针对这种情况，一种常规的方法就是将多种策略封装在一个类中，每个策略对应一个方法，在使用时通过if-else进行情况判断，不同情况调用不同方法来实现不同的策略。</p>
<p>这种实现方法我们可以称之为硬编码。</p>
<p>然而，当策略越来越多的时候，这个类就会变得臃肿，并且由于if-else等复杂逻辑的存在，在维护时会更容易产生错误，维护成本就会变高。</p>
<p>并且这种写法明显违反了<a href="http://www.jianshu.com/p/2c5826aa996c" target="_blank" rel="noopener">面向对象</a>中的开闭原则。</p>
<p>如果我们将这些策略的共同点抽象出来，提供一个统一的接口，不同的策略有着不同的实现，这样在客户端就可以通过注入不同的实现对象来实现动态替换。</p>
<p>这种模式的可扩展性、可维护性都是极高的。这，就是我们要说的<strong>策略模式</strong>。</p>
<h2 id="模式定义"><a href="#模式定义" class="headerlink" title="模式定义"></a>模式定义</h2><p>针对一个功能，将每一种解决方案封装起来，而且使它们可以相互替换。</p>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ul>
<li>针对同一类型问题的多种处理方式，仅仅是具体行为存在差异；</li>
<li>需要安全地封装多种同一类型的操作时；</li>
<li>同一抽象类有多个子类，同时又需要使用if-else或swithc-case来选择具体子类时。</li>
</ul>
<h2 id="模式角色"><a href="#模式角色" class="headerlink" title="模式角色"></a>模式角色</h2><ul>
<li>Strategy：策略抽象。</li>
<li>ConcreteStrategy：具体策略，针对一个问题，有多少种策略，就应有多少个具体策略。</li>
</ul>
<h2 id="模式示例"><a href="#模式示例" class="headerlink" title="模式示例"></a>模式示例</h2><p>2014年12月28日北京提高了公交、地铁的价格，不再是单一票价，而是分距离计价。</p>
<p>我们就根据上述需求，来做一个出行价格计算器。</p>
<p>话不多说，我们来实现这个功能：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/DesignModel/design_strategy_ui.png" alt="测试UI"><br>简单做了计算器的UI，它应该提供具体出行方式的选择，很明显，我们提供了三种。</p>
<p>并且有一个出行距离的输入框。</p>
<p>在获取到出行方式和出行距离后，我们就可以来计算具体价格。</p>
<p>需求很明确，接下来我们要做的就是先实现各种出行方式下的价格计算：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PriceCaculateController</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据出行方式，选择距离的计算方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">cacluatePrice</span><span class="params">(<span class="keyword">int</span> km, <span class="keyword">int</span> typeMode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (typeMode) &#123;</span><br><span class="line">            <span class="keyword">case</span> Constant.TYPE_BUS:</span><br><span class="line">                <span class="keyword">return</span> caculateBusPrice(km);</span><br><span class="line">            <span class="keyword">case</span> Constant.TYPE_SUBWAY:</span><br><span class="line">                <span class="keyword">return</span> caculateSubwayPrice(km);</span><br><span class="line">            <span class="keyword">case</span> Constant.TYPE_TAX:</span><br><span class="line">                <span class="keyword">return</span> caculateTaxPrice(km);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算出租车价格</span></span><br><span class="line"><span class="comment">     * 小于3Km，定价9元，大于3km，每1km + 1元</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">caculateTaxPrice</span><span class="params">(<span class="keyword">int</span> km)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">9</span> + (km - <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算公交车价格</span></span><br><span class="line"><span class="comment">     * 小于5Km，定价2元，小于10km，定价3元，其余4元</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">caculateBusPrice</span><span class="params">(<span class="keyword">int</span> km)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算地铁价格</span></span><br><span class="line"><span class="comment">     * 小于5Km，定价3元，小于10km，定价4元，小于15Km，定价5元，其余6元</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">caculateSubwayPrice</span><span class="params">(<span class="keyword">int</span> km)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">15</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>PriceCaculateController</code>中包含了所有出行方式的计算细节。</p>
<p>细心的同学可以发现，我将<code>PriceCaculateController</code>中的所有计算方法私有化，向外暴露了一个<code>cacluatePrice(int km, int typeMode)</code>方法。</p>
<p>用户在使用时，仅需告诉我们出行距离与出行方式，我们就可以完全自动计算出价格，下面是使用的代码：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> price = PriceCaculateController.cacluatePrice(<span class="number">20</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure></p>
<p>这样我们就实现了页面与计算功能的完美解耦，页面完全不关心计算的细节。</p>
<p>接下来我们在页面上添加基础判断之后，调用<code>PriceCaculateController.cacluatePrice</code>即可。</p>
<p>我们可以来看看具体效果：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/DesignModel/design_strategy_gif_ui.gif" alt="具体效果"></p>
<p>至此，我们的价格计算器已经开发完成了。</p>
<p>很明显，我们的核心代码全在<code>PriceCaculateController</code>中。</p>
<p>随着出行方式的增加、价格计算的优化，<code>PriceCaculateController</code>必定会变得臃肿不堪。</p>
<p>为了将<code>PriceCaculateController</code>功能进行拆分，我们就要使用今天讲到的<strong>策略模式</strong>。</p>
<p>让我们来回顾<strong>策略模式</strong>中的角色：</p>
<p><strong>一个策略抽象以及多个具体策略</strong>。</p>
<p>接下来我们就将价格计算功能进行抽象：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">StrategyCaculate</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据距离计算价格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">float</span> <span class="title">caculatePrice</span>(<span class="params"><span class="keyword">int</span> km</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>策略抽象非常简单。</p>
<p>接下里我们来实现具体策略，有多少种出行方式，就应该有多少种具体策略：<br>公共汽车(Bus):<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusStrategyCaculate</span> <span class="keyword">implements</span> <span class="title">StrategyCaculate</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">caculatePrice</span><span class="params">(<span class="keyword">int</span> km)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>出租车(Tax):<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaxStrategyCaculate</span> <span class="keyword">implements</span> <span class="title">StrategyCaculate</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">caculatePrice</span><span class="params">(<span class="keyword">int</span> km)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">9</span> + (km - <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>地铁(Subway):<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubwayStrategyCaculate</span> <span class="keyword">implements</span> <span class="title">StrategyCaculate</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">caculatePrice</span><span class="params">(<span class="keyword">int</span> km)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (km &lt;= <span class="number">15</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>三种出行方式对应三个具体策略。</p>
<p>当有新的出行方式时，我们只需创建新的类去实现策略抽象即可。</p>
<p>简单写一些测试代码：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">StrategyCaculate caculate = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">switch</span> (typeMode) &#123;</span><br><span class="line">    <span class="keyword">case</span> Constant.<span class="string">TYPE_BUS:</span></span><br><span class="line">        caculate = <span class="keyword">new</span> BusStrategyCaculate();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Constant.<span class="string">TYPE_SUBWAY:</span></span><br><span class="line">        caculate = <span class="keyword">new</span> SubwayStrategyCaculate();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Constant.<span class="string">TYPE_TAX:</span></span><br><span class="line">        caculate = <span class="keyword">new</span> TaxStrategyCaculate();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">assert</span> caculate != <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">return</span> caculate.caculatePrice(km);</span><br></pre></td></tr></table></figure></p>
<p>可以发现，这里我们又运用多态的特性，根据不同的出行方式，创建不同的子类，接着调用子类中的价格计算。</p>
<p>最后的效果和之前的效果是一致的。</p>
<p><a href="https://github.com/YuanTiger/Design-Pattern" target="_blank" rel="noopener">相关代码已经提交至GitHub</a>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>有些人会有疑惑了，我们最开始的<code>PriceCaculateController</code>并不复杂，并且一个方法对应一种出行方式，清晰明了，为什么非要改成这个样子?</p>
<p>对于这个问题，我们现在的出行方式仅仅有三种、并且价格计算的逻辑非常简单。</p>
<p>如果现在继续添加出行方式：飞机、自驾、高铁、大巴等。</p>
<p>如果优化出租车的价格计算逻辑：出租车3Km以内9元，之后每1Km加1元，燃气费2元，堵车服务费每分钟0.1元，夜晚11点之后价格提升，每个城市的价格不同等等。</p>
<p>如果将上述逻辑全部写出，那么就出租车价格计算的逻辑，就要有上百行的代码。</p>
<p>如果你们公司是一家专业的出行价格计算公司，这些计算细节、出行方式都必定要涵盖到。</p>
<p>那么将来，<code>PriceCaculateController</code>的代码量，会有多大？</p>
<p>如果我们运用了<strong>策略模式</strong>，项目的目录结构就变成了：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/DesignModel/design_strategy_rule.png" alt="策略模式目录结构"><br>当某种交通工具的价格计算发生问题，我们仅仅去找对应的具体策略即可。并且避免产生了<code>PriceCaculateController</code>这种代码量庞大的类。</p>
<p><strong>策略模式</strong>很好地遵循了开闭原则，注入不同的具体策略，会有不同的效果，从而达到很好的扩展性。</p>
<p>使用<strong>策略模式</strong>的优点有很多：</p>
<ul>
<li>结构清晰明了，使用简单；</li>
<li>降低耦合度，扩展方便；</li>
<li>封装彻底，数据更为安全。</li>
</ul>
<p>所以，在你能预见到某个功能会有扩展的需求时，并且使用场景符合<strong>策略模式</strong>的使用场景，还是强烈建议你使用<strong>策略模式</strong>的。</p>
<h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><p>《Android源码设计模式解析与实战》 何红辉、关爱民 著</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/02/Design-Abs-Factory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/02/Design-Abs-Factory/" itemprop="url">创建型设计模式-抽象工厂模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-02T13:52:48+08:00">
                2017-08-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="模式介绍"><a href="#模式介绍" class="headerlink" title="模式介绍"></a>模式介绍</h2><p>前段时间介绍了<a href="http://www.jianshu.com/p/cf3b3335af4b" target="_blank" rel="noopener">工厂方法模式</a>。<br>本次介绍的模式非常容易和<a href="http://www.jianshu.com/p/cf3b3335af4b" target="_blank" rel="noopener">工厂方法模式</a>混淆，并且复杂度也有一定的提升，叫做<strong>抽象工厂模式</strong>。<br>其实在现实生活中，工厂都会生产某一样具体的产品，不存在说抽象的工厂。<br>那么该模式的含义到底是什么呢？<br><strong>抽象工厂模式</strong>的出现最早是为了解决不同操作系统下的图形化处理，这就好比iOS中的Button、Android中的Button、WindowPhone中的Button一样，虽然都是Button，但系统的不同，会导致Button也存在差异。<br>这就引出了<strong>抽象工厂模式</strong>的定义：<br>为创建出<strong>一组相互依赖</strong>的对象提供一个封装接口。<br>定义中有几个关键字，需要注意：</p>
<ul>
<li>一组：这是和<a href="http://www.jianshu.com/p/cf3b3335af4b" target="_blank" rel="noopener">工厂方法模式</a>的重要区别所在，<strong>抽象工厂模式</strong>用于生产多个产品，而不是一个。如果生产一个产品，请使用<a href="http://www.jianshu.com/p/cf3b3335af4b" target="_blank" rel="noopener">工厂方法模式</a>或<a href="http://www.jianshu.com/p/07bed15cd13c" target="_blank" rel="noopener">建造者模式</a>。</li>
<li>相互依赖：生产出一组产品之后，这组产品<strong>一定</strong>是相互依赖的，注意是<strong>一定</strong>。就好比上面的例子中，Android系统能使用iOS系统的Button吗？答案是否定的，因为iOS的Button依赖于iOS系统。</li>
</ul>
<p>解释完名词，想必大家对<strong>抽象工厂模式</strong>的使用场景就有了一些认知：<br>当产品很多，并且有特定的关联可以进行抽象，就可以使用<strong>抽象工厂模式</strong>。</p>
<h2 id="模式构成"><a href="#模式构成" class="headerlink" title="模式构成"></a>模式构成</h2><p><strong>抽象工厂模式</strong>的主要角色还是4个：</p>
<ul>
<li>AbstractFactory：抽象工厂，包含一组产品的生产抽象，<strong>每一个方法都应对应一个产品</strong>。</li>
<li>ConcreteFactory：抽象工厂实现，应包含生产一组产品的具体实现。</li>
<li>AbstractProduct：一组产品中的一个产品抽象。</li>
<li>ConcreteProduct：具体的产品实现。</li>
</ul>
<h2 id="模式示例"><a href="#模式示例" class="headerlink" title="模式示例"></a>模式示例</h2><p>现在我们开始实现在上述介绍中提到的例子。<br>我们先来将思路捋一捋：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/DesignModel/design_abs_factory_0.png" alt="对应关系"></p>
<ol>
<li>我们产品包含：操作系统、Button。</li>
<li>工厂应该生产一组产品，即生产操作系统和Button。</li>
<li>生产出来的一组产品应相互依赖，并且和另一组产品相互独立。</li>
</ol>
<p>接下来，我们就按照思路来实现<strong>抽象工厂模式</strong>。<br>首先我们来初始化抽象产品<strong>AbstractProduct</strong>：<br>操作系统System：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">SystemAbsProduct</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取系统型号</span></span><br><span class="line">    <span class="function">String <span class="title">getSystem</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Button：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ButtonAbsProduct</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//按钮响应</span></span><br><span class="line">    <span class="function">String <span class="title">getButtonName</span>(<span class="params">SystemAbsProduct system</span>)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可以发现，Button与操作系统存在依赖关系，这种依赖关系的体现由开发人员自己来控制，我这里只是个简单实例。<br>两个产品的抽象已经有了，我们先不急着去实现它们。<br>接下来我们来定义抽象工厂AbstractFactory，它应该有两个方法，分别返回系统和Button两个产品：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">AbsFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建操作系统</span></span><br><span class="line">    <span class="function">SystemAbsProduct <span class="title">createSystem</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建Button</span></span><br><span class="line">    <span class="function">ButtonAbsProduct <span class="title">createButton</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到这里应该都没有什么问题，抽象工厂、抽象产品都已经创建完成了。<br>接下来我们想要分别构建出WindowPhone系统、Android系统、iOS系统下的Button。<br>我们应该能想到，必须要先要有具体的产品，才能用具体工厂来生产。<br>所以接下来，我们要先创建具体的产品：<br>操作系统<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SystemAbsProduct</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取系统型号</span></span><br><span class="line">    <span class="function">String <span class="title">getSystem</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowPhone</span> <span class="keyword">implements</span> <span class="title">SystemAbsProduct</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getSystem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> App.context.getString(R.string.window_phone);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">iOS</span> <span class="keyword">implements</span> <span class="title">SystemAbsProduct</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getSystem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> App.context.getString(R.string.ios);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Android</span> <span class="keyword">implements</span> <span class="title">SystemAbsProduct</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getSystem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> App.context.getString(R.string.android);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Button：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ButtonAbsProduct</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//按钮响应</span></span><br><span class="line">    <span class="function">String <span class="title">getButtonName</span>(<span class="params">SystemAbsProduct system</span>)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WindowPhoneButton</span> <span class="title">implements</span> <span class="title">ButtonAbsProduct</span> &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getButtonName</span>(<span class="params">SystemAbsProduct system</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (system.getSystem().<span class="keyword">equals</span>(App.context.getString(R.<span class="keyword">string</span>.window_phone))) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"点击了WindowPhone系统的Button"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> App.context.getString(R.<span class="keyword">string</span>.system_error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IOSButton</span> <span class="title">implements</span> <span class="title">ButtonAbsProduct</span> &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getButtonName</span>(<span class="params">SystemAbsProduct system</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (system.getSystem().<span class="keyword">equals</span>(App.context.getString(R.<span class="keyword">string</span>.ios))) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"点击了iOS系统的Button"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> App.context.getString(R.<span class="keyword">string</span>.system_error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AndroidButton</span> <span class="title">implements</span> <span class="title">ButtonAbsProduct</span> &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getButtonName</span>(<span class="params">SystemAbsProduct system</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (system.getSystem().<span class="keyword">equals</span>(App.context.getString(R.<span class="keyword">string</span>.android))) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"点击了Android系统的Button"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> App.context.getString(R.<span class="keyword">string</span>.system_error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为类的数量庞大，所以我选择使用内部类的形式来实现ConcreteProduct角色。<br>我们可以发现，在Button角色中，我们进行了简单的判断，当操作系统不匹配时，会提示用户，这就类似于运行崩溃的效果。<br>接下来，我们来创建最后一个角色：ConcreteFactory。<br>它应该有多个，每一个负责创建一组具体的产品，也就是说有多少组产品，就应该有多少个具体工厂：<br>WindowPhoneFactory：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WindowPhoneFactory</span> <span class="keyword">implements</span> <span class="title">AbsFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SystemAbsProduct <span class="title">createSystem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SystemAbsProduct.WindowPhone();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ButtonAbsProduct <span class="title">createButton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ButtonAbsProduct.WindowPhoneButton();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>IOSFactory：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IOSFactory</span> <span class="keyword">implements</span> <span class="title">AbsFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SystemAbsProduct <span class="title">createSystem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SystemAbsProduct.IOS();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ButtonAbsProduct <span class="title">createButton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ButtonAbsProduct.IOSButton();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AndroidFactory：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AndroidFactory</span> <span class="keyword">implements</span> <span class="title">AbsFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SystemAbsProduct <span class="title">createSystem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SystemAbsProduct.Android();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ButtonAbsProduct <span class="title">createButton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ButtonAbsProduct.AndroidButton();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>三个具体工厂分别具体产生三组相互依赖的产品。<br>至此，简单的<strong>抽象工厂模式</strong>已经构建完成。<br>但是最关键的还是使用，接下来我们来写一些简单的测试代码：<br><figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构建WindowPhone具体工厂</span></span><br><span class="line"><span class="type">AbsFactory</span> iOSFactory = <span class="function"><span class="keyword">new</span> <span class="title">IOSFactory</span>();</span></span><br><span class="line"><span class="function"><span class="comment">//构建操作系统</span></span></span><br><span class="line"><span class="function"><span class="title">SystemAbsProduct</span> <span class="title">iOSSystem</span> = <span class="title">iOSFactory</span>.<span class="title">createSystem</span>();</span></span><br><span class="line"><span class="function"><span class="comment">//构建按钮</span></span></span><br><span class="line"><span class="function"><span class="title">ButtonAbsProduct</span> <span class="title">iOSButton</span> = <span class="title">iOSFactory</span>.<span class="title">createButton</span>();</span></span><br><span class="line"><span class="function"><span class="comment">//调用依赖</span></span></span><br><span class="line"><span class="function"><span class="title">Toast</span>.<span class="title">makeText</span>(this, iOSButton.getButtonName(iOSSystem), <span class="title">Toast</span>.<span class="title">LENGTH_SHORT</span>).<span class="title">show</span>();</span></span><br></pre></td></tr></table></figure></p>
<p>创建iOS系统工厂，接着创建iOS系统和Button，最后调用Button的点击，会发现成功提示出调用成功。<br>如果我们使用错误的依赖：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">AbsFactory</span> <span class="keyword">androidFactory1 </span>= new <span class="keyword">AndroidFactory();</span></span><br><span class="line"><span class="keyword">SystemAbsProduct </span><span class="keyword">androidSystem1 </span>= <span class="keyword">androidFactory1.createSystem();</span></span><br><span class="line"><span class="keyword">ButtonAbsProduct </span><span class="keyword">androidButton1 </span>= <span class="keyword">androidFactory1.createButton();</span></span><br><span class="line"><span class="keyword">AbsFactory </span>iOSFactory1 = new IOSFactory()<span class="comment">;</span></span><br><span class="line"><span class="symbol">SystemAbsProduct</span> iOSSystem1 = iOSFactory1.createSystem()<span class="comment">;</span></span><br><span class="line"><span class="keyword">ButtonAbsProduct </span>iOSButton1 = iOSFactory1.createButton()<span class="comment">;</span></span><br><span class="line">//使用<span class="keyword">Android的Button时，传入iOS操作系统</span></span><br><span class="line"><span class="keyword">Toast.makeText(this, </span><span class="keyword">androidButton1.getButtonName(iOSSystem1), </span>Toast.LENGTH_SHORT).show()<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>上述演示代码，会提示系统不匹配。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>抽象工厂模式</strong>的最大优势就是分离了接口与实现，客户端使用工厂来创建所需对象，实现面向产品的接口编程，使其在切换产品类时更加灵活、容易。<br>当然缺点也非常明显，一是类文件的增加，二是不太容易扩展产品类，因为每添加一个新产品，都要修改工厂，随之所有工厂实现都要修改。<br><strong>抽象工厂模式</strong>与<a href="http://www.jianshu.com/p/cf3b3335af4b" target="_blank" rel="noopener">工厂方法模式</a>的区别也很明显：<br><strong>抽象工厂模式</strong>用来生产一组相互依赖的产品。<br><a href="http://www.jianshu.com/p/cf3b3335af4b" target="_blank" rel="noopener">工厂方法模式</a>用来批量生产一种产品。<br><a href="https://github.com/YuanTiger/Design-Pattern" target="_blank" rel="noopener">抽象工厂模式的相关代码已经上传至GitHub</a>，需要的同学可以下载参考。</p>
<h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><p><a href="https://www.zhihu.com/question/20367734/answer/82361745?from=singlemessage&amp;isappinstalled=0" target="_blank" rel="noopener">抽象工厂模式和工厂模式的区别-caoglish的回答</a></p>
<p>《Android源码设计模式解析与实战》 何红辉、关爱民 著</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/27/Android-Photo-Select/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/27/Android-Photo-Select/" itemprop="url">Android获取图片的正确姿势</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-27T15:55:01+08:00">
                2017-07-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>很多项目中都会有用户修改头像或者类似的功能。<br>该功能会访问用户的相册、相机来获取图片，然后显示到页面上。<br>实现该功能还是比较简单的，网上的资料也非常多，简单查阅之后复制粘贴便能实现，但是很多细节其实并不理解。<br>并且由于Android安全性的提升，包括Android6.0（API 23）的权限系统升级、Android7.0（API 24）的私有文件访问限制，很多地方稍不注意就会发生崩溃。<br>最近再次用到了这个功能，这次打算用一篇文章来详细记录这个功能点所对应的知识点，并解决掉之前的很多疑问。</p>
<h2 id="打开相册"><a href="#打开相册" class="headerlink" title="打开相册"></a>打开相册</h2><p>打开手机相册的方式有多种：<br>第一种：<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Intent</span> <span class="keyword">intent</span> = new <span class="keyword">Intent</span>();</span><br><span class="line"><span class="keyword">intent</span>.setAction(<span class="keyword">Intent</span>.ACTION_PICK);</span><br><span class="line">// 设置文件类型</span><br><span class="line"><span class="keyword">intent</span>.setType(<span class="string">"image/*"</span>);</span><br><span class="line">activity.startActivityForResult(<span class="keyword">intent</span>, requestCode);</span><br></pre></td></tr></table></figure></p>
<p>第二种：<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Intent</span> <span class="keyword">intent</span> = new <span class="keyword">Intent</span>();</span><br><span class="line"><span class="keyword">intent</span>.setAction(<span class="keyword">Intent</span>.ACTION_GET_CONTENT);</span><br><span class="line">// 设置文件类型</span><br><span class="line"><span class="keyword">intent</span>.setType(<span class="string">"image/*"</span>);</span><br><span class="line">activity.startActivityForResult(<span class="keyword">intent</span>, requestCode);</span><br></pre></td></tr></table></figure></p>
<p>第三种：<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Intent</span> <span class="keyword">intent</span> = new <span class="keyword">Intent</span>();</span><br><span class="line"><span class="keyword">intent</span>.setAction(<span class="keyword">Intent</span>.ACTION_OPEN_DOCUMENT);</span><br><span class="line">// 设置文件类型</span><br><span class="line"><span class="keyword">intent</span>.setType(<span class="string">"image/*"</span>);</span><br><span class="line">activity.startActivityForResult(<span class="keyword">intent</span>, requestCode);</span><br></pre></td></tr></table></figure></p>
<p>这几种方式都可以在获取到读取文件权限的前提下，完美实现图片选择。<br>第三种<a href="https://developer.android.google.cn/reference/android/content/Intent.html#ACTION_OPEN_DOCUMENT" target="_blank" rel="noopener">ACTION_OPEN_DOCUMENT</a>是在Android5.0(API 19)之后新添加的意图，如果使用的话需要进行<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">if</span><span class="params">(Build.VERSION.SDK_INT&gt;=Build.VERSION_CODES.KITKAT)</span></span>&#123;</span><br><span class="line">	<span class="comment">//TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们这里先不介绍<a href="https://developer.android.google.cn/reference/android/content/Intent.html#ACTION_OPEN_DOCUMENT" target="_blank" rel="noopener">ACTION_OPEN_DOCUMENT</a>。<br>第二种<a href="https://developer.android.google.cn/reference/android/content/Intent.html#ACTION_GET_CONTENT" target="_blank" rel="noopener">ACTION_GET_CONTENT</a>与第一种<a href="https://developer.android.google.cn/reference/android/content/Intent.html#ACTION_PICK" target="_blank" rel="noopener">ACTION_PICK</a>这两个意图类型的作用也非常类似，都是用来获取手机内容，包括联系人、相册等。<br>通过<code>intent.setType(&quot;image/*&quot;)</code>来指定<strong>MIME Type</strong>，让系统知道要打开的应用。<br>这里需要注意，必须指定<strong>MIME Type</strong>，否则项目会崩溃：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android<span class="selector-class">.content</span><span class="selector-class">.ActivityNotFoundException</span>: No Activity found to handle Intent &#123; act=android<span class="selector-class">.intent</span><span class="selector-class">.action</span><span class="selector-class">.GET_CONTENT</span> &#125;</span><br><span class="line">android<span class="selector-class">.content</span><span class="selector-class">.ActivityNotFoundException</span>: No Activity found to handle Intent &#123; act=android<span class="selector-class">.intent</span><span class="selector-class">.action</span><span class="selector-class">.ACTION_PICK</span> &#125;</span><br></pre></td></tr></table></figure></p>
<p>根据不同的<strong>MIME Type</strong>，可以跳转到不同的应用。<br>那么这两者有什么区别呢？<br><a href="https://developer.android.google.cn/reference/android/content/Intent.html#ACTION_GET_CONTENT" target="_blank" rel="noopener">ACTION_GET_CONTENT</a>与<a href="https://developer.android.google.cn/reference/android/content/Intent.html#ACTION_PICK" target="_blank" rel="noopener">ACTION_PICK</a>的官方解释在这里。<br>英语比较差，跟着百度翻译看了半天还是不懂。<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/gaoxiao/%E6%83%A8%E4%B8%8D%E5%BF%8D%E7%9D%B9.png" alt=""><br>英语好的同学可自行食用上面的链接，应该不需要翻墙。<br>两者的区别介绍都写在了<a href="https://developer.android.google.cn/reference/android/content/Intent.html#ACTION_GET_CONTENT" target="_blank" rel="noopener">ACTION_GET_CONTENT</a>，大概是在说：<br>如果你有一些特定的集合（由URI标识）想让用户选择，使用<a href="https://developer.android.google.cn/reference/android/content/Intent.html#ACTION_PICK" target="_blank" rel="noopener">ACTION_PICK</a>。<br>如果让用户基于<strong>MIME Type</strong>选择数据，使用<a href="https://developer.android.google.cn/reference/android/content/Intent.html#ACTION_GET_CONTENT" target="_blank" rel="noopener">ACTION_GET_CONTENT</a>。<br>在平局的情况下，建议使用<a href="https://developer.android.google.cn/reference/android/content/Intent.html#ACTION_GET_CONTENT" target="_blank" rel="noopener">ACTION_GET_CONTENT</a>。<br>这个还是需要各位看官自己好好理解，我也没能完全了解两者的使用区别。<br>并且我发现两者返回的Uri格式是不同的：<br><a href="http://www.jianshu.com/p/5572b42fc63f" target="_blank" rel="noopener">关于Android中Uri的介绍，可以参考这篇文章</a>。</p>
<p>两种意图分别唤起相册后，选择同一张图片的回调，也就是在onActivityResult中接收：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> onActivityResult(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data) &#123;</span><br><span class="line">    <span class="keyword">super</span>.onActivityResult(requestCode, resultCode, data);</span><br><span class="line">    <span class="keyword">if</span> (resultCode != RESULT_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (requestCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">REQUEST_CODE_ALBUM:</span><span class="comment">//相册</span></span><br><span class="line">            Uri dataUri = data.getData();</span><br><span class="line">            Log.i(<span class="string">"mengyuanuri"</span>,<span class="string">"uri:"</span>+dataUri.getScheme()+<span class="string">":"</span>+dataUri.getSchemeSpecificPart());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来我们来看看两个意图类型下选择同一张照片返回的数据：<br><a href="https://developer.android.google.cn/reference/android/content/Intent.html#ACTION_GET_CONTENT" target="_blank" rel="noopener">ACTION_GET_CONTENT</a>：<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">content:</span>//<span class="keyword">com</span>.android.providers.media.documents/document/image:<span class="number">2116</span></span><br></pre></td></tr></table></figure></p>
<p><a href="https://developer.android.google.cn/reference/android/content/Intent.html#ACTION_PICK" target="_blank" rel="noopener">ACTION_PICK</a>：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content:<span class="regexp">//m</span>edia<span class="regexp">/external/im</span>ages<span class="regexp">/media/</span><span class="number">2116</span></span><br></pre></td></tr></table></figure></p>
<p>没有其他的东西，两者都是返回一个Uri。<br>为什么不直接返回给我们图片，而是一个Uri呢？<br><a href="http://blog.csdn.net/wingichoy/article/details/50679322" target="_blank" rel="noopener">因为Intent传输有大小的限制。</a><br>所以我们需要根据Uri来获取到文件的具体路径。<br>但是我们发现，就算是同一张照片，两种意图下，返回的Uri也是不一致的。<br>这主要是因为Uri在Android中的类型也分为很多种，比如这两个意图的Uri种类就不一致。<br>这里就不做赘述了，我们可以通过网上大神封装的解析Uri的方法将它们统一转化成File路径：<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> getPath( <span class="keyword">final</span> Uri uri) &#123;</span><br><span class="line">        <span class="comment">// DocumentProvider</span></span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT &amp;&amp; DocumentsContract.isDocumentUri(App.context, uri)) &#123;</span><br><span class="line">            <span class="comment">// ExternalStorageProvider</span></span><br><span class="line">            <span class="keyword">if</span> (isExternalStorageDocument(uri)) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">String</span> docId = DocumentsContract.getDocumentId(uri);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">String</span>[] <span class="built_in">split</span> = docId.<span class="built_in">split</span>(<span class="string">":"</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">String</span> type = <span class="built_in">split</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"primary"</span>.equalsIgnoreCase(type)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> Environment.getExternalStorageDirectory() + <span class="string">"/"</span> + <span class="built_in">split</span>[<span class="number">1</span>];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// TODO handle non-primary volumes</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// DownloadsProvider</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (isDownloadsDocument(uri)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">String</span> id = DocumentsContract.getDocumentId(uri);</span><br><span class="line">                <span class="keyword">final</span> Uri contentUri = ContentUris.withAppendedId(</span><br><span class="line">                        Uri.parse(<span class="string">"content://downloads/public_downloads"</span>), Long.valueOf(id));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> getDataColumn(App.context, contentUri, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// MediaProvider</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (isMediaDocument(uri)) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">String</span> docId = DocumentsContract.getDocumentId(uri);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">String</span>[] <span class="built_in">split</span> = docId.<span class="built_in">split</span>(<span class="string">":"</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">String</span> type = <span class="built_in">split</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">                Uri contentUri = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"image"</span>.equals(type)) &#123;</span><br><span class="line">                    contentUri = MediaStore.Images.Media.EXTERNAL_CONTENT_URI;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"video"</span>.equals(type)) &#123;</span><br><span class="line">                    contentUri = MediaStore.Video.Media.EXTERNAL_CONTENT_URI;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"audio"</span>.equals(type)) &#123;</span><br><span class="line">                    contentUri = MediaStore.Audio.Media.EXTERNAL_CONTENT_URI;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">String</span> selection = <span class="string">"_id=?"</span>;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">String</span>[] selectionArgs = <span class="keyword">new</span> <span class="keyword">String</span>[]&#123;</span><br><span class="line">                        <span class="built_in">split</span>[<span class="number">1</span>]</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> getDataColumn(App.context, contentUri, selection, selectionArgs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// MediaStore (and general)</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"content"</span>.equalsIgnoreCase(uri.getScheme())) &#123;</span><br><span class="line">            <span class="keyword">return</span> getDataColumn(App.context, uri, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// File</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"file"</span>.equalsIgnoreCase(uri.getScheme())) &#123;</span><br><span class="line">            <span class="keyword">return</span> uri.getPath();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>调用完成后，会发现不同的Uri对应的是同一个文件路径：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/storage/</span>emulated<span class="regexp">/0/</span>temp<span class="regexp">/kouliang_avatar.jpg</span></span><br></pre></td></tr></table></figure></p>
<p>断点跟进该方法，会发现两个Uri走的是不同的if判断。</p>
<p>简单来说，三种方法都可以使用，并且三种方法都是在onActivityResult中返回Uri，而不是图片。<br>一般情况使用<a href="https://developer.android.google.cn/reference/android/content/Intent.html#ACTION_GET_CONTENT" target="_blank" rel="noopener">ACTION_GET_CONTENT</a>的会多一些。</p>
<h2 id="相机"><a href="#相机" class="headerlink" title="相机"></a>相机</h2><p>打开相机的方式：<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//指定相机意图</span><br><span class="line"><span class="keyword">Intent</span> <span class="keyword">intent</span> = new <span class="keyword">Intent</span>(MediaStore.ACTION_IMAGE_CAPTURE);</span><br><span class="line">//设置相片保存的地址</span><br><span class="line"><span class="keyword">intent</span>.putExtra(MediaStore.EXTRA_OUTPUT, Uri.fromFile(<span class="keyword">file</span>));</span><br><span class="line">activity.startActivityForResult(<span class="keyword">intent</span>, requestCode);</span><br></pre></td></tr></table></figure></p>
<p>相机图片的获取方式不同于相册，相机图片获取需要先指定图片的保存路径，在拍摄成功后，我们只需直接去指定路径获取即可:<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch </span>(requestCode) &#123;</span><br><span class="line">    //相册</span><br><span class="line">    case REQUEST_CODE_ALBUM:</span><br><span class="line">        Uri dataUri = <span class="meta">data</span>.getData()<span class="comment">;</span></span><br><span class="line">        Log.i(<span class="string">"mengyuanuri"</span>, <span class="string">"相册uri:"</span> + dataUri.getScheme() + <span class="string">":"</span> + dataUri.getSchemeSpecificPart())<span class="comment">;</span></span><br><span class="line">        <span class="keyword">break;</span></span><br><span class="line"><span class="keyword"> </span>   //相机，注意，相机的回调中Intent为空，不要使用</span><br><span class="line">    case REQUEST_CODE_CAMER:</span><br><span class="line">        File <span class="keyword">bgPath </span>= Constant.<span class="keyword">bgPath;</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">Bitmap </span><span class="keyword">bitmap </span>= <span class="keyword">BitmapFactory.decodeFile(bgPath.getPath());</span></span><br><span class="line"><span class="keyword"> </span>       iv_bg.setImageBitmap(<span class="keyword">bitmap);</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">break;</span></span><br><span class="line"><span class="keyword">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>非常简单，在相机回调中去指定路径中读取图片并显示。<br>但是我们应该可以想到，<strong>有些手机没有相机</strong>，也就是没有<a href="https://developer.android.google.cn/reference/android/provider/MediaStore.html#ACTION_IMAGE_CAPTURE" target="_blank" rel="noopener">MediaStore.ACTION_IMAGE_CAPTURE</a>意图对应的应用。<br>如果没有对其进行判断就会抛出<a href="https://developer.android.google.cn/reference/android/content/ActivityNotFoundException.html" target="_blank" rel="noopener">ActivityNotFound</a>的异常。<br>如何解决这个问题：</p>
<ol>
<li>try-catch，简单粗暴；</li>
<li>通过PackageManager去查询<a href="https://developer.android.google.cn/reference/android/provider/MediaStore.html#ACTION_IMAGE_CAPTURE" target="_blank" rel="noopener">MediaStore.ACTION_IMAGE_CAPTURE</a>意图是否存在。</li>
</ol>
<p>两种做法都很简单，这里展示如何用PackageManager：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断某个意图是否存在</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> static <span class="built_in">boolean</span> isHaveCame(<span class="built_in">String</span> intentName) &#123;</span><br><span class="line">    PackageManager packageManager = App.context.getPackageManager();</span><br><span class="line">    Intent intent = <span class="literal">new</span> Intent(intentName);</span><br><span class="line">    <span class="built_in">List</span>&lt;ResolveInfo&gt; <span class="built_in">list</span> = packageManager.queryIntentActivities(intent, PackageManager.MATCH_DEFAULT_ONLY);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">list</span>.size() &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着我们运行，十分成功。<br>但是在7.1的虚拟机中，打开相机崩溃了：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">android<span class="selector-class">.os</span><span class="selector-class">.FileUriExposedException</span>: file:<span class="comment">///storage/emulated/0/photo_bg.jpg exposed beyond app through ClipData.Item.getUri(</span></span><br><span class="line">    at android<span class="selector-class">.os</span><span class="selector-class">.StrictMode</span><span class="selector-class">.onFileUriExposed</span>(StrictMode<span class="selector-class">.java</span>:<span class="number">1799</span>)</span><br><span class="line">    at android<span class="selector-class">.net</span><span class="selector-class">.Uri</span><span class="selector-class">.checkFileUriExposed</span>(Uri<span class="selector-class">.java</span>:<span class="number">2346</span>)</span><br><span class="line">    at android<span class="selector-class">.content</span><span class="selector-class">.ClipData</span><span class="selector-class">.prepareToLeaveProcess</span>(ClipData<span class="selector-class">.java</span>:<span class="number">845</span>)</span><br><span class="line">    at android<span class="selector-class">.content</span><span class="selector-class">.Intent</span><span class="selector-class">.prepareToLeaveProcess</span>(Intent<span class="selector-class">.java</span>:<span class="number">8941</span>)</span><br><span class="line">    at android<span class="selector-class">.content</span><span class="selector-class">.Intent</span><span class="selector-class">.prepareToLeaveProcess</span>(Intent<span class="selector-class">.java</span>:<span class="number">8926</span>)</span><br><span class="line">    at android<span class="selector-class">.app</span><span class="selector-class">.Instrumentation</span><span class="selector-class">.execStartActivity</span>(Instrumentation<span class="selector-class">.java</span>:<span class="number">1517</span>)</span><br><span class="line">    at android<span class="selector-class">.app</span><span class="selector-class">.Activity</span><span class="selector-class">.startActivityForResult</span>(Activity<span class="selector-class">.java</span>:<span class="number">4225</span>)</span><br><span class="line">    at android<span class="selector-class">.support</span><span class="selector-class">.v4</span><span class="selector-class">.app</span><span class="selector-class">.BaseFragmentActivityJB</span><span class="selector-class">.startActivityForResult</span>(BaseFragmentActivityJB<span class="selector-class">.java</span>:<span class="number">54</span>)</span><br><span class="line">    at android<span class="selector-class">.support</span><span class="selector-class">.v4</span><span class="selector-class">.app</span><span class="selector-class">.FragmentActivity</span><span class="selector-class">.startActivityForResult</span>(FragmentActivity<span class="selector-class">.java</span>:<span class="number">75</span>)</span><br><span class="line">    at android<span class="selector-class">.app</span><span class="selector-class">.Activity</span><span class="selector-class">.startActivityForResult</span>(Activity<span class="selector-class">.java</span>:<span class="number">4183</span>)</span><br><span class="line">    at android<span class="selector-class">.support</span><span class="selector-class">.v4</span><span class="selector-class">.app</span><span class="selector-class">.FragmentActivity</span><span class="selector-class">.startActivityForResult</span>(FragmentActivity<span class="selector-class">.java</span>:<span class="number">708</span>)</span><br><span class="line">    at com<span class="selector-class">.my</span><span class="selector-class">.photoget</span><span class="selector-class">.utils</span><span class="selector-class">.AppUtils</span><span class="selector-class">.startCamer</span>(AppUtils<span class="selector-class">.java</span>:<span class="number">37</span>)</span><br></pre></td></tr></table></figure></p>
<p>崩溃的主要原因是因为在7.0(API 24)中对文件读取进行了安全性的提升，<a href="http://www.jianshu.com/p/3f9e3fc38eae" target="_blank" rel="noopener">这篇文章详细介绍了解决方案</a>。<br>这里提一下，这和当初Android6.0(API 23)权限管理改版一致，如果<strong>build.gradle</strong>中的<code>targetSdkVersion</code>&lt;23，则会沿用以前的权限管理机制，无需进行权限管理改版，<a href="http://www.jianshu.com/p/9271efd71450" target="_blank" rel="noopener">权限管理详见这篇小文</a>。<br>同理，这里如果你的<code>targetSdkVersion</code>&lt;24的话，则无需进行上述崩溃的适配。<br>但是更新一定是往更好的方向去的，还是建议各位看官及时更新，及时适配，保证<code>targetSdkVersion</code>为最新SDK。</p>
<h2 id="裁剪"><a href="#裁剪" class="headerlink" title="裁剪"></a>裁剪</h2><p>裁剪功能是可选功能，如果想要对获取到的图片进行裁剪，我们可以继续使用裁剪Intent来对图片进行裁剪：<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent(<span class="string">"com.android.camera.action.CROP"</span>);</span><br><span class="line"><span class="comment">//设置要裁剪的图片Uri</span></span><br><span class="line">intent.setDataAndType(cropBean.dataUri, <span class="string">"image/*"</span>);</span><br><span class="line"><span class="comment">//配置一系列裁剪参数</span></span><br><span class="line">intent.putExtra(<span class="string">"outputX"</span>, cropBean.outputX);</span><br><span class="line">intent.putExtra(<span class="string">"outputY"</span>, cropBean.outputY);</span><br><span class="line">intent.putExtra(<span class="string">"scale"</span>, cropBean.<span class="built_in">scale</span>);</span><br><span class="line">intent.putExtra(<span class="string">"aspectX"</span>, cropBean.aspectX);</span><br><span class="line">intent.putExtra(<span class="string">"aspectY"</span>, cropBean.aspectY);</span><br><span class="line">intent.putExtra(<span class="string">"outputFormat"</span>, cropBean.outputFormat);</span><br><span class="line">intent.putExtra(<span class="string">"return-data"</span>, cropBean.isReturnData);</span><br><span class="line">intent.putExtra(<span class="string">"output"</span>, cropBean.saveUri);</span><br><span class="line"><span class="comment">//跳转</span></span><br><span class="line">activity.startActivityForResult(intent, requestCode);</span><br></pre></td></tr></table></figure></p>
<p>裁剪参数的含义可以参考<a href="https://github.com/showdy/Android_Note/blob/master/showdy_note/android/strategy/%E4%BD%BF%E7%94%A8%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%86%8C%E5%9B%BE%E7%89%87%E6%88%96%E6%8B%8D%E7%85%A7%E5%B9%B6%E8%A3%81%E5%89%AA%E4%B9%8BAndroid_N%E9%80%82%E9%85%8D.md" target="_blank" rel="noopener">这篇文章</a>：</p>
<table>
<thead>
<tr>
<th style="text-align:left">附加选项</th>
<th style="text-align:center">数据类型</th>
<th style="text-align:right">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">crop</td>
<td style="text-align:center">String</td>
<td style="text-align:right">发送裁剪信号</td>
</tr>
<tr>
<td style="text-align:left">aspectX</td>
<td style="text-align:center">int</td>
<td style="text-align:right">X方向上的比例</td>
</tr>
<tr>
<td style="text-align:left">aspectY</td>
<td style="text-align:center">int</td>
<td style="text-align:right">Y方向上的比例</td>
</tr>
<tr>
<td style="text-align:left">outputX</td>
<td style="text-align:center">int</td>
<td style="text-align:right">裁剪区的宽</td>
</tr>
<tr>
<td style="text-align:left">outputY</td>
<td style="text-align:center">int</td>
<td style="text-align:right">裁剪区的高</td>
</tr>
<tr>
<td style="text-align:left">scale</td>
<td style="text-align:center">boolean</td>
<td style="text-align:right">是否保留比例</td>
</tr>
<tr>
<td style="text-align:left">return-data</td>
<td style="text-align:center">boolean</td>
<td style="text-align:right">是否将数据保留在Bitmap中返回</td>
</tr>
<tr>
<td style="text-align:left">data</td>
<td style="text-align:center">Parcelable</td>
<td style="text-align:right">相应的Bitmap数据</td>
</tr>
<tr>
<td style="text-align:left">circleCrop</td>
<td style="text-align:center">String</td>
<td style="text-align:right">圆形裁剪区域</td>
</tr>
<tr>
<td style="text-align:left">output</td>
<td style="text-align:center">URI</td>
<td style="text-align:right">将URI指向相应的file://</td>
</tr>
<tr>
<td style="text-align:left">outputFormat</td>
<td style="text-align:center">String</td>
<td style="text-align:right">图片输出格式</td>
</tr>
<tr>
<td style="text-align:left">noFaceDetection</td>
<td style="text-align:center">boolean</td>
<td style="text-align:right">是否取消人脸识别</td>
</tr>
</tbody>
</table>
<p>每个属性的解释都很清晰，这里我将裁剪参数封装为了一个Bean对象：<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class CropBean &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//要裁剪的图片Uri</span></span><br><span class="line">    <span class="keyword">public</span> Uri dataUri;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//裁剪宽度</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> outputX;</span><br><span class="line">    <span class="comment">//裁剪高度</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> outputY;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//X方向上的比例</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> aspectX;</span><br><span class="line">    <span class="comment">//Y方向上的比例</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> aspectY;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//是否保留比例</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> <span class="built_in">scale</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//是否将数据保存在Bitmap中返回</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> isReturnData;</span><br><span class="line">    <span class="comment">//相应的Bitmap数据</span></span><br><span class="line">    <span class="keyword">public</span> Parcelable returnData;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果不需要将图片在Bitmap中返回，需要传递保存图片的Uri</span></span><br><span class="line">    <span class="keyword">public</span> Uri saveUri;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//圆形裁剪区域</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">String</span> circleCrop;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//图片输出格式，默认JPEG</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">String</span> outputFormat = Bitmap.CompressFormat.JPEG.toString();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//是否取消人脸识别</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> noFaceDetection;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据宽高计算裁剪比例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> caculateAspect() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">scale</span> = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (outputX == outputY) &#123;</span><br><span class="line">            aspectX = <span class="number">1</span>;</span><br><span class="line">            aspectY = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">float</span> proportion = (<span class="built_in">float</span>) outputX / (<span class="built_in">float</span>) outputY;</span><br><span class="line"></span><br><span class="line">        aspectX = (<span class="built_in">int</span>) (proportion * <span class="number">100</span>);</span><br><span class="line">        aspectY = <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关于封装对象中<code>caculateAspect()</code>方法，因为<strong>aspectX</strong>与<strong>aspectY</strong>是用来设定裁剪框宽高比例的，所以我选择在指定完<strong>outputX</strong>与<strong>outputY</strong>（也就是裁剪图片的宽度和高度）之后，直接根据宽高来计算裁剪框的大小。<br><code>caculateAspect()</code>中就是具体的计算过程。<br>还有几个比较重要的参数需要提一下：</p>
<ul>
<li><strong>intent.setData(Uri uri)</strong>是必须指定的，它代表着要裁剪的图片的Uri。</li>
<li><strong>return-data</strong>参数代表是否要返回数据，如果为true，则返回Bitmap对象，如果为false，则会将图片直接保存到另一个参数<strong>output</strong>中。也就是说，当<strong>return-data</strong>为true时，<strong>output</strong>是没有用的，直接在<strong>onActivityResult</strong>中取data当中的Bitmap即可。如果为false，则直接在onActivityResult中去之前指定到<strong>output</strong>中的地址取出图片即可。</li>
<li>综上一点，强烈建议设置<strong>return-data</strong>为false并且设置<strong>output</strong>，<a href="http://blog.csdn.net/wingichoy/article/details/50679322" target="_blank" rel="noopener">因为Intent传输是有大小限制的</a>。为防止超出大小的现象发生，通过Uri传输最为安全。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到此为止，获取图片显示的功能已经完成了。<br><a href="https://github.com/YuanTiger/PhotoGet" target="_blank" rel="noopener">整个项目已经上传至GitHub</a>，简单总结一下：</p>
<ol>
<li>通过相册获取图片的方式有很多，但是在onActivityResult中都是以Uri的方式传递的。</li>
<li>裁剪功能不是必要的，如果没有裁剪需求可忽略。强烈建议不要将<strong>return-data</strong>设置为true，可能会超出Intent传输大小限制。</li>
<li>当你的targetSdkVersion&gt;=23时，需要进行<a href="http://www.jianshu.com/p/9271efd71450" target="_blank" rel="noopener">权限管理的升级</a>，当你的targetSdkVersion&gt;=24时，需要进行<a href="http://www.jianshu.com/p/3f9e3fc38eae" target="_blank" rel="noopener">FileProvider的适配</a>。强烈建议进行适配，提升应用的安全性。</li>
</ol>
<h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><p><a href="https://github.com/showdy/Android_Note/blob/master/showdy_note/android/strategy/%E4%BD%BF%E7%94%A8%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%86%8C%E5%9B%BE%E7%89%87%E6%88%96%E6%8B%8D%E7%85%A7%E5%B9%B6%E8%A3%81%E5%89%AA%E4%B9%8BAndroid_N%E9%80%82%E9%85%8D.md" target="_blank" rel="noopener">使用系统裁剪</a><br><a href="http://blog.csdn.net/wingichoy/article/details/50679322" target="_blank" rel="noopener">Intent传输大小实战</a><br><a href="http://www.jianshu.com/p/3f9e3fc38eae" target="_blank" rel="noopener">相机7.0图片选择适配</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/25/Android_Interview-Experience/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/25/Android_Interview-Experience/" itemprop="url">Android面试技能点</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-25T15:51:57+08:00">
                2017-07-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="技能点"><a href="#技能点" class="headerlink" title="技能点"></a>技能点</h1><h3 id="主要技能"><a href="#主要技能" class="headerlink" title="主要技能"></a>主要技能</h3><ol>
<li><a href="https://YuanTiger.github.io/2017/05/08/Java_understanding-OO/" target="_blank" rel="noopener">面向对象思想</a></li>
<li><a href="https://YuanTiger.github.io/2017/05/31/Design-Catalog/" target="_blank" rel="noopener">设计模式</a></li>
<li>算法基础</li>
<li>Android适配</li>
<li>Android架构</li>
<li>Android动画</li>
<li><a href="https://YuanTiger.github.io/2017/05/03/Android_even_distribution/" target="_blank" rel="noopener">Android事件机制</a></li>
<li><a href="https://YuanTiger.github.io/2017/05/15/Android-Handler/" target="_blank" rel="noopener">Android消息通讯机制</a></li>
<li>Android数据通传输</li>
<li>Android线程管理</li>
<li>Android内存管理</li>
<li>Android网络管理</li>
<li>Android底层机制以及Linux内核机制</li>
<li>Android JNI编程</li>
<li>Android安全机制</li>
<li>Android单元测试、压力测试</li>
<li>通过Android源码定位问题</li>
<li>Android流行开源组件、框架</li>
<li><a href="https://YuanTiger.github.io/2017/05/09/Android-Premission-Manger/" target="_blank" rel="noopener">Android权限管理</a></li>
</ol>
<h3 id="加分技能"><a href="#加分技能" class="headerlink" title="加分技能"></a>加分技能</h3><ol>
<li>计算机专业+高学历</li>
<li>独立开发能力</li>
<li>知名App的开发经验</li>
<li>Html+JavaScript</li>
<li>C++</li>
<li>蓝牙开发</li>
<li>技术难点的攻关能力</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/24/Design-Factory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/Design-Factory/" itemprop="url">应用最广-工厂方法模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T13:57:55+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="模式介绍"><a href="#模式介绍" class="headerlink" title="模式介绍"></a>模式介绍</h2><p><strong>工厂方法模式</strong>是应用最广泛的模式之一，也是创建型模式之一。<br><strong>工厂方法模式</strong>指的是定义出一个用于创建对象的接口，让子类决定实例化哪个类。听起来可能不太懂，没关系，往下看慢慢就明白了。<br><strong>工厂方法模式</strong>是一种结构简单的模式，在我们平时开发中应用非常广泛，也许你并不知道，但你已经使用了无数次该模式。</p>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><p>在任何需要生成复杂对象的地方，都可以用使用<strong>工厂方法模式</strong>。简单对象无需使用<strong>工厂方法模式</strong>，更无需使用<a href="http://www.jianshu.com/p/07bed15cd13c" target="_blank" rel="noopener"><strong>建造者模式</strong></a>，因为这样反而会损失性能。</p>
<h2 id="模式构成"><a href="#模式构成" class="headerlink" title="模式构成"></a>模式构成</h2><p><strong>工厂方法模式</strong>的成员构成如下：</p>
<ul>
<li>Product：商品功能的抽象。</li>
<li>ConcreteProduct：商品功能的具体实现。</li>
<li>Factory：生产商品的工厂抽象。</li>
<li>ConcreteFactory：生产商品的工厂具体实现。</li>
</ul>
<p>需要注意的是，<strong>工厂方法模式</strong>中的Product和<a href="http://www.jianshu.com/p/07bed15cd13c" target="_blank" rel="noopener"><strong>建造者模式</strong></a>中的Product是有区别的：<br>前者的Product指的是商品的<strong>功能</strong>，后者指的是商品的<strong>属性</strong>。<br>也就是两者Product中封装的内容是不一致的，是两个完全不同的模式结构。</p>
<h2 id="模式示例"><a href="#模式示例" class="headerlink" title="模式示例"></a>模式示例</h2><p>如果将汽车的功能抽象出来，其实都是一致的，无非是有些高级功能，有的汽车有，有的汽车没有。<br>但是最基本的功能，比如驾驶、大灯、雨刷等功能，是所有汽车都应该具备的。<br>不过就算是这些都具备的功能，也会因车的品牌、型号的不同，存在差异。<br>这些就是后话了，我们现在就开始用<strong>工厂方法模式</strong>的代码来实现上述示例。<br>先来创建汽车Product，它应该包含汽车所有的功能：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">CarProduct</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 汽车-通用功能封装</span></span><br><span class="line"><span class="comment">     * 开始驾驶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">drive</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 汽车-通用功能封装</span></span><br><span class="line"><span class="comment">     * 打开车的大灯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">openHeadlamps</span>(<span class="params"></span>)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//....省略其他功能</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出，我们的汽车商品包含驾驶以及大灯两个功能。<br>两个最简单的功能，在不同品牌、不同型号的车下都会存在差异：<br>奥迪A6L：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AudiA6L</span> <span class="keyword">implements</span> <span class="title">CarProduct</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">"factory"</span>,<span class="string">"奥迪A6L，平稳起步。"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openHeadlamps</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">"factory"</span>,<span class="string">"奥迪A6L，尊享华丽大灯打开！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>奔驰E260L：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BenzE260L</span> <span class="keyword">implements</span> <span class="title">CarProduct</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">"factory"</span>,<span class="string">"奔驰E260L，弹射起步！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openHeadlamps</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">"factory"</span>,<span class="string">"奔驰E260L，标配大灯打开。"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们创建了两款汽车，分别去实现了<code>CarProduct</code>，并且实现了各自功能的细节。<br>栗子而已，各位看官可不要因为奔驰E260L能不能弹射起步和我撕啊。<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/gaoxiao/%E9%80%80%E5%87%BA%E8%A3%85%E9%80%BC%E7%95%8C.jpg" alt=""><br>如果还有其他类型的汽车，我们只需要接着创建类去实现<code>CarProduct</code>即可。<br>接下来我们就要创建汽车的生产工厂了：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">CarFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建CarProduct</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @return CarProduct</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CarProduct <span class="title">createProduct</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出我们的抽象工厂中，返回了<strong>抽象</strong>的商品对象。<br>那么我们应该在工厂实现中，实现创建商品的具体细节：<br>奥迪A6L的工厂：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">AudiA6LFactory</span> <span class="keyword">extends</span> <span class="title">CarFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="type">CarProduct</span> createProduct() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">AudiA6L</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>奔驰E260L的工厂：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">BenzE260LFactory</span> <span class="keyword">extends</span> <span class="title">CarFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="type">CarProduct</span> createProduct() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">BenzE260L</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为示例比较简单，仅仅是new的操作，实际创建汽车会更复杂一些。<br>接下来我们写一些测试代码：<br><figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建奔驰工厂</span></span><br><span class="line"><span class="type">CarFactory</span> carFactory1 = <span class="function"><span class="keyword">new</span> <span class="title">BenzE260LFactory</span>();</span></span><br><span class="line"><span class="function"><span class="title">BenzE260L</span> <span class="title">product1</span> = (<span class="type">BenzE260L</span>) <span class="title">carFactory1</span>.<span class="title">createProduct</span>();</span></span><br><span class="line"><span class="function"><span class="title">product1</span>.<span class="title">drive</span>();</span></span><br><span class="line"><span class="function"><span class="title">product1</span>.<span class="title">openHeadlamps</span>();</span></span><br><span class="line"><span class="function"><span class="comment">//创建奥迪工厂</span></span></span><br><span class="line"><span class="function"><span class="title">CarFactory</span> <span class="title">carFactory2</span> = <span class="title">new</span> <span class="title">AudiA6LFactory</span>();</span></span><br><span class="line"><span class="function"><span class="title">AudiA6L</span> <span class="title">product2</span> = (<span class="type">AudiA6L</span>) <span class="title">carFactory2</span>.<span class="title">createProduct</span>();</span></span><br><span class="line"><span class="function"><span class="title">product2</span>.<span class="title">drive</span>();</span></span><br><span class="line"><span class="function"><span class="title">product2</span>.<span class="title">openHeadlamps</span>();</span></span><br></pre></td></tr></table></figure></p>
<p>这里注意一点，创建工厂的代码是利用面向对象思想中<strong>多态思想（继承、重写、父类引用指向子类对象）</strong>来书写的。<br>接下来打印的Log如下：<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">factory:</span> 奔驰E260L，弹射起步！</span><br><span class="line"><span class="symbol">factory:</span> 奔驰E260L，标配大灯打开。</span><br><span class="line"><span class="symbol">factory:</span> 奥迪A6L，平稳起步。</span><br><span class="line"><span class="symbol">factory:</span> 奥迪A6L，尊享华丽大灯打开！</span><br></pre></td></tr></table></figure></p>
<p>到这里，我们最基本的<strong>工厂方法模式</strong>已经实现了。<br>但是到这里还有一个缺陷：<strong>商品实现与工厂实现一对一。</strong><br>也就是说每多出一个汽车类型、就要为其创建一个具体工厂实现。<br>为了解决这一问题，我们需要对工厂抽象、工厂细节进行优化，利用<strong>泛型</strong>和<strong>反射</strong>来实现<strong>商品实现与工厂实现多对一：</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">NewCarFactory</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 利用泛型来决定要生成的具体商品</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clz 具体商品的类名class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 具体商品的类名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 具体商品类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> &lt;T extends CarProduct&gt; T createProduct(<span class="class"><span class="keyword">Class</span>&lt;<span class="title">T</span>&gt; <span class="title">clz</span>);</span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>上面代码就是经过优化的抽象工厂，创建方法增加了一个参数，决定了要创建的具体商品。<br>接下来是工厂的具体细节，应该具备创建任意商品的功能：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CarConcreteFactory</span> <span class="keyword">extends</span> <span class="title">NewCarFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public &lt;<span class="type">T</span> <span class="keyword">extends</span> <span class="type">CarProduct</span>&gt; <span class="type">T</span> createProduct(<span class="type">Class</span>&lt;<span class="type">T</span>&gt; clz) &#123;</span><br><span class="line">        <span class="type">CarProduct</span> product = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            product = (<span class="type">CarProduct</span>) <span class="type">Class</span>.forName(clz.getName()).newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="type">Exception</span> e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">T</span>) product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们用参数得到类名，然后通过反射来创建对应的类。<br>这样子我们只要有这么一个工厂细节，就能应对所有的商品创建。<br>写一下测试代码：<br><figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建通用汽车工厂</span></span><br><span class="line"><span class="type">NewCarFactory</span> carFactory = <span class="function"><span class="keyword">new</span> <span class="title">CarConcreteFactory</span>();</span></span><br><span class="line"><span class="function"><span class="comment">//创建奔驰E260L</span></span></span><br><span class="line"><span class="function"><span class="title">BenzE260L</span> <span class="title">benzE260L</span> = <span class="title">carFactory</span>.<span class="title">createProduct</span>(<span class="type">BenzE260L</span>.class);</span></span><br><span class="line"><span class="function"><span class="comment">//创建奥迪A6L</span></span></span><br><span class="line"><span class="function"><span class="title">AudiA6L</span> <span class="title">audiA6L</span> = <span class="title">carFactory</span>.<span class="title">createProduct</span>(<span class="type">AudiA6L</span>.class);</span></span><br><span class="line"><span class="function"><span class="comment">//测试</span></span></span><br><span class="line"><span class="function"><span class="title">benzE260L</span>.<span class="title">drive</span>();</span></span><br><span class="line"><span class="function"><span class="title">audiA6L</span>.<span class="title">drive</span>();</span></span><br><span class="line"><span class="function"><span class="title">benzE260L</span>.<span class="title">openHeadlamps</span>();</span></span><br><span class="line"><span class="function"><span class="title">audiA6L</span>.<span class="title">openHeadlamps</span>();</span></span><br></pre></td></tr></table></figure></p>
<p>只有一个工厂，生产出了不同类型的汽车。<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">factory:</span> 奔驰E260L，弹射起步！</span><br><span class="line"><span class="symbol">factory:</span> 奥迪A6L，平稳起步。</span><br><span class="line"><span class="symbol">factory:</span> 奔驰E260L，标配大灯打开。</span><br><span class="line"><span class="symbol">factory:</span> 奥迪A6L，尊享华丽大灯打开！</span><br></pre></td></tr></table></figure></p>
<p>结果是一致的。<br>两种实现方式都可以，利用<strong>反射</strong>的方式更简洁而已。<br>而且上面一对一的写法，还有一个名字：<strong>多工厂方法模式</strong>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>工厂方法模式</strong>对于大家来说是非常好理解的一个模式，即便是第一次听说，只要读者懂点Java知识，理解这个模式绝对不难。<br><strong>工厂方法模式</strong>也存在缺陷：每次我们添加新的商品时，都要创建新的类。<br>如果你辞职了，让不懂<strong>工厂方法模式</strong>的人接手了，这简直是折磨，因为虽然解耦了，但是代码复杂度也随之提升了。<br>是否使用<strong>工厂方法模式</strong>，需要设计者，你，来决定。</p>
<h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><p>《Android源码设计模式解析与实战》 何红辉、关爱民 著</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/15/Design-Clone/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/15/Design-Clone/" itemprop="url">程序运行更高效-原型模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-15T14:52:23+08:00">
                2017-07-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="模式介绍"><a href="#模式介绍" class="headerlink" title="模式介绍"></a>模式介绍</h2><p><strong>原型模式</strong>是一种创建式模式。<br>用户可以从一个样板对象中复制出一个内部属性一致的对象，这个过程也就是我们常说的“克隆”。<br>被复制出的对象就是我们所说的“原型”，这个“原型”是可以进行定制的。<br><strong>原型模式</strong>多用于创建复杂、构造耗时的对象，<strong>因为在这种情况下，利用原型模式复制一个已经存在的对象可以使程序运行更高效</strong>。</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul>
<li>一个对象初始化时需要消耗非常多的资源；</li>
<li>一个对象需要提供给多个对象访问，并且多个对象调用时需要进行定制。</li>
</ul>
<p>需要注意的是，复制操作并不一定比new快，只有当new对象较为耗时或成本较高时，通过复制才能获得效率上的提升。<br>因此，在使用<strong>原型模式</strong>时需要对对象的构建成本进行一些效率测试。</p>
<h2 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h2><p>如何实现复制操作？<br>非常简单，Java提供了一个叫做<strong>Cloneable</strong>的接口，我们只需实现该接口，重写它的<code>clone()</code>方法即可。<br>现在我们来举个简单实例来演示<strong>原型模式</strong>：<br>假设我们现在有一篇文档对象：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordDocument</span></span>&#123;</span><br><span class="line">    <span class="comment">//文本</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> text;</span><br><span class="line">    <span class="comment">//作者</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> author;</span><br><span class="line">    <span class="comment">//图片集合</span></span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;<span class="keyword">String</span>&gt; imageList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//....省略get、set</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>里面包含了作者、文本以及图片合集，现在我们要让这个文档实现复制功能：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> WordDocument <span class="keyword">implements</span> Cloneable &#123;</span><br><span class="line">    <span class="comment">//文本</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> text;</span><br><span class="line">    <span class="comment">//作者</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> author;</span><br><span class="line">    <span class="comment">//图片集合</span></span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;<span class="built_in">String</span>&gt; imageList;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> WordDocument clone() &#123;</span><br><span class="line">        WordDocument <span class="built_in">document</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">document</span> = (WordDocument) <span class="keyword">super</span>.clone();</span><br><span class="line">            <span class="built_in">document</span>.text = <span class="keyword">this</span>.text;</span><br><span class="line">            <span class="built_in">document</span>.author = <span class="keyword">this</span>.author;</span><br><span class="line">            <span class="built_in">document</span>.imageList = <span class="keyword">this</span>.imageList;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">document</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//....省略get、set</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>非常简单，我们让<strong>WordDocument</strong>实现了<strong>Cloneable</strong>接口并重写了<code>clone()</code>方法，在<code>clone()</code>中进行对象的克隆操作。<br>那么接下来我们来实际演示下克隆效果：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建对象</span></span><br><span class="line">WordDocument <span class="built_in">document</span> = <span class="keyword">new</span> WordDocument();</span><br><span class="line"><span class="built_in">document</span>.setAuthor(<span class="string">"孟远"</span>);</span><br><span class="line"><span class="built_in">document</span>.setText(<span class="string">"这是一篇极好的文章。"</span>);</span><br><span class="line"><span class="built_in">document</span>.addImage(<span class="string">"图0"</span>);</span><br><span class="line"><span class="built_in">document</span>.addImage(<span class="string">"图1"</span>);</span><br><span class="line"><span class="comment">//打印创建的对象</span></span><br><span class="line">tv_clone_0.append(<span class="string">"创建的对象:\n"</span> + <span class="built_in">document</span>.toString());</span><br><span class="line"><span class="comment">//克隆对象</span></span><br><span class="line">WordDocument cloneBean = <span class="built_in">document</span>.clone();</span><br><span class="line"><span class="comment">//打印克隆的对象</span></span><br><span class="line">tv_clone_0.append(<span class="string">"克隆的对象:\n"</span> + cloneBean.toString());</span><br><span class="line"><span class="comment">//修改克隆的对象</span></span><br><span class="line">cloneBean.setAuthor(<span class="string">"黑色小老虎"</span>);</span><br><span class="line">cloneBean.addImage(<span class="string">"新加图片2"</span>);</span><br><span class="line"><span class="comment">//再次打印2个对象</span></span><br><span class="line">tv_clone_0.append(<span class="string">"修改克隆对象:\n"</span> + cloneBean.toString());</span><br><span class="line">tv_clone_0.append(<span class="string">"最开始的对象:\n"</span> + <span class="built_in">document</span>.toString());</span><br></pre></td></tr></table></figure></p>
<p>这段代码我们创建了一篇文章，之后拷贝了这篇文章并修改了拷贝文章。<br>在这期间，一共进行了4次对象的<code>toString</code>：</p>
<ol>
<li>创建对象完成时打印了创建对象；</li>
<li>拷贝完成时打印了拷贝对象；</li>
<li>修改拷贝对象完成时打印了拷贝对象；</li>
<li>最后再次打印最初创建的对象。</li>
</ol>
<p>这里请注意，我们修改拷贝对象时，修改了作者姓名并且添加了一张图片。<br>最后打印的结果如下：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/design_clone_0.png" alt=""><br>细心的同学会发现，我们修改了拷贝对象的作者昵称，原对象没有受到影响。但是我们增加一张图片到拷贝对象的集合中时，原对象也发生了变化。<br>这就牵扯到了<strong>浅拷贝</strong>和<strong>深拷贝</strong>。</p>
<h2 id="深拷贝"><a href="#深拷贝" class="headerlink" title="深拷贝"></a>深拷贝</h2><p>上述简单实例，是使用了<strong>浅拷贝</strong>来实现的。所谓<strong>浅拷贝</strong>就是直接引用原对象中的嵌套对象，不会去进行创建。<br>大家应该都知道<strong>对象引用</strong>的问题：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Bean a</span> = new Bean(<span class="string">"孟远"</span>,<span class="string">"23"</span>,<span class="string">"男"</span>);</span><br><span class="line"><span class="attribute">Bean b</span> = a;</span><br></pre></td></tr></table></figure></p>
<p>此时b对象引用了a对象，也就是说其实a和b两个对象在堆内存中指向的是同一个地址，当修改b时，a也必定跟着发生变化。<br>同理我们再回头重新看下<strong>WordDocument</strong>的<code>clone()</code>代码：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> WordDocument clone() &#123;</span><br><span class="line">    WordDocument <span class="built_in">document</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">document</span> = (WordDocument) <span class="keyword">super</span>.clone();</span><br><span class="line">        <span class="built_in">document</span>.text = <span class="keyword">this</span>.text;</span><br><span class="line">        <span class="built_in">document</span>.author = <span class="keyword">this</span>.author;</span><br><span class="line">        <span class="comment">//问题所在，直接引用当前对象的List</span></span><br><span class="line">        <span class="built_in">document</span>.imageList = <span class="keyword">this</span>.imageList;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">document</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以发现我们直接引用了当前对象的List，导致在内存中拷贝对象和最初对象的List指向了同一个地址。<br>上面代码就是我们口中的<strong>浅拷贝</strong>。<br>那么如何解决这个问题？<br>很简单，使用<strong>深拷贝</strong>，<strong>即内部对象也使用<code>clone()</code>：</strong><br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> WordDocument clone() &#123;</span><br><span class="line">    WordDocument <span class="built_in">document</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">document</span> = (WordDocument) <span class="keyword">super</span>.clone();</span><br><span class="line">        <span class="built_in">document</span>.text = <span class="keyword">this</span>.text;</span><br><span class="line">        <span class="built_in">document</span>.author = <span class="keyword">this</span>.author;</span><br><span class="line">        <span class="comment">//关建行</span></span><br><span class="line">        <span class="built_in">document</span>.imageList = (ArrayList&lt;<span class="built_in">String</span>&gt;) imageList.clone();</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">document</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们点进ArrayList的源码可以发现，ArrayList已经实现了<strong>Cloneable</strong>接口，所以我们直接调用ArrayList的<code>clone()</code>即可。<br>修改完这一行代码之后，再次执行上面演示代码：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/design_clone_1.png" alt=""><br>完美，可以发现在修改完克隆对象之后，最开始的对象已经不会受到影响。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><a href="https://github.com/YuanTiger/Design-Pattern" target="_blank" rel="noopener">上述演示代码已经上传至GitHub。</a><br><strong>原型模式</strong>是非常简单的一个模式，它的核心问题就是对原始对象进行拷贝，在这个模式的使用过程中需要注意一点就是：深、浅拷贝的问题。<br>在实际开发过程中，为了减少错误，建议各位读者在使用<strong>原型模式</strong>时尽量使用深拷贝，避免操作副本时影响到原始对象。</p>
<h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><p>《Android源码设计模式解析与实战》 何红辉、关爱民 著</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">孟远</p>
              <p class="site-description motion-element" itemprop="description">一名Android开发小将</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">孟远</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
