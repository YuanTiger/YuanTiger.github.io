<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="一名Android开发小将">
<meta property="og:type" content="website">
<meta property="og:title" content="孟远">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="孟远">
<meta property="og:description" content="一名Android开发小将">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="孟远">
<meta name="twitter:description" content="一名Android开发小将">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>孟远</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">孟远</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">每天进步一点点</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/15/Design-Clone/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/15/Design-Clone/" itemprop="url">程序运行更高效-原型模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-15T14:52:23+08:00">
                2017-07-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="模式介绍"><a href="#模式介绍" class="headerlink" title="模式介绍"></a>模式介绍</h2><p><strong>原型模式</strong>是一种创建式模式。<br>用户可以从一个样板对象中复制出一个内部属性一致的对象，这个过程也就是我们常说的“克隆”。<br>被复制出的对象就是我们所说的“原型”，这个“原型”是可以进行定制的。<br><strong>原型模式</strong>多用于创建复杂、构造耗时的对象，<strong>因为在这种情况下，利用原型模式复制一个已经存在的对象可以使程序运行更高效</strong>。</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul>
<li>一个对象初始化时需要消耗非常多的资源；</li>
<li>一个对象需要提供给多个对象访问，并且多个对象调用时需要进行定制。</li>
</ul>
<p>需要注意的是，复制操作并不一定比new快，只有当new对象较为耗时或成本较高时，通过复制才能获得效率上的提升。<br>因此，在使用<strong>原型模式</strong>时需要对对象的构建成本进行一些效率测试。</p>
<h2 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h2><p>如何实现复制操作？<br>非常简单，Java提供了一个叫做<strong>Cloneable</strong>的接口，我们只需实现该接口，重写它的<code>clone()</code>方法即可。<br>现在我们来举个简单实例来演示<strong>原型模式</strong>：<br>假设我们现在有一篇文档对象：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordDocument</span></span>&#123;</span><br><span class="line">    <span class="comment">//文本</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> text;</span><br><span class="line">    <span class="comment">//作者</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> author;</span><br><span class="line">    <span class="comment">//图片集合</span></span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;<span class="keyword">String</span>&gt; imageList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//....省略get、set</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>里面包含了作者、文本以及图片合集，现在我们要让这个文档实现复制功能：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> WordDocument <span class="keyword">implements</span> Cloneable &#123;</span><br><span class="line">    <span class="comment">//文本</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> text;</span><br><span class="line">    <span class="comment">//作者</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> author;</span><br><span class="line">    <span class="comment">//图片集合</span></span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;<span class="built_in">String</span>&gt; imageList;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> WordDocument clone() &#123;</span><br><span class="line">        WordDocument <span class="built_in">document</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">document</span> = (WordDocument) <span class="keyword">super</span>.clone();</span><br><span class="line">            <span class="built_in">document</span>.text = <span class="keyword">this</span>.text;</span><br><span class="line">            <span class="built_in">document</span>.author = <span class="keyword">this</span>.author;</span><br><span class="line">            <span class="built_in">document</span>.imageList = <span class="keyword">this</span>.imageList;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">document</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//....省略get、set</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>非常简单，我们让<strong>WordDocument</strong>实现了<strong>Cloneable</strong>接口并重写了<code>clone()</code>方法，在<code>clone()</code>中进行对象的克隆操作。<br>那么接下来我们来实际演示下克隆效果：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建对象</span></span><br><span class="line">WordDocument <span class="built_in">document</span> = <span class="keyword">new</span> WordDocument();</span><br><span class="line"><span class="built_in">document</span>.setAuthor(<span class="string">"孟远"</span>);</span><br><span class="line"><span class="built_in">document</span>.setText(<span class="string">"这是一篇极好的文章。"</span>);</span><br><span class="line"><span class="built_in">document</span>.addImage(<span class="string">"图0"</span>);</span><br><span class="line"><span class="built_in">document</span>.addImage(<span class="string">"图1"</span>);</span><br><span class="line"><span class="comment">//打印创建的对象</span></span><br><span class="line">tv_clone_0.append(<span class="string">"创建的对象:\n"</span> + <span class="built_in">document</span>.toString());</span><br><span class="line"><span class="comment">//克隆对象</span></span><br><span class="line">WordDocument cloneBean = <span class="built_in">document</span>.clone();</span><br><span class="line"><span class="comment">//打印克隆的对象</span></span><br><span class="line">tv_clone_0.append(<span class="string">"克隆的对象:\n"</span> + cloneBean.toString());</span><br><span class="line"><span class="comment">//修改克隆的对象</span></span><br><span class="line">cloneBean.setAuthor(<span class="string">"黑色小老虎"</span>);</span><br><span class="line">cloneBean.addImage(<span class="string">"新加图片2"</span>);</span><br><span class="line"><span class="comment">//再次打印2个对象</span></span><br><span class="line">tv_clone_0.append(<span class="string">"修改克隆对象:\n"</span> + cloneBean.toString());</span><br><span class="line">tv_clone_0.append(<span class="string">"最开始的对象:\n"</span> + <span class="built_in">document</span>.toString());</span><br></pre></td></tr></table></figure></p>
<p>这段代码我们创建了一篇文章，之后拷贝了这篇文章并修改了拷贝文章。<br>在这期间，一共进行了4次对象的<code>toString</code>：</p>
<ol>
<li>创建对象完成时打印了创建对象；</li>
<li>拷贝完成时打印了拷贝对象；</li>
<li>修改拷贝对象完成时打印了拷贝对象；</li>
<li>最后再次打印最初创建的对象。</li>
</ol>
<p>这里请注意，我们修改拷贝对象时，修改了作者姓名并且添加了一张图片。<br>最后打印的结果如下：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/design_clone_0.png" alt=""><br>细心的同学会发现，我们修改了拷贝对象的作者昵称，原对象没有受到影响。但是我们增加一张图片到拷贝对象的集合中时，原对象也发生了变化。<br>这就牵扯到了<strong>浅拷贝</strong>和<strong>深拷贝</strong>。</p>
<h2 id="深拷贝"><a href="#深拷贝" class="headerlink" title="深拷贝"></a>深拷贝</h2><p>上述简单实例，是使用了<strong>浅拷贝</strong>来实现的。所谓<strong>浅拷贝</strong>就是直接引用原对象中的嵌套对象，不会去进行创建。<br>大家应该都知道<strong>对象引用</strong>的问题：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Bean a</span> = new Bean(<span class="string">"孟远"</span>,<span class="string">"23"</span>,<span class="string">"男"</span>);</span><br><span class="line"><span class="attribute">Bean b</span> = a;</span><br></pre></td></tr></table></figure></p>
<p>此时b对象引用了a对象，也就是说其实a和b两个对象在堆内存中指向的是同一个地址，当修改b时，a也必定跟着发生变化。<br>同理我们再回头重新看下<strong>WordDocument</strong>的<code>clone()</code>代码：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> WordDocument clone() &#123;</span><br><span class="line">    WordDocument <span class="built_in">document</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">document</span> = (WordDocument) <span class="keyword">super</span>.clone();</span><br><span class="line">        <span class="built_in">document</span>.text = <span class="keyword">this</span>.text;</span><br><span class="line">        <span class="built_in">document</span>.author = <span class="keyword">this</span>.author;</span><br><span class="line">        <span class="comment">//问题所在，直接引用当前对象的List</span></span><br><span class="line">        <span class="built_in">document</span>.imageList = <span class="keyword">this</span>.imageList;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">document</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以发现我们直接引用了当前对象的List，导致在内存中拷贝对象和最初对象的List指向了同一个地址。<br>上面代码就是我们口中的<strong>浅拷贝</strong>。<br>那么如何解决这个问题？<br>很简单，使用<strong>深拷贝</strong>，<strong>即内部对象也使用<code>clone()</code>：</strong><br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> WordDocument clone() &#123;</span><br><span class="line">    WordDocument <span class="built_in">document</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">document</span> = (WordDocument) <span class="keyword">super</span>.clone();</span><br><span class="line">        <span class="built_in">document</span>.text = <span class="keyword">this</span>.text;</span><br><span class="line">        <span class="built_in">document</span>.author = <span class="keyword">this</span>.author;</span><br><span class="line">        <span class="comment">//关建行</span></span><br><span class="line">        <span class="built_in">document</span>.imageList = (ArrayList&lt;<span class="built_in">String</span>&gt;) imageList.clone();</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">document</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们点进ArrayList的源码可以发现，ArrayList已经实现了<strong>Cloneable</strong>接口，所以我们直接调用ArrayList的<code>clone()</code>即可。<br>修改完这一行代码之后，再次执行上面演示代码：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/design_clone_1.png" alt=""><br>完美，可以发现在修改完克隆对象之后，最开始的对象已经不会受到影响。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><a href="https://github.com/YuanTiger/Design-Pattern" target="_blank" rel="noopener">上述演示代码已经上传至GitHub。</a><br><strong>原型模式</strong>是非常简单的一个模式，它的核心问题就是对原始对象进行拷贝，在这个模式的使用过程中需要注意一点就是：深、浅拷贝的问题。<br>在实际开发过程中，为了减少错误，建议各位读者在使用<strong>原型模式</strong>时尽量使用深拷贝，避免操作副本时影响到原始对象。</p>
<h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><p>《Android源码设计模式解析与实战》 何红辉、关爱民 著</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/11/Builder-Dialog/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/11/Builder-Dialog/" itemprop="url">建造者模式的全局Dialog</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-11T16:46:12+08:00">
                2017-07-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这篇小文将讲述我是如何根据<strong>建造者设计模式</strong>来实现一个全局Dialog。<br><a href="http://www.jianshu.com/p/07bed15cd13c" target="_blank" rel="noopener">如果各位看官还不太了解建造者设计模式，建议可以看一下我的上篇文章。</a></p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在每个项目当中，都会封装一些全局的样式，比如全局Loading、全局Dialog等。<br>封装这些功能是因为这些控件的使用频率极高。<br>在我刚接手项目A的时候，项目A也不例外，拥有着全局的Dialog。<br>刚开始时我尽量写一些侵入性低、仿照率高的代码，避免影响到之前的逻辑。并且学习着如何使用项目A的框架，这个过程我相信大家都是一样的。<br>当我用到Dialog的时候，我看到了项目A的全局Dialog，详细代码就不说了，给大家看一下项目A全局Dialog中的所有方法：</p>
<p><img src="http://7xvzby.com1.z0.glb.clouddn.com/builder_dialog_0.png" alt=""><br>不知各位看官会不会被这么多的构造方法给吓到。<br>这些构造方法都是随着项目需求的增加而增加的。<br>大家都知道，一个完整Dialog包括的元素至少应该有：提示图片、标题、描述文字、按钮等。<br>但是这些元素都不是必须的：<br>在C页面我弹出的Dialog可能只要做一个温馨提示：一行描述文字外加一个确认按钮。<br>在D页面我可能弹出的是用户退出登录的二次确认窗口：标题+文字+两个按钮。<br>那么到这里，各位看官就能明白了，为什么会有那么多的构造方法。<br>没错，我们在<strong>new KLCustimDialog()</strong>的同时，需要把所有的参数都传入进去。<br>这种写法的问题以及维护成本之高，我就不做过多描述了，我就简单给大家加个需求：<br>要求点击Dialog外部不能取消Dialog。<br>想想这个需求下的构造方法，要添加几个？</p>
<h2 id="基本"><a href="#基本" class="headerlink" title="基本"></a>基本</h2><p>当我刚看到<strong>建造者模式</strong>的时候，我真是又惊又喜，热血沸腾！<br>我第一时间想到的就是重构项目A的全局Dialog！<br>大家都知道，Android中的<code>AlertDialog</code>就是使用<strong>建造者模式</strong>来实现的。<br>在我模仿构思了一波之后，创建Dialog的代码是这样的：<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Dialog.Builder builder = new Dialog.Builder(context)<span class="comment">;</span></span><br><span class="line">builder.setTitle(<span class="string">"提示"</span>)<span class="comment">;</span></span><br><span class="line">builder.setMessage(<span class="string">"确认退出登录吗？"</span>)<span class="comment">;</span></span><br><span class="line">builder.setLeftText(<span class="string">"取消"</span>)<span class="comment">;</span></span><br><span class="line">builder.setRightText(<span class="string">"确认"</span>)<span class="comment">;</span></span><br><span class="line">builder.setOnclickListener(listener)<span class="comment">;</span></span><br><span class="line">Dialog dialog = builder.creater()<span class="comment">;</span></span><br><span class="line">dialog.show()<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>这样写似乎没有什么问题了。<br>我们把Dialog的所有元素都默认隐藏，在调用某个元素的填充方法后，我们就将其显示出来。<br>这样我们就摆脱了无限多的构造方法，完美！<br>文章到这里就应该结束了？<br>怎么可能！我都没变形呢！</p>
<p>我见别人的Builder模式都是这样写的：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Picasso</span><span class="selector-class">.with</span>(<span class="selector-tag">context</span>)</span><br><span class="line">    <span class="selector-class">.load</span>(<span class="selector-tag">url</span>)</span><br><span class="line">    <span class="selector-class">.fit</span>()</span><br><span class="line">    <span class="selector-class">.config</span>(<span class="selector-tag">XXX</span>)</span><br><span class="line">    <span class="selector-class">.placeholder</span>(<span class="selector-tag">xxx</span>)</span><br><span class="line">    <span class="selector-class">.error</span>(<span class="selector-tag">xxx</span>)</span><br><span class="line">    <span class="selector-class">.into</span>(<span class="selector-tag">imageView</span>);</span><br></pre></td></tr></table></figure></p>
<p>上述代码是使用<strong>Picasso</strong>来加载url图片。<br>一行代码完成。<br>帅不帅，想不想学？<br>所以我就想能不能用上面作为模板，来实现我们的全局Dialog。<br>话不多说，说干就干。</p>
<h2 id="变形"><a href="#变形" class="headerlink" title="变形"></a>变形</h2><p>完整代码我已经上传GitHub，看代码我还是建议各位看官去<a href="https://github.com/YuanTiger/Design-Pattern/blob/master/app/src/main/java/com/my/designdemo/builder/dialog/DialogProduct.java" target="_blank" rel="noopener">我的GitHub</a>上看，比较整洁。<br>最终实现的效果如下：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/dialog_builder_gif.gif" alt=""><br>首先，让我们来回想一下<strong>建造者模式</strong>的组成：</p>
<ul>
<li>Product：产品角色</li>
<li>Builder：抽象的建造者</li>
<li>ConcreteBuilder：具体的建造者</li>
<li>Director：指挥者</li>
</ul>
<p>接下来，我们再把这些成员转化为我们的全局Dialog的成员：</p>
<ul>
<li>Product：Dialog就是我们制作出来的产品</li>
<li>Builder：Dialog参数拼接抽象</li>
<li>ConcreteBuilder：Dialog参数拼接细节</li>
<li>Director：所有用到该Dialog的地方都是指挥者，它们决定着Dialog具体样式。</li>
</ul>
<p>思路有了，下面就开始动手吧，首先我们来创建Dialog的参数封装，里面应该有Dialog所有组成元素：<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> class DialogParams &#123;</span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line">    <span class="comment">//标题</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> title;</span><br><span class="line">    <span class="comment">//标题字体大小</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> titleSizeSp;</span><br><span class="line">    <span class="comment">//图标资源</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> imageResource;</span><br><span class="line">    <span class="comment">//图标宽</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> imageWidth;</span><br><span class="line">    <span class="comment">//图标高</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> imageHeight;</span><br><span class="line">    <span class="comment">//消息内容</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> message1;</span><br><span class="line">    <span class="comment">//消息内容文字位置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> message1Gravity = Gravity.CENTER;</span><br><span class="line">    <span class="comment">//点击外部是否可以取消</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">boolean</span> isCanCancel = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">//左边按钮内容</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> leftButtonText;</span><br><span class="line">    <span class="comment">//左边按钮颜色</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> leftBtColor;</span><br><span class="line">    <span class="comment">//左边点击事件</span></span><br><span class="line">    <span class="keyword">private</span> ConcreteBuilder.ButtonClickLister leftListener;</span><br><span class="line">    <span class="comment">//右边按钮内容</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> rightButtontText;</span><br><span class="line">    <span class="comment">//右边边按钮颜色</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> rightBtColor;</span><br><span class="line">    <span class="comment">//右边按钮点击事件</span></span><br><span class="line">    <span class="keyword">private</span> ConcreteBuilder.ButtonClickLister rightListener;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我使用了内部类去实现了整个Dialog，整个Dialog只有一个类，所以所有参数都是private并且没有提供set、get。<br>并且我为了方便，省略了Builder抽象类，直接构造了Builder抽象类的实现<strong>ConcreteBuilder</strong>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteBuilder</span> </span>&#123;</span><br><span class="line">    <span class="comment">//持有Product对象</span></span><br><span class="line">    <span class="keyword">private</span> DialogParams p;</span><br><span class="line">    </span><br><span class="line">    ConcreteBuilder(Context context) &#123;</span><br><span class="line">        p = <span class="keyword">new</span> DialogParams();</span><br><span class="line">        p.context = context;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcreteBuilder <span class="title">title</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        p.title = text;</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcreteBuilder <span class="title">titleSize</span><span class="params">(<span class="keyword">int</span> spSize)</span> </span>&#123;</span><br><span class="line">        p.titleSizeSp = spSize;</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcreteBuilder <span class="title">imageResource</span><span class="params">(<span class="keyword">int</span> imageResource)</span> </span>&#123;</span><br><span class="line">        p.imageResource = imageResource;</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcreteBuilder <span class="title">imageWidth</span><span class="params">(<span class="keyword">int</span> imageWidth)</span> </span>&#123;</span><br><span class="line">        p.imageWidth = imageWidth;</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcreteBuilder <span class="title">imageHeight</span><span class="params">(<span class="keyword">int</span> imageHeight)</span> </span>&#123;</span><br><span class="line">        p.imageHeight = imageHeight;</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcreteBuilder <span class="title">message</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        p.message1 = text;</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcreteBuilder <span class="title">messageGravity</span><span class="params">(<span class="keyword">int</span> gravity)</span> </span>&#123;</span><br><span class="line">        p.message1Gravity = gravity;</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcreteBuilder <span class="title">canCancel</span><span class="params">(<span class="keyword">boolean</span> isCanCancel)</span> </span>&#123;</span><br><span class="line">        p.isCanCancel = isCanCancel;</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcreteBuilder <span class="title">leftBt</span><span class="params">(String text, ButtonClickLister lister)</span> </span>&#123;</span><br><span class="line">        p.leftButtonText = text;</span><br><span class="line">        p.leftListener = lister;</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcreteBuilder <span class="title">leftBtColor</span><span class="params">(<span class="keyword">int</span> color)</span> </span>&#123;</span><br><span class="line">        p.leftBtColor = color;</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcreteBuilder <span class="title">rightBtColor</span><span class="params">(<span class="keyword">int</span> color)</span> </span>&#123;</span><br><span class="line">        p.rightBtColor = color;</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcreteBuilder <span class="title">rightBt</span><span class="params">(String text, ButtonClickLister lister)</span> </span>&#123;</span><br><span class="line">        p.rightButtontText = text;</span><br><span class="line">        p.rightListener = lister;</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        p = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DialogProduct <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DialogProduct(p);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//按钮点击回调</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ButtonClickLister</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogProduct dialog)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们会发现每个参数拼接方法都会返回<strong>ConcreteBuilder</strong>,这里是实现一行代码构建Dialog的关键。<br>参考<strong>Picasso</strong>的书写方式，明显可以看出它没有进行new的行为，说明<strong>with()</strong>一定是静态的，随之<strong>with()</strong>返回的对象也必为静态。<br>为了实现<strong>Picasso</strong>的书写方式，我们这里也将<strong>ConcreteBuilder</strong>静态，方便实现一句话创建Dialog。<br>接下来就是Dialog的代码：<br><figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">DialogProduct</span> <span class="title">extends</span> <span class="title">Dialog</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    private <span class="type">TextView</span> tvTitle;</span><br><span class="line">    private <span class="type">ImageView</span> ivIcon;</span><br><span class="line">    private <span class="type">TextView</span> tvMessage;</span><br><span class="line">    private <span class="type">TextView</span> tvButtonLeft;</span><br><span class="line">    private <span class="type">TextView</span> tvButtonRight;</span><br><span class="line">    private <span class="type">ImageView</span> viewLine;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//持有Builder</span></span><br><span class="line">    private static <span class="type">ConcreteBuilder</span> builder;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//模仿Picasso的书写方式</span></span><br><span class="line">    public static <span class="type">ConcreteBuilder</span> <span class="keyword">with</span>(<span class="type">Context</span> context) &#123;</span><br><span class="line">        <span class="keyword">if</span> (builder == null) &#123;</span><br><span class="line">            builder = <span class="function"><span class="keyword">new</span> <span class="title">ConcreteBuilder</span>(context);</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">        <span class="title">return</span> <span class="title">builder</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">DialogProduct</span>(<span class="type">DialogParams</span> p) &#123;</span></span><br><span class="line"><span class="function">        <span class="comment">//设置没有标题的Dialog风格</span></span></span><br><span class="line"><span class="function">        <span class="title">super</span>(p.context, <span class="type">R</span>.style.<span class="type">NoTitleDialog</span>);</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        <span class="title">View</span> <span class="title">contentView</span> = <span class="title">LayoutInflater</span>.<span class="title">from</span>(p.context).<span class="title">inflate</span>(<span class="type">R</span>.layout.dialog_build, null);</span></span><br><span class="line"><span class="function">        <span class="title">setContentView</span>(contentView);</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        <span class="title">tvTitle</span> = <span class="title">contentView</span>.<span class="title">findViewById</span>(<span class="type">R</span>.id.tv_title);</span></span><br><span class="line"><span class="function">        <span class="title">ivIcon</span> = <span class="title">contentView</span>.<span class="title">findViewById</span>(<span class="type">R</span>.id.iv_icon);</span></span><br><span class="line"><span class="function">        <span class="title">tvMessage</span> = <span class="title">contentView</span>.<span class="title">findViewById</span>(<span class="type">R</span>.id.tv_message);</span></span><br><span class="line"><span class="function">        <span class="title">tvButtonLeft</span> = <span class="title">contentView</span>.<span class="title">findViewById</span>(<span class="type">R</span>.id.tv_button_left);</span></span><br><span class="line"><span class="function">        <span class="title">tvButtonRight</span> = <span class="title">contentView</span>.<span class="title">findViewById</span>(<span class="type">R</span>.id.tv_button_right);</span></span><br><span class="line"><span class="function">        <span class="title">viewLine</span> = <span class="title">contentView</span>.<span class="title">findViewById</span>(<span class="type">R</span>.id.view_line);</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">        <span class="comment">//控件默认隐藏</span></span></span><br><span class="line"><span class="function">        <span class="title">tvTitle</span>.<span class="title">setVisibility</span>(<span class="type">View</span>.<span class="type">GONE</span>);</span></span><br><span class="line"><span class="function">        <span class="title">viewLine</span>.<span class="title">setVisibility</span>(<span class="type">View</span>.<span class="type">GONE</span>);</span></span><br><span class="line"><span class="function">        <span class="title">ivIcon</span>.<span class="title">setVisibility</span>(<span class="type">View</span>.<span class="type">GONE</span>);</span></span><br><span class="line"><span class="function">        <span class="title">tvMessage</span>.<span class="title">setVisibility</span>(<span class="type">View</span>.<span class="type">GONE</span>);</span></span><br><span class="line"><span class="function">        <span class="title">tvButtonLeft</span>.<span class="title">setVisibility</span>(<span class="type">View</span>.<span class="type">GONE</span>);</span></span><br><span class="line"><span class="function">        <span class="title">tvButtonRight</span>.<span class="title">setVisibility</span>(<span class="type">View</span>.<span class="type">GONE</span>);</span></span><br><span class="line"><span class="function">        <span class="comment">//构建Dialog</span></span></span><br><span class="line"><span class="function">        <span class="title">setTitlText</span>(p.title);</span></span><br><span class="line"><span class="function">        <span class="title">setTitlTextSize</span>(p.titleSizeSp);</span></span><br><span class="line"><span class="function">        <span class="title">setImageResource</span>(p.imageResource);</span></span><br><span class="line"><span class="function">        <span class="title">setImageWidth</span>(p.imageWidth);</span></span><br><span class="line"><span class="function">        <span class="title">setImageHeight</span>(p.imageHeight);</span></span><br><span class="line"><span class="function">        <span class="title">setTvMessage</span>(p.message1);</span></span><br><span class="line"><span class="function">        <span class="title">setTvMessageGravity</span>(p.message1Gravity);</span></span><br><span class="line"><span class="function">        <span class="title">setCancelableFlag</span>(p.isCanCancel);</span></span><br><span class="line"><span class="function">        <span class="title">setLeftText</span>(p.leftButtonText, p.leftListener);</span></span><br><span class="line"><span class="function">        <span class="title">setLeftBtColor</span>(p.leftBtColor);</span></span><br><span class="line"><span class="function">        <span class="title">setRightText</span>(p.rightButtontText, p.rightListener);</span></span><br><span class="line"><span class="function">        <span class="title">setRightBtColor</span>(p.rightBtColor);</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">     /**</span></span><br><span class="line"><span class="function">     * 设置标题</span></span><br><span class="line"><span class="function">     *</span></span><br><span class="line"><span class="function">     * @<span class="title">param</span> <span class="title">title</span> 标题文字</span></span><br><span class="line"><span class="function">     */</span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">void</span> <span class="title">setTitlText</span>(<span class="type">String</span> title) &#123;</span></span><br><span class="line"><span class="function">        <span class="title">if</span> (<span class="type">TextUtils</span>.isEmpty(title)) &#123;</span></span><br><span class="line"><span class="function">            <span class="title">return</span>;</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">        <span class="title">tvTitle</span>.<span class="title">setVisibility</span>(<span class="type">View</span>.<span class="type">VISIBLE</span>);</span></span><br><span class="line"><span class="function">        <span class="title">tvTitle</span>.<span class="title">setText</span>(title);</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    <span class="comment">//......省略剩余控件代码</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>写完之后，我们来看看这个变形的<strong>建造者模式</strong>的Dialog是如何创建的：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">DialogProduct</span><span class="selector-class">.with</span>(this)</span><br><span class="line">        <span class="selector-class">.title</span>(<span class="string">"提示"</span>)</span><br><span class="line">        <span class="selector-class">.message</span>(<span class="string">"您确认退出登录吗？"</span>)</span><br><span class="line">        <span class="selector-class">.canCancel</span>(false)</span><br><span class="line">        <span class="selector-class">.leftBtColor</span>(getResources().getColor(R.color.color_0090ff))</span><br><span class="line">        <span class="selector-class">.rightBtColor</span>(getResources().getColor(R.color.color_f96c59))</span><br><span class="line">        <span class="selector-class">.leftBt</span>(<span class="string">"取消"</span>, new NormalDialog.ConcreteBuilder.ButtonClickLister() &#123;</span><br><span class="line">            <span class="variable">@Override</span></span><br><span class="line">            public void onClick(NormalDialog dialog) &#123;</span><br><span class="line">                <span class="selector-tag">dialog</span><span class="selector-class">.cancel</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="selector-class">.rightBt</span>(<span class="string">"确认"</span>, new NormalDialog.ConcreteBuilder.ButtonClickLister() &#123;</span><br><span class="line">            <span class="variable">@Override</span></span><br><span class="line">            public void onClick(NormalDialog dialog) &#123;</span><br><span class="line">                <span class="selector-tag">Toast</span><span class="selector-class">.makeText</span>(BuilderActivity.this, <span class="string">"退出登录成功！"</span>, Toast.LENGTH_SHORT)<span class="selector-class">.show</span>();</span><br><span class="line">                <span class="selector-tag">dialog</span><span class="selector-class">.cancel</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="selector-class">.create</span>()</span><br><span class="line">        <span class="selector-class">.show</span>();</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><a href="https://github.com/YuanTiger/Design-Pattern/blob/master/app/src/main/java/com/my/designdemo/builder/dialog/DialogProduct.java" target="_blank" rel="noopener">DialogProduct的代码我已经上传到了GitHub</a>，各位看官可以自行食用。<br>这个Dialog现在也是项目A中的全局Dialog，使用起来也非常方便。<br>这里有几个细节可以和各位看官分享一下：<br>第一个就是按钮的点击事件设置，我将其与按钮文字内容的设置绑定在一起。因为我认为你设置了按钮，怎么可能会没有点击事件？<br>第二个就是按钮中间的分割线，是与右边按钮绑定的， 所以当只有一个按钮时，我们应该使用左边的按钮<strong>leftBt</strong>而不是右边的。<br>基本上就是这样啦！<br>希望这个Dialog可以给大家带来一些灵感。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/05/Design-Builder/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/05/Design-Builder/" itemprop="url">对象构造简单化-建造者模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-05T15:47:53+08:00">
                2017-07-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="模式介绍"><a href="#模式介绍" class="headerlink" title="模式介绍"></a>模式介绍</h2><p>Builder模式是指一步一步来构建出一个复杂的对象。<br>它允许用户在不知道内部构建细节的情况下，非常精细地控制对象构建流程。<br>该模式是为了将构建过程非常复杂的对象进行拆分，让它与它的部件解耦，提升代码的可读性以及扩展性。</p>
<h2 id="模式结构"><a href="#模式结构" class="headerlink" title="模式结构"></a>模式结构</h2><p><strong>建造者模式</strong>包含如下角色：</p>
<ul>
<li>Product：产品角色</li>
<li>Builder：<strong>抽象</strong>的建造者</li>
<li>ConcreteBuilder：具体的建造者</li>
<li>Director：指挥者</li>
</ul>
<h2 id="模式示例"><a href="#模式示例" class="headerlink" title="模式示例"></a>模式示例</h2><p>我们来举个生活中的例子来描述<strong>建造者模式</strong>的各个角色：<br>假设我们现在是一个手机的生产商，各大手机厂商都会来找我们制造手机，比如小米、华为、三星、魅族等。每个厂商的手机配置都不一致，包括CPU型号、内存大小、像素大小等等。<br>现在我们将这个例子中的对象转化成<strong>建造者模式</strong>的各个角色：</p>
<ul>
<li>Product：我们生产的手机就是商品，Product中应该包含手机的各个部件。</li>
<li>Builder：抽象Builder类，细节全在ConcreteBuilder中。</li>
<li>ConcreteBuilder：继承了Builder类，这里有手机的组装细节。</li>
<li>Director：这里的指挥者就是各大手机厂商，我要让你生产一台小米手机并给了你一系列参数，你就要按照参数，生产我想要的手机，其他手机也是同样的同理。</li>
</ul>
<p>纸上谈兵终觉浅，我们将上述实例转化成代码看一看：<br>首先是Product，它应该包含手机的零件元素：<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> PhoneProduct &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> brand;<span class="comment">//品牌</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> CPU;<span class="comment">//CPU</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> memorySize;<span class="comment">//内存大小</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> pixel;<span class="comment">//像素大小</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> setBrand(<span class="built_in">String</span> brand) &#123;</span><br><span class="line">        <span class="keyword">this</span>.brand = brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> setCPU(<span class="built_in">String</span> CPU) &#123;</span><br><span class="line">        <span class="keyword">this</span>.CPU = CPU;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> setMemorySize(<span class="built_in">String</span> memorySize) &#123;</span><br><span class="line">        <span class="keyword">this</span>.memorySize = memorySize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> setPixel(<span class="built_in">String</span> pixel) &#123;</span><br><span class="line">        <span class="keyword">this</span>.pixel = pixel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">String</span> toString() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"品牌："</span> + brand +</span><br><span class="line">                <span class="string">"\nCPU："</span> + CPU +</span><br><span class="line">                <span class="string">"\n内存大小："</span> + memorySize +</span><br><span class="line">                <span class="string">"\n像素大小："</span> + pixel;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可以看出，一台手机的构建元素有：品牌、CPU、内存大小以及像素大小，如果还有其他元素，只需要继续添加成员变量即可。<br>有了手机的构建元素，如何将这些元素拼接成手机，就是Builder要做的事情了：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">PhoneBuilder</span> &#123;</span><br><span class="line">    <span class="comment">//构建手机品牌</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildBrand</span>(<span class="params">String brand</span>)</span>;</span><br><span class="line">    <span class="comment">//构建手机CPU</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildCPU</span>(<span class="params">String cpu</span>)</span>;</span><br><span class="line">    <span class="comment">//构建手机内存</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildMemorySize</span>(<span class="params">String memorySize</span>)</span>;</span><br><span class="line">    <span class="comment">//构建手机像素大小</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildPixel</span>(<span class="params">String pixel</span>)</span>;</span><br><span class="line">    <span class="comment">//将各个零件进行拼接</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> PhoneProduct <span class="title">create</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到抽象的Builder类中有各个元素的组装方法，并且最后还有一个将手机进行组装的方法：<code>create()</code>。<br>接下来我们使用<strong>ConcreteBuilder</strong>来继承<strong>Builder</strong>并实现具体的组装细节：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcretePhoneBuilder</span> <span class="keyword">extends</span> <span class="title">PhoneBuilder</span> </span>&#123;</span><br><span class="line">    <span class="comment">//商品手机</span></span><br><span class="line">    <span class="keyword">private</span> PhoneProduct product = <span class="keyword">new</span> PhoneProduct();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildBrand</span><span class="params">(String brand)</span> </span>&#123;</span><br><span class="line">        product.setBrand(brand);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildCPU</span><span class="params">(String cpu)</span> </span>&#123;</span><br><span class="line">        product.setCPU(cpu);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildMemorySize</span><span class="params">(String memorySize)</span> </span>&#123;</span><br><span class="line">        product.setMemorySize(memorySize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildPixel</span><span class="params">(String pixel)</span> </span>&#123;</span><br><span class="line">        product.setPixel(pixel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PhoneProduct <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>ConcreteBuilder</strong>中包含了每个零件组装和最后拼接过程<strong>create()</strong>的所有细节。<br>到这里，我们作为一个手机生产商，已经具备了生产手机的能力，接下来就要接待客户了！<br>平时大家都说，客户是上帝。今天在这里，也是如此。<br>所以起到主导作用的，就是我们的客户<strong>Director</strong>：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">public</span> class PhoneDirector &#123;</span><br><span class="line"></span><br><span class="line">    private PhoneBuilder <span class="keyword">builder;</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"> </span>   public PhoneDirector(PhoneBuilder <span class="keyword">builder) </span>&#123;</span><br><span class="line">        this.<span class="keyword">builder </span>= <span class="keyword">builder;</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br><span class="line"></span><br><span class="line">    public PhoneProduct constuct(<span class="keyword">String </span><span class="keyword">brand, </span><span class="keyword">String </span>cpu, <span class="keyword">String </span>memorySize, <span class="keyword">String </span>pixel) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">builder.buildBrand(brand);</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">builder.buildCPU(cpu);</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">builder.buildMemorySize(memorySize);</span></span><br><span class="line"><span class="keyword"> </span>       <span class="keyword">builder.buildPixel(pixel);</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"> </span>       return <span class="keyword">builder.create();</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到<strong>Director</strong>中持有PhoneBuilder对象，这里的<strong>constuct(,,,,)</strong>就相当于客户的需求，告诉我们手机的具体配置，接着我们拿着具体需求去<strong>ConcreteBuilder</strong>中构建具体的手机，并返回给用户。<br>整个<strong>建造者模式</strong>就是这样的，接下来我们来做下简单的测试：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建Builder对象</span></span><br><span class="line">PhoneBuilder miBuilder = <span class="keyword">new</span> <span class="type">ConcretePhoneBuilder</span>();</span><br><span class="line"><span class="comment">//创建管理者</span></span><br><span class="line">PhoneDirector director = <span class="keyword">new</span> <span class="type">PhoneDirector</span>(miBuilder);</span><br><span class="line"><span class="comment">//生成商品</span></span><br><span class="line">PhoneProduct product = director.constuct(<span class="string">"小米"</span>, <span class="string">"骁龙825"</span>, <span class="string">"4GB"</span>, <span class="string">"1500万像素"</span>);</span><br><span class="line"><span class="comment">//展示构建结果</span></span><br><span class="line">textView.setText(product.toString());</span><br></pre></td></tr></table></figure></p>
<p>首先创建<strong>Builder</strong>并传递给<strong>Director</strong>，接下来调用<strong>Director</strong>的构建方法并传递需求，一台手机就构建出来了。<br>在这个过程中，管理者<strong>Director</strong>完全不知手机道构建细节。代码的扩展性以及可读性都有质的提升。</p>
<h2 id="模式变形"><a href="#模式变形" class="headerlink" title="模式变形"></a>模式变形</h2><p>在刚刚接触到Builder模式时，我就发现了于我而言，一个非常巨大的应用场景，完美解决一个让我极其难受的问题。<br><a href="https://YuanTiger.github.io/2017/07/11/Builder-Dialog/" target="_blank" rel="noopener">由于篇幅问题，模式变形我决定新起一篇文章中解释</a>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><a href="https://github.com/YuanTiger/Design-Pattern" target="_blank" rel="noopener">Demo我已经上传至GitHub，各位看官可自行食用</a>。<br>上面的例子，仅仅是个例子，看起来似乎仅仅是增加了工作量。<br>但事实并不是这样的，这种写法的扩展性、可读性都是有很大提升的，希望各位看官都可以理解这种<strong>代码思想</strong>。<br>还有一点是，<strong>建造者模式</strong>与之后要讲到的<strong>工厂模式</strong>类似，他们都是建造者模式，适用的场景也很相似。<br>一般来说，如果产品的建造很复杂，那么请用<strong>工厂模式</strong>；如果产品的建造<strong>更复</strong>杂，那么请用<strong>建造者模式</strong>。</p>
<h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><p>《Android源码设计模式解析与实战》 何红辉、关爱民 著</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/31/Design-Catalog/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/31/Design-Catalog/" itemprop="url">23种设计模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-31T14:52:23+08:00">
                2017-05-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><a href="https://YuanTiger.github.io/2017/05/27/Design-Single/" target="_blank" rel="noopener">单例模式</a></li>
<li><a href="https://YuanTiger.github.io/2017/07/05/Design-Builder/" target="_blank" rel="noopener">建造者模式</a></li>
<li><a href="https://YuanTiger.github.io/2017/07/15/Design-Clone/" target="_blank" rel="noopener">原型模式</a></li>
<li><a href="https://YuanTiger.github.io/2017/07/24/Design-Factory/" target="_blank" rel="noopener">工厂方法模式</a></li>
<li><a href="https://YuanTiger.github.io/2017/08/02/Design-Abs-Factory/" target="_blank" rel="noopener">抽象工厂模式</a></li>
<li><a href="https://YuanTiger.github.io/2017/08/02/Design-Strategy/" target="_blank" rel="noopener">策略模式</a></li>
<li><a href="https://yuantiger.github.io/2017/11/14/Design-State/" target="_blank" rel="noopener">状态模式</a></li>
<li><a href="https://yuantiger.github.io/2017/11/16/Design-Responsibility/" target="_blank" rel="noopener">责任链模式</a></li>
<li>解释器模式</li>
<li><a href="https://yuantiger.github.io/2018/08/27/Design-Command/" target="_blank" rel="noopener">命令模式</a></li>
<li>观察者模式</li>
<li>备忘录模式</li>
<li>迭代器模式</li>
<li>模板方法模式</li>
<li>访问者模式</li>
<li>中介者模式</li>
<li>代理模式</li>
<li>组合模式</li>
<li>适配器模式</li>
<li>装饰模式</li>
<li>享元模式</li>
<li>外观模式</li>
<li>桥接模式</li>
</ol>
<p>参考：《Android源码设计模式解析与实战》 何红辉、关爱民 著</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/27/Design-Single/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/27/Design-Single/" itemprop="url">应用最广-单例模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-27T10:45:14+08:00">
                2017-05-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="模式介绍"><a href="#模式介绍" class="headerlink" title="模式介绍"></a>模式介绍</h2><p>单例模式是应用最广泛的模式之一。<br>单例模式是为了确保一个类在整个项目中只有一个实例对象。<br><strong>单例模式最大的优势就是可以避免资源的浪费</strong>。<br>比如访问IO和数据库等资源时就应考虑使用单例模式。</p>
<h2 id="模式特点"><a href="#模式特点" class="headerlink" title="模式特点"></a>模式特点</h2><ol>
<li>构造方法私有化，使用<code>private</code>来修饰；</li>
<li>确保对象有且只有一个，尤其是在多线程的环境下；</li>
<li>通过静态方法或枚举返回已经实例化好的对象。</li>
</ol>
<h2 id="模式示例"><a href="#模式示例" class="headerlink" title="模式示例"></a>模式示例</h2><p>实现单例模式的方式有很多，不过核心是不变的，都要严格遵循单例模式的特点。<br>下面我们来介绍实现单例的方式：</p>
<ol>
<li><p>饿汉式</p>
 <figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> 饿汉式 </span>&#123;</span><br><span class="line">    <span class="comment">//自行实例化对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> 饿汉式 ourInstance = <span class="keyword">new</span> 饿汉式();</span><br><span class="line">    <span class="comment">//通过静态方法返回对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> 饿汉式 getInstance() &#123;</span><br><span class="line">        <span class="keyword">return</span> ourInstance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//构造方法私有化，不能通过new来创建对象</span></span><br><span class="line">    <span class="keyword">private</span> 饿汉式() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>值得一提的是，AndroidStudio在创建类时指定该类为单例的时候，默认就是使用饿汉式：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/design_single_01.png" alt=""><br>饿汉式写起来非常简单、快捷，但是缺点也显而易见：<br>在类初始化的时候，对象就已经创建好了。<br>如果说我们没有用到该类，就会造成资源的浪费。</p>
</li>
<li><p>懒汉式</p>
 <figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> 最简单的懒汉式 </span>&#123;</span><br><span class="line">    <span class="comment">//全项目唯一的对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> 最简单的懒汉式 ourInstance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造方法私有化</span></span><br><span class="line">    <span class="keyword">private</span> 最简单的懒汉式() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过静态方法来返回对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> 最简单的懒汉式 getInstance() &#123;</span><br><span class="line">        <span class="comment">//在调用该方法时进行判空，在对象为null时创建对象</span></span><br><span class="line">        <span class="keyword">if</span> (ourInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">            ourInstance = <span class="keyword">new</span> <span class="type"></span>最简单的懒汉式();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ourInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就是单例中懒汉式的最基本写法。<br>比起饿汉式，最大的优势就是不会造成资源的浪费。因为只有在用到时，才会进行对象的实例化。<br>但是就上面的写法而言，还存在一个很致命的问题：<br><strong>在多线程同时调用时，会出现多个实例对象的情况</strong>。<br><a href="https://github.com/YuanTiger/Design-Pattern" target="_blank" rel="noopener">Demo</a>里有对应的测试代码，出现的概率很小，但是确实会出现。<br>解决这个问题的方式也很简单，为静态方法添加同步锁：</p>
 <figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过静态方法来返回对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> 同步锁的懒汉式 getInstance() &#123;</span><br><span class="line">     <span class="comment">//在调用该方法时进行判空，在对象为null时创建对象</span></span><br><span class="line">        <span class="keyword">if</span> (ourInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ourInstance = <span class="keyword">new</span> 同步锁的懒汉式();</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="keyword">return</span> ourInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>synchronized</code>就是同步锁的关键字，加上该关键字，代表着该方法同时只能在唯一的一个线程中运行。<br>比如当10个线程去调用<code>同步锁的懒汉式.getInstance()</code>时，只有当第1个线程完成访问时，第2个线程才会开始执行该方法。当第1个线程访问完成后，单例对象就已经创建完成，所以第2个线程就会直接返回该对象，不会再去创建，这就保证了线程安全。<br>这样确实解决了我们所说的线程安全的问题，但是这种做法明显是低效率的：<br>我们的目的是保证项目中有且只有一个对象，上述代码确实实现了这个目的。但是当对象创建成功后，我们希望多线程访问的时候应该是异步高效、同时执行的的，而不是像上面那样队列式的，我要等你用完我才能用。所以就有了<strong>双重校验锁</strong>的懒汉式：</p>
 <figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> 同步锁的懒汉式 getInstance() &#123;</span><br><span class="line">    <span class="keyword">if</span> (ourInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">        synchronized (<span class="keyword">new</span> <span class="type">Object</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ourInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">                ourInstance = <span class="keyword">new</span> <span class="type"></span>同步锁的懒汉式()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ourInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种写法可以完美解决多线程效率低下的问题，那么到底是如何解决的？<br><strong>双重校验锁</strong>指的是会进行两次判空操作：</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ourInstance</span> == null</span><br></pre></td></tr></table></figure>
<p>一次在同步锁外，一次在同步锁内。<br>有的看官就有疑问了：两次判空？<br>首先是<code>synchronized</code>关键字，我们删除了方法的同步锁，将其移动到了方法内部，对</p>
  <figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ourInstance = <span class="keyword">new</span> <span class="type"></span>同步锁的懒汉式()</span><br></pre></td></tr></table></figure>
<p>单独加锁。这就代表着我们这个方法本身已经不是线程安全了，会有多个线程同时访问外层的<strong>if</strong>。如果同步锁内部没有判空，就会有多个线程等待对象创建，就会生成多个实例对象。<br>所以<strong>双重校验锁</strong>的每一步都非常关键，必不可少。<br><strong>双重校验锁</strong>的写法主要是为了在多线程创建对象时，用同步锁来保证对象的唯一。当对象创建完成后，同步锁外层的判空操作就不成立了，那么会直接返回对象，整个方法就与同步锁无关，多线程访问时也就不需要等待了。<br><strong>双重校验锁</strong>懒汉式，看起来已经非常完美了！<br>但是，很遗憾。<br>因为JVM存在<strong>指令重排</strong>的优化，又会产生新的问题。<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/gaoxiao/heirenwenhao_2.jpg" alt=""><br><strong>指令重排</strong>是JVM为了提高程序运行效率。<br>JVM规范规定，<strong>指令重排序可以在不影响单线程程序执行结果的情况下改变代码执行顺序</strong>。<br>该处会产生<strong>指令重排</strong>的代码是</p>
 <figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ourInstance</span> = new 同步锁的懒汉式()<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>这句代码在JVM看来，主要是做了以下三件事情：<br>（1）给<code>ourInstance</code>分配内存；<br>（2）调用构造方法创建对象，对对象进行初始化；<br>（3）将<code>ourInstance</code>对象指向JVM分配的内存空间（此步完成之后，<code>ourInstance</code>就是非null了）。<br>因为JVM存在<strong>指令重排</strong>，所以在不影响最终结果的情况下，JVM会选择性能最优的的顺序执行：<br>也就是说，上面三件事情，执行的顺序可能是1-2-3，也有可能是1-3-2。<br>1-2-3，1-3-2，有区别吗？<br>在结果上来看，没有任何区别。<br>但是在多线程的情况下，是有风险的：<br>假设线程x的执行顺序是1-3-2，当3执行完成时，<code>ourInstance</code>就已经不为空了，但是2还没有执行完成时，线程y介入了。此时线程y会发现<code>ourInstance</code>已经不为null了，但是其实<code>ourInstance</code>的初始化工作并未完成，这样很明显就会产生异常。<br>解决方法也非常简单，利用<code>volatile</code>关键字即可：</p>
 <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> 完美的懒汉式 &#123;</span></span><br><span class="line">    <span class="comment">//全项目唯一的对象</span></span><br><span class="line">    <span class="comment">//volatile关键字，禁止指令重排</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span>  <span class="keyword">static</span> 完美的懒汉式 ourInstance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造方法私有化</span></span><br><span class="line">    <span class="keyword">private</span> 完美的懒汉式() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过静态方法来返回对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> 完美的懒汉式 getInstance() &#123;</span><br><span class="line">        <span class="comment">//在调用该方法时进行判空，在对象为null时创建对象</span></span><br><span class="line">        <span class="keyword">if</span> (ourInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">new</span> Object()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ourInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    ourInstance = <span class="keyword">new</span> 完美的懒汉式();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ourInstance;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>上述代码就是一个完美的懒汉式了，利用<code>volatile</code>关键字来禁止JVM的<strong>指令重排</strong>。</p>
</li>
<li><p>枚举（Enum）</p>
 <figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> public <span class="class"><span class="keyword">enum</span> 枚举单例 &#123;</span></span><br><span class="line"></span><br><span class="line">    INSTANCE;</span><br><span class="line">    </span><br><span class="line">    public String getUrl()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"http://www.baidu.com"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用起来也非常简单：</p>
 <figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">String url</span> = 枚举单例.INSTANCE.getUrl();</span><br></pre></td></tr></table></figure>
<p>简直完美啊！简单易用，代码清晰！<br>但是，很少有人选择用枚举单例。<br>可能。。。。。？</p>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>简单回顾一下：<br>单例模式是保证了一个类在一个项目中有且只有一个实例对象。<br>这样做的目的是为了节省内存的开支。<br>单例模式的写法主要有：</p>
<ul>
<li><strong>项目初始化时就创建好的饿汉式</strong></li>
<li><strong>在第一次使用时才进行创建、但要注意线程安全的懒汉式</strong></li>
<li><strong>使用非常简单的枚举</strong><br>##<h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><a href="http://wuchong.me/blog/2014/08/28/how-to-correctly-write-singleton-pattern/" target="_blank" rel="noopener">Jark’s Blog-如何正确地写出单例模式
</a><br>《Android源码设计模式解析与实战》 何红辉、关爱民 著</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/23/Google-IO-2017/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/23/Google-IO-2017/" itemprop="url">Google I/O 2017 Android</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-23T18:50:21+08:00">
                2017-05-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Google I/O 2017已经结束了一周了，这篇小文将简单总结一下Android的变化。<br>不得不说，本次I/O大会，Android从主角完美蜕变成了配角。人工智能成为重心。<br>参考：<a href="http://developers.googleblog.cn/" target="_blank" rel="noopener">Google中文博客</a></p>
<h2 id="Android-O预览版"><a href="#Android-O预览版" class="headerlink" title="Android O预览版"></a>Android O预览版</h2><p>以流畅度优化为重心的Android最新版本Android O预览版正式发布:<br><a href="https://www.google.com/android/beta?pli=1" target="_blank" rel="noopener">Android O预览版地址</a><br><a href="http://developers.googleblog.cn/2017/03/android-o-developer-preview.html" target="_blank" rel="noopener">Android O新特性</a></p>
<h2 id="Project-Treble"><a href="#Project-Treble" class="headerlink" title="Project Treble"></a>Project Treble</h2><p>全新的Android框架，帮助缩短设备制造商升级Android版本所需时间和减少工作量，此项目将从Andorid O开始实施。</p>
<h2 id="Android-Go"><a href="#Android-Go" class="headerlink" title="Android Go"></a>Android Go</h2><p>针对低配置（1GB运行内存以下）的Android系统，为了增加Android系统的市场占有率，最低可支持512M的手机配置。</p>
<h2 id="Kotlin"><a href="#Kotlin" class="headerlink" title="Kotlin"></a>Kotlin</h2><p>一门设计精美并得到Google认可的语言，Android将其作为了一级语言。Google认为它可以使Android开发更快、更有趣。<a href="https://www.kotlincn.net/docs/reference/" target="_blank" rel="noopener">附上翻译教程</a>。</p>
<h2 id="AndroidStudio3-0-Canary"><a href="#AndroidStudio3-0-Canary" class="headerlink" title="AndroidStudio3.0 Canary"></a>AndroidStudio3.0 Canary</h2><p>AndroidStudio开发工具的又一次革新。本次预览版包含三大主要功能：</p>
<ul>
<li>全新的应用性能分析工具</li>
<li>完全支持Kotlin语言</li>
<li>加快大规模项目的Gradle构建速度<br><a href="http://developers.googleblog.cn/2017/05/android-studio-30-canary-1.html" target="_blank" rel="noopener">具体详情可以看这里。</a></li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>其他技能的话各位看官可以移步官方博客去了解，中文版的已经出了，而且网络上也已经到处都是译文和总结了。<br>包括人工智能、VR、Goole Assistant、Google Home产品等等。<br>作为一名Android小将,本次大会要学习、要适应的东西还是很多的。<br>共勉。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/19/Android-EditText-card-limit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/19/Android-EditText-card-limit/" itemprop="url">EditText每4位自动添加空格</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-19T16:32:31+08:00">
                2017-05-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h2><p>刚拿到需求，很简单的一个功能，二话不说，很快就出来了：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/et_1.gif" alt=""><br>完美！顺利上线！<br>没过几天领导拿着手机过来说：“这一堆数字在一起看着很费劲，像其他App一样，加个空格吧！“<br>小Kiss，当即就答应了下来。</p>
<h2 id="拓展功能"><a href="#拓展功能" class="headerlink" title="拓展功能"></a>拓展功能</h2><p>下面就来在基本功能上做拓展：每4位，自动添加空格。<br>看似很小的功能，在开发的过程中，遇到了非常多的问题与难点：</p>
<ul>
<li>EditText输入框监听死循环</li>
<li>输入框中的空格无法删除（删除又添加）</li>
<li>从中间删除一个数字产生的一系列问题</li>
<li>输入框光标位置的控制问题</li>
</ul>
<p>之前踩坑的过程就不再赘述了，太心酸….<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/gaoxiao/%E6%83%A8%E4%B8%8D%E5%BF%8D%E7%9D%B9.png" alt=""><br>经过一系列实验，最后定下来的思路如下：</p>
<ol>
<li>当输入框的内容改变时，就将内容取出拆分为一个一个的字符，在每4位的中间添加空格，最后一个4位不能添加。用这种拼接字符的方法是为了解决当用户删除中间的数字，会导致空格位置错位的问题。</li>
<li>当用户删除中间的字符时，要记录该动作并且记录光标位置，保证重新排序完成后，光标的位置在应该在的位置。</li>
</ol>
<p>大概就这2步，就可以实现这个功能，下面一步一来,我们先实现空格的添加，保证内容永远满足4位后一个空格：<br>下面先看EditText的监听：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">et_credit_number.addTextChangedListener(<span class="keyword">new</span> TextWatcher() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> count, <span class="keyword">int</span> after)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> before, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable s)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取输入框中的内容,不可以去空格</span></span><br><span class="line">        String etContent = EditTextUtils.getText(et_credit_number);</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(etContent)) &#123;</span><br><span class="line">            bt_submit.setEnabled(<span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//重新拼接字符串</span></span><br><span class="line">        String newContent = AppUtils.addSpeaceByCredit(etContent);</span><br><span class="line">        <span class="comment">//如果有改变，则重新填充</span></span><br><span class="line">        <span class="comment">//防止EditText无限setText()产生死循环</span></span><br><span class="line">        <span class="keyword">if</span> (!etContent.equals(newContent)) &#123;</span><br><span class="line">            et_credit_number.setText(newContent);</span><br><span class="line">            <span class="comment">//保证光标在最后，因为每次setText都会导致光标重置</span></span><br><span class="line">            <span class="comment">//这样最基本地解决了光标乱跳的问题</span></span><br><span class="line">            et_credit_number.setSelection(newContent.length());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断是否满足信用卡格式，注意去空格判断</span></span><br><span class="line">        <span class="keyword">if</span> (MatcheUtils.isCreditNumber(newContent.replaceAll(<span class="string">" "</span>, <span class="string">""</span>))) &#123;</span><br><span class="line">            bt_submit.setEnabled(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bt_submit.setEnabled(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>没有难点，重新拼接字符串我单独封装了出来：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> addSpeaceByCredit(<span class="keyword">String</span> content) &#123;</span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(content)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//去空格</span></span><br><span class="line">    content = content.replaceAll(<span class="string">" "</span>, <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(content)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//卡号限制为16位</span></span><br><span class="line">    <span class="keyword">if</span> (content.length() &gt; <span class="number">16</span>) &#123;</span><br><span class="line">        content = content.substring(<span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    StringBuilder <span class="keyword">new</span><span class="type">String</span> = <span class="keyword">new</span> <span class="type">StringBuilder</span>();</span><br><span class="line">    <span class="keyword">for</span> (int i = <span class="number">1</span>; i &lt;= content.length(); i++) &#123;</span><br><span class="line">        <span class="comment">//当为第4位时，并且不是最后一个第4位时</span></span><br><span class="line">        <span class="comment">//拼接字符的同时，拼接一个空格</span></span><br><span class="line">        <span class="comment">//如果在最后一个第四位也拼接，会产生空格无法删除的问题</span></span><br><span class="line">        <span class="comment">//因为一删除，马上触发输入框改变监听，又重新生成了空格</span></span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">4</span> == <span class="number">0</span> &amp;&amp; i != content.length()) &#123;</span><br><span class="line">            <span class="keyword">new</span><span class="type">String</span>.append(content.charAt(i - <span class="number">1</span>) + <span class="string">" "</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//如果不是4位的倍数，则直接拼接字符即可</span></span><br><span class="line">            <span class="keyword">new</span><span class="type">String</span>.append(content.charAt(i - <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span><span class="type">String</span>.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里每一步的含义，我都写了注释，应该问题不大，下面运行一下：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/et_2.gif" alt=""><br>完美！空格正常添加了！<br>但是光标乱跳的问题，我特地演示了一下。<br>用字符排序的方式来做这个功能的原因是这个，当用户从中间删除字符时，我们需要将所有添加的空格位置都进行审查，并重新进行空格的添加，所以我认为重新排序字符是非常恰当的一种做法。当然这仅仅是我的愚见，可能有更优的做法。<br>现在我们就要进行第二步，当用户删除中间字符时，我们要判断用户本次操作是删除字符，并且保存本次删除的光标位置，在删除完成、排序完成之后，将光标移动到保存的光标位置。<br>思路有了，下面就看最终代码好了。</p>
<h2 id="功能展示"><a href="#功能展示" class="headerlink" title="功能展示"></a>功能展示</h2><p><img src="http://7xvzby.com1.z0.glb.clouddn.com/et_3.gif" alt=""><br>输入框监听的代码：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">et_credit_number.addTextChangedListener(<span class="keyword">new</span> <span class="type">TextWatcher</span>() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> void beforeTextChanged(CharSequence s, int start, int count, int after) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> void onTextChanged(CharSequence s, int start, int before, int count) &#123;</span><br><span class="line">        <span class="comment">//因为重新排序之后setText的存在</span></span><br><span class="line">        <span class="comment">//会导致输入框的内容从0开始输入，这里是为了避免这种情况产生一系列问题</span></span><br><span class="line">        <span class="keyword">if</span> (start == <span class="number">0</span> &amp;&amp; count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">String</span> editTextContent = EditTextUtils.getText(et_credit_number);</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(editTextContent) || TextUtils.isEmpty(lastString)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        editTextContent = AppUtils.addSpeaceByCredit(editTextContent);</span><br><span class="line">        <span class="comment">//如果最新的长度 &lt; 上次的长度，代表进行了删除</span></span><br><span class="line">        <span class="keyword">if</span> (editTextContent.length() &lt;= lastString.length()) &#123;</span><br><span class="line">            deleteSelect = start;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            deleteSelect = editTextContent.length();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> void afterTextChanged(Editable s) &#123;</span><br><span class="line">        <span class="comment">//获取输入框中的内容,不可以去空格</span></span><br><span class="line">        <span class="keyword">String</span> etContent = EditTextUtils.getText(et_credit_number);</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(etContent)) &#123;</span><br><span class="line">            bt_submit.setEnabled(<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//重新拼接字符串</span></span><br><span class="line">        <span class="keyword">String</span> <span class="keyword">new</span><span class="type">Content</span> = AppUtils.addSpeaceByCredit(etContent);</span><br><span class="line">        <span class="comment">//保存本次字符串数据</span></span><br><span class="line">        lastString = <span class="keyword">new</span><span class="type">Content</span>;</span><br><span class="line">        <span class="comment">//如果有改变，则重新填充</span></span><br><span class="line">        <span class="comment">//防止EditText无限setText()产生死循环</span></span><br><span class="line">        <span class="keyword">if</span> (!etContent.equals(<span class="keyword">new</span><span class="type">Content</span>)) &#123;</span><br><span class="line">            et_credit_number.setText(<span class="keyword">new</span><span class="type">Content</span>);</span><br><span class="line">            <span class="comment">//保证光标的位置</span></span><br><span class="line">            et_credit_number.setSelection(deleteSelect &gt; <span class="keyword">new</span><span class="type">Content</span>.length() ? <span class="keyword">new</span><span class="type">Content</span>.length() : <span class="type">deleteSelect</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断是否满足信用卡格式，注意去空格判断</span></span><br><span class="line">        <span class="keyword">if</span> (MatcheUtils.isCreditNumber(<span class="keyword">new</span><span class="type">Content</span>.replaceAll(<span class="string">" "</span>, <span class="string">""</span>))) &#123;</span><br><span class="line">            bt_submit.setEnabled(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bt_submit.setEnabled(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p> 这边主要利用了<code>onTextChanged()</code>的监听，判断用户操作是删除操作时，保存光标的位置。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>项目我已经上传到了<a href="https://github.com/YuanTiger/EditText_Card_Limit" target="_blank" rel="noopener">我的GitHub</a>，有兴趣的同学可以去参考一下。<br>这个功能的坑远远超出了我的想象，我才不会说这个项目我就运行了100遍而已！<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/gaoxiao/%E9%80%80%E5%87%BA%E8%A3%85%E9%80%BC%E7%95%8C.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/15/Android-Handler/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/15/Android-Handler/" itemprop="url">Android_Handler机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-15T14:57:07+08:00">
                2017-05-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Handler是Android消息通讯当中最常用的方式之一。<br>本篇小文将会从Handler的源码角度去浅析Handler。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>因为Handler这个东西其实大家都会用，源码也多多少少地了解过，所以直接将最关键的话，写到前面，对源码感兴趣的看官可以在看完总结后再往下浏览源码：</p>
<ol>
<li><p>创建Handler</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Handler</span> <span class="keyword">handler</span> = <span class="keyword">new</span> <span class="keyword">Handler</span>();</span><br></pre></td></tr></table></figure>
<p>在主线程当中，可以直接进行Handler的创建。如果是在子线程当中，在创建之前必须先初始化Looper，否则会RuntimeException:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Looper.prepare();</span><br><span class="line"><span class="keyword">Handler</span> <span class="keyword">handler</span> = <span class="keyword">new</span> <span class="keyword">Handler</span>();</span><br><span class="line">handler.sendEmptyMessage(<span class="number">8</span>);</span><br><span class="line">Looper.loop();</span><br></pre></td></tr></table></figure>
<p>在初始化Looper的同时，一定要调用<code>Looper.loop()</code>来启动循环，否则Handler仍然无法正常接收。<br>并且因为<code>Looper.loop()</code>有死循环的存在，<code>Looper.loop()</code>之后的代码将无法执行，所以需要将<code>Looper.loop()</code>放在代码的最后，详情可参考<code>ActivityThread</code>中的main方法创建Looper的流程。<br>查看Handler的构造方法可以发现，其实Looper是Handler必要元素，但是在主线程初始化的时候，Looper已经初始化完成，所以无需再创建Looper，但是子线程的Looper需要我们自己初始化。<br>并且Looper在每个线程只能存在一个，如果再去手动创建Looper也会抛出RuntimeException。</p>
</li>
<li><p>发送Handler<br>handler的发送有很多方法，包括发送延时Handler、即时Handler、MessageHandler等等，但是查看这些发送方法的源码，就会发现这些发送Message的方法最终都会调用<code>MessageQueue.enqueueMessage()</code>方法。<br>这个方法其实就是将我们发送的Message入队到MessageQueue队列中，这样，我们的消息就已经发送成功，等待执行了。</p>
</li>
<li>取出Handler<br>在<code>Looper.prepare()</code>的同时，总会执行<code>looper.loop()</code>语句与之对应。<br>查看<code>loop()</code>源码会发现，这个方法中有一个for(;;)的死循环，会无限执行<code>MessageQueue.next()</code>，而<code>MessageQueue</code>就是我们上一步将Meesage入队的对象。<br>也就是说在创建Looper时，就会启动<code>MessageQueue</code>的无限遍历。如果<code>MessageQueue</code>为空，<code>Looper.loop()</code>就会进入休眠，直到再有Message插入到<code>MessageQueue</code>中。<br>如果取到Message则会调用message.target.dispatchMessage()，将消息分发给对应的Handler。</li>
<li><p>如何在<code>loop()</code>休眠之后唤醒<code>loop()</code>？<br>在Meesage入队的时候，也就是执行<code>MessageQueue.enqueueMessage()</code>方法时，<code>enqueueMessage()</code>有一个<code>nativeWeak()</code>的native方法，如果有消息进入，并且Looper是休眠状态，则会执行该方法唤醒Looper:</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// We can <span class="built_in">assume</span> mPtr != <span class="number">0</span> because mQuitting <span class="built_in">is</span> <span class="literal">false</span>.</span><br><span class="line"><span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">    nativeWake(mPtr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>整体流程<br>先调用<code>Looper.prepare()</code>创建Looper，在创建的同时会自动调用<code>Looper.loop()</code>执行死循环loop()。注意<code>Looper.loop()</code>一定放到代码的最后一行。<br>死循环中会执行<code>MessageQueue.next()</code>方法去取出队列中的消息，当消息为空时，<code>MessageQueue.next()</code>方法中会执行<code>nativePollOnce()</code>的native方法休眠<code>Looper.loop()</code>死循环。当有新的消息插入到<code>MessageQueue</code>中，也就是调用<code>MessageQueue.enqueueMessage()</code>方法，这个方法当中会判断Looper是否是休眠状态，如果是休眠状态会执行<code>nativeWeak()</code>的native方法来唤醒Looper()。</p>
</li>
</ol>
<h2 id="Handler的使用"><a href="#Handler的使用" class="headerlink" title="Handler的使用"></a>Handler的使用</h2><ol>
<li><p>主线程<br>在<code>主线程</code>当中，Handler可以作为一个成员变量直接进行创建：</p>
 <figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//注意，Handler属于android.os包</span></span><br><span class="line"><span class="keyword">private</span> Handler <span class="keyword">handler</span> = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">         System.out.println(<span class="string">"主线程的Handler"</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<p>接着我们试着发送Handler：</p>
 <figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送一个空Handler，what为888，延迟3秒到达</span></span><br><span class="line">    <span class="keyword">handler</span>.sendEmptyMessageDelayed(<span class="number">888</span>,<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发送Handler有很多方法：发送空Message、发送延迟的空Message、发送Message、发送延迟的Message等：<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/handler/handler_send_funcation.png" alt=""></p>
<p>接着我们运行项目，就会发现3s后控制台有Log的打印。</p>
</li>
<li><p>子线程<br>在<code>子线程</code>中创建Handler的流程，和在<code>主线程</code>基本一致，只是多了一步而已，但这一步非常关键。<br>我们先按照<code>主线程</code>的步骤，看看会有什么问题。<br>在<code>子线程</code>中创建Handler：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.run();</span><br><span class="line">        Handler <span class="keyword">handler</span> = <span class="keyword">new</span> Handler()&#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"子线程的Handler"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;.start();</span><br></pre></td></tr></table></figure>
<p>接着我们运行项目，会发现项目崩溃了：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java<span class="selector-class">.lang</span><span class="selector-class">.RuntimeException</span>: Can<span class="string">''</span>t create handler inside thread that has not called Looper.prepare()</span><br><span class="line">at android<span class="selector-class">.os</span><span class="selector-class">.Handler</span>.&lt;init&gt;(Handler<span class="selector-class">.java</span>:<span class="number">200</span>)</span><br><span class="line">at android<span class="selector-class">.os</span><span class="selector-class">.Handler</span>.&lt;init&gt;(Handler<span class="selector-class">.java</span>:<span class="number">114</span>)</span><br><span class="line">at com<span class="selector-class">.my</span><span class="selector-class">.oo</span><span class="selector-class">.MainActivity</span>$<span class="number">2</span>$<span class="number">1</span>.&lt;init&gt;(MainActivity<span class="selector-class">.java</span>:<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>很明显，错误信息说的是<strong>在当前线程中创建Handler失败因为没有执行Looper.prepare()</strong>。<br>那我们按照错误原因，在创建Handler之前，加上<code>Looper.prepare()</code>:</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//子线程</span></span><br><span class="line"><span class="keyword">new</span> Thread()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.run();</span><br><span class="line">        <span class="comment">//添加Looper.prepare()；</span></span><br><span class="line">        Looper.prepare();</span><br><span class="line">        <span class="comment">//之后再创建Handler</span></span><br><span class="line">        Handler <span class="keyword">handler</span> = <span class="keyword">new</span> Handler()&#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"子线程的Handler"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//发送消息</span></span><br><span class="line">        <span class="keyword">handler</span>.sendEmptyMessage(<span class="number">111</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;.start();</span><br></pre></td></tr></table></figure>
<p>这次再运行项目，我们就会发现项目正常运行没有问题。但是发送Handler仍然无法接收，那是因为我们没有启动Looper的遍历：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//子线程</span></span><br><span class="line"><span class="keyword">new</span> Thread()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.run();</span><br><span class="line">        <span class="comment">//添加Looper.prepare()；</span></span><br><span class="line">        Looper.prepare();</span><br><span class="line">        <span class="comment">//之后再创建Handler</span></span><br><span class="line">        Handler <span class="keyword">handler</span> = <span class="keyword">new</span> Handler()&#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"子线程的Handler"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//发送消息</span></span><br><span class="line">        <span class="keyword">handler</span>.sendEmptyMessage(<span class="number">111</span>);</span><br><span class="line">        <span class="comment">//启动Looper的遍历功能</span></span><br><span class="line">        Looper.loop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;.start();</span><br></pre></td></tr></table></figure>
<p>这里一定要注意，<strong><code>Looper.loop()</code>必须放到代码的最后。因为<code>Looper.loop()</code>中有死循环，会导致之后的代码无法执行</strong>。这里可以等到查看<code>主线程</code>创建过程的源码时证实。</p>
</li>
<li>使用总结<br>Handler的使用就是这么简单，要注意的就是<code>子线程</code>当中使用Handler时，一定要先调用<code>Looper.prepare()</code>，最后调用<code>Looper.loop()</code>，否则项目会崩溃或无法接收Handler。至于为什么会这样，我们在源码里面找原因。</li>
</ol>
<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><ol>
<li><p>Handler创建<br>我们先看Handler的构造方法：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span>(<span class="params">Callback callback, boolean <span class="keyword">async</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//....省略部分代码</span></span><br><span class="line">    mLooper = Looper.myLooper();</span><br><span class="line">    <span class="keyword">if</span> (mLooper == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">            <span class="string">"Can't create handler inside thread that has not called Looper.prepare()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mQueue = mLooper.mQueue;</span><br><span class="line">    mCallback = callback;</span><br><span class="line">    mAsynchronous = <span class="keyword">async</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到，Handler的构造方法当中是去获取了一个叫做<code>Looper</code>的类对象，如果该对象为空，就会抛出刚才我们上面发生的异常。所以我们需要在创建Handler之前，一定要先执行<code>Looper.prepare()</code>。<br>那么问题来了，为什么<code>主线程</code>就不需要执行<code>Looper.prepare()</code>就可以直接创建Handler呢？<br>我们可以随意根据代码猜测一下：<br>这里Handler的构造方法的代码已经很明显了，<code>Looper</code>类是必要的，那么<code>主线程</code>可以成功创建Handler，是不是就代表着主线程的<code>Looper</code>不为空呢？<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/gaoxiao/zhenxiang_just_one.jpeg" alt=""><br>是不是主线程在初始化的时候<code>Looper</code>也跟着初始化了呢！？带着看破一切(瞎猜)的思路，我们来看<code>主线程</code>的初始化源码。<br>经过了长时间的Google，我们知道了主线程类叫做:<code>ActivityThread</code>。<br>该类当中有main方法：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> void main(<span class="keyword">String</span>[] args) &#123;</span><br><span class="line">    <span class="comment">//....省略部分代码</span></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> <span class="type">ActivityThread</span>();</span><br><span class="line">    thread.attach(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">        sMainThreadHandler = thread.getHandler();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line">        Looper.myLooper().setMessageLogging(<span class="keyword">new</span><span class="type"></span></span><br><span class="line"><span class="type"></span>                LogPrinter(Log.DEBUG, <span class="string">"ActivityThread"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// End of event ActivityThreadMain.</span></span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    Looper.loop();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">RuntimeException</span>(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们很自然（惊奇）地发现，在主线程创建的过程中，果然（真的）有与<code>Looper</code>类相关的内容。<br>这里有重点（敲黑板）：之前说的Looper.loop()后的代码不会执行，这里得到了证实：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Looper.<span class="built_in">loop</span>();</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br></pre></td></tr></table></figure>
<p>下面异常的意思是：主线程的Looper意外退出。<br>也就是当Looper.loop()执行失败的意思，但是当Looper.loop()执行成功时，是不会执行下面的代码的！因为<strong><code>Looper.loop()</code>必须放到方法的最后，否则会导致后面的代码无法执行</strong>。<br>好的，接着往下看，点进<code>prepareMainLooper()</code>会发现，其实内部就是调用了<code>prepare()</code>：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">prepareMainLooper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    prepare(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (Looper.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sMainLooper != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The main Looper has already been prepared."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sMainLooper = myLooper();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以到现在，我们解决了我们的第一个问题：为什么主线程当中不需要执行<code>Looper.prepare()</code>。<br>接着，我们去浏览<code>Looper.prepare()</code>：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span>(<span class="params">boolean quitAllowed</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sThreadLocal.<span class="keyword">get</span>() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//new Looper()并设置给当前线程</span></span><br><span class="line">    sThreadLocal.<span class="keyword">set</span>(<span class="keyword">new</span> Looper(quitAllowed));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没什么东西，前面对线程当中的Looper进行了判空，如果不为空则会抛出<code>RuntimeEception</code>。<br>这也就是说，每个线程当中只能有一个Looper，当你尝试去创建第二时，就会发生异常，所以<code>Looper.prepare()</code>每个线程中只能调用一次。<br>后面则new了Looper并且设置给当前线程。<br><code>new Looper()</code>中初始化了<code>MessageQueue</code>：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Looper</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</span><br><span class="line">    mQueue = <span class="keyword">new</span> MessageQueue(quitAllowed);</span><br><span class="line">    mThread = Thread.currentThread();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，Handler的创建就完成了！</p>
</li>
<li><p>Handler发送Meesage<br>Handler的发送方法有很多，包括发送延时Handler、及时Handler、空Hanlder等等。<br>查看源码会发现，所有发送方法最后调用的都是同一个方法：<code>MessageQueue</code>的<code>enqueueMessage()</code>。<br>有的看官就会问：Handler中怎么会有<code>MeesageQueue</code>？<br>这个在上面<code>new Looper()</code>的源码中已经体现了：<br><code>new Handler()</code>中<code>new Looper()</code>，<br><code>new Looper()</code>中<code>new MessageQueue()</code>。<br>所以其实初始化Handler的同时，<code>Looper</code>和<code>MeesageQueue</code>都已经初始化完成了。<br>下面我们来看消息入队方法<code>MessageQueue.enqueueMessage()</code>的全部源码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">boolean enqueueMessage(Message msg, long <span class="keyword">when</span>) &#123;</span><br><span class="line">        <span class="comment">//Meesage是否可用</span></span><br><span class="line">        <span class="comment">//这里的msg.target指的就是发送该Message的Handler</span></span><br><span class="line">        <span class="keyword">if</span> (msg.target == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> new IllegalArgumentException(<span class="string">"Message must have a target."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (msg.isInUse()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> new IllegalStateException(msg + <span class="string">" This message is already in use."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//同步锁</span></span><br><span class="line">        synchronized (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">//判断是否调用了quit()方法，即取消信息</span></span><br><span class="line">            <span class="comment">//如果调用了，则其实Handler的Looper已经销毁，无法发送消息</span></span><br><span class="line">            <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">                IllegalStateException e = new IllegalStateException(</span><br><span class="line">                        msg.target + <span class="string">" sending message to a Handler on a dead thread"</span>);</span><br><span class="line">                Log.w(TAG, e.getMessage(), e);</span><br><span class="line">                msg.recycle();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将消息添加到MessageQueue的具体操作</span></span><br><span class="line">            <span class="comment">//每来一个新的消息，就会按照延迟时间的先后重新进行排序</span></span><br><span class="line">            msg.markInUse();</span><br><span class="line">            msg.<span class="keyword">when</span> = <span class="keyword">when</span>;</span><br><span class="line">            Message p = mMessages;</span><br><span class="line">            boolean needWake;</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="literal">null</span> || <span class="keyword">when</span> == <span class="number">0</span> || <span class="keyword">when</span> &lt; p.<span class="keyword">when</span>) &#123;</span><br><span class="line">                <span class="comment">// New head, wake up the event queue if blocked.</span></span><br><span class="line">                msg.next = p;</span><br><span class="line">                mMessages = msg;</span><br><span class="line">                needWake = mBlocked;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Message prev;</span><br><span class="line">                <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                    prev = p;</span><br><span class="line">                    p = p.next;</span><br><span class="line">                    <span class="keyword">if</span> (p == <span class="literal">null</span> || <span class="keyword">when</span> &lt; p.<span class="keyword">when</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;</span><br><span class="line">                        needWake = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                msg.next = p; <span class="comment">// invariant: p == prev.next</span></span><br><span class="line">                prev.next = msg;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果Looper.loop()是休眠状态</span></span><br><span class="line">            <span class="comment">//则调用native方法唤醒loop()</span></span><br><span class="line">            <span class="comment">//---重点---Looper的唤醒</span></span><br><span class="line">            <span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">                nativeWake(mPtr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>将Message入队到<code>MeesageQueue</code>的核心代码，就是这些。<br>根据注释也基本能理解该方法的作用。</p>
</li>
<li><p>取出Message<br>取出Meesage想必大家都知道在哪里取出：<code>Looper.loop()</code>：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Looper的判空</span></span><br><span class="line">    <span class="keyword">final</span> Looper me = myLooper();</span><br><span class="line">    <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> MessageQueue queue = me.mQueue;</span><br><span class="line">    <span class="comment">// Make sure the identity of this thread is that of the local process,</span></span><br><span class="line">    <span class="comment">// and keep track of what that identity token actually is.</span></span><br><span class="line">    Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="comment">//取出Message，死循环</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//取出Meesage的核心代码</span></span><br><span class="line">        <span class="comment">//在当next()返回为空时，next()中会休眠loop()</span></span><br><span class="line">        Message msg = queue.next(); <span class="comment">// might block</span></span><br><span class="line">        <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br><span class="line">        <span class="keyword">final</span> Printer logging = me.mLogging;</span><br><span class="line">        <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">            logging.println(<span class="string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.<span class="keyword">target</span> + <span class="string">" "</span> +</span><br><span class="line">                    msg.callback + <span class="string">": "</span> + msg.what);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> traceTag = me.mTraceTag;</span><br><span class="line">        <span class="keyword">if</span> (traceTag != <span class="number">0</span> &amp;&amp; Trace.isTagEnabled(traceTag)) &#123;</span><br><span class="line">            Trace.traceBegin(traceTag, msg.<span class="keyword">target</span>.getTraceName(msg));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            msg.<span class="keyword">target</span>.dispatchMessage(msg);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</span><br><span class="line">                Trace.traceEnd(traceTag);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</span><br><span class="line">            logging.println(<span class="string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.<span class="keyword">target</span> + <span class="string">" "</span> + msg.callback);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Make sure that during the course of dispatching the</span></span><br><span class="line">        <span class="comment">// identity of the thread wasn't corrupted.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> newIdent = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">if</span> (ident != newIdent) &#123;</span><br><span class="line">            Log.wtf(TAG, <span class="string">"Thread identity changed from 0x"</span></span><br><span class="line">                    + Long.toHexString(ident) + <span class="string">" to 0x"</span></span><br><span class="line">                    + Long.toHexString(newIdent) + <span class="string">" while dispatching to "</span></span><br><span class="line">                    + msg.<span class="keyword">target</span>.getClass().getName() + <span class="string">" "</span></span><br><span class="line">                    + msg.callback + <span class="string">" what="</span> + msg.what);</span><br><span class="line">        &#125;</span><br><span class="line">        msg.recycleUnchecked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Looper.loop()</code>的核心就是取出Message，而取出Message的核心就是<code>MeesageQueue.next()</code>：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"> Message <span class="keyword">next</span>() &#123;</span><br><span class="line">    <span class="comment">// Return here if the message loop has already quit and been disposed.</span></span><br><span class="line">    <span class="comment">// This can happen if the application tries to restart a looper after quit</span></span><br><span class="line">    <span class="comment">// which is not supported.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> ptr = mPtr;</span><br><span class="line">    <span class="keyword">if</span> (ptr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> pendingIdleHandlerCount = -<span class="number">1</span>; <span class="comment">// -1 only during first iteration</span></span><br><span class="line">    <span class="keyword">int</span> nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</span><br><span class="line">            Binder.flushPendingCommands();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//唤醒Looper.loop()的native方法</span></span><br><span class="line">        nativePollOnce(ptr, nextPollTimeoutMillis);</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// Try to retrieve the next message.  Return if found.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">            Message prevMsg = <span class="keyword">null</span>;</span><br><span class="line">            Message msg = mMessages;</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="keyword">null</span> &amp;&amp; msg.target == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Stalled by a barrier.  Find the next asynchronous message in the </span></span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    prevMsg = msg;</span><br><span class="line">                    msg = msg.<span class="keyword">next</span>;</span><br><span class="line">                &#125; <span class="keyword">while</span> (msg != <span class="keyword">null</span> &amp;&amp; !msg.isAsynchronous());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (now &lt; msg.when) &#123;</span><br><span class="line">                    <span class="comment">// Next message is not ready.  Set a timeout to wake up when it </span></span><br><span class="line">                    nextPollTimeoutMillis = (<span class="keyword">int</span>) Math.min(msg.when - now, Integer.M</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Got a message.</span></span><br><span class="line">                    mBlocked = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (prevMsg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        prevMsg.<span class="keyword">next</span> = msg.<span class="keyword">next</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mMessages = msg.<span class="keyword">next</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    msg.<span class="keyword">next</span> = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Returning message: "</span> + msg);</span><br><span class="line">                    msg.markInUse();</span><br><span class="line">                    <span class="keyword">return</span> msg;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// No more messages.</span></span><br><span class="line">                nextPollTimeoutMillis = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Process the quit message now that all pending messages have been hand</span></span><br><span class="line">            <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">                dispose();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If first time idle, then get the number of idlers to run.</span></span><br><span class="line">            <span class="comment">// Idle handles only run if the queue is empty or if the first message</span></span><br><span class="line">            <span class="comment">// in the queue (possibly a barrier) is due to be handled in the future.</span></span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt; <span class="number">0</span></span><br><span class="line">                    &amp;&amp; (mMessages == <span class="keyword">null</span> || now &lt; mMessages.when)) &#123;</span><br><span class="line">                pendingIdleHandlerCount = mIdleHandlers.<span class="keyword">size</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// No idle handlers to run.  Loop and wait some more.</span></span><br><span class="line">                mBlocked = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mPendingIdleHandlers == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPendingIdleHandlers = <span class="keyword">new</span> IdleHandler[Math.max(pendingIdleHandlerCo</span><br><span class="line">            &#125;</span><br><span class="line">            mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Run the idle handlers.</span></span><br><span class="line">        <span class="comment">// We only ever reach this code block during the first iteration.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pendingIdleHandlerCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> IdleHandler idler = mPendingIdleHandlers[i];</span><br><span class="line">            mPendingIdleHandlers[i] = <span class="keyword">null</span>; <span class="comment">// release the reference to the handler</span></span><br><span class="line">            <span class="keyword">boolean</span> keep = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                keep = idler.queueIdle();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">"IdleHandler threw exception"</span>, t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!keep) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    mIdleHandlers.remove(idler);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Reset the idle handler count to 0 so we do not run them again.</span></span><br><span class="line">        pendingIdleHandlerCount = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// While calling an idle handler, a new message could have been delivered</span></span><br><span class="line">        <span class="comment">// so go back and look again for a pending message without waiting.</span></span><br><span class="line">        nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>取出Meesage的代码有些多，大部分都是一些优化逻辑：next() 方法还做了其他一些事情，这些其它事情是为了提高系统效果，利用消息队列在空闲时通过 idle handler 做一些事情，比如 gc 等等。</p>
</li>
</ol>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>到这里Handler源码的浅析就结束了，总结在最上方，建议各位看官再去看一下总结加深印象。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/09/Android-Premission-Manger/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/09/Android-Premission-Manger/" itemprop="url">Android权限管理简单描述</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-09T18:38:37+08:00">
                2017-05-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>首先安利一个大家都知道的事情，Google推出了<a href="https://developer.android.google.cn/index.html" target="_blank" rel="noopener">Android开发文档中文版</a>。<br>还有<a href="http://developers.googleblog.cn/" target="_blank" rel="noopener">谷歌开发者中文博客</a>。<br>好的，进入正题：<br>说到权限变化大家马上就想到Android API23（6.0）之后权限系统大改。<strong>当<code>build.gradle</code>中<code>targetSdkVersion</code>设置小于23时，会继续引用旧版本权限管理机制，当<code>targetSdkVersion</code>大于等于23时，则会使用新的权限管理。</strong></p>
<h2 id="targetSdkVersion-lt-23"><a href="#targetSdkVersion-lt-23" class="headerlink" title="targetSdkVersion &lt; 23"></a>targetSdkVersion &lt; 23</h2><p>当<code>targetSdkVersion</code>小于23时，你的项目会继续使用旧版本的权限机制：</p>
<ol>
<li>用户在安装时获取到所有权限，在使用权限时无需进行预判断。</li>
<li>虽然使用旧版的权限机制，但是在<code>设置-App详情</code>中也可以找到权限管理将其关闭。如果用户手动来到设置将权限关闭，我们的项目在用到该权限时会发生Crash，所以如果使用低版本权限管理，请将需要用到权限的地方<code>try-catch</code>起来。</li>
<li>那些低版本权限提示弹窗都是手机厂商自定义的。他们拥有系统权限，在检测到你的App使用权限时会提示用户权限授权，如果用户拒绝则替用户到设置中心关闭权限。</li>
<li>综上，不想使用最新的权限管理，则将<code>targetSdkVersion</code>设置为小于23即可，并且将用到权限的代码<code>try-catch</code>起来。这里需要知道不是所有的权限都可以关闭的，只有涉及用户隐私的权限才会在设置中展示出来，方便用户进行手动关闭。</li>
</ol>
<h2 id="targetSdkVersion-gt-23"><a href="#targetSdkVersion-gt-23" class="headerlink" title="targetSdkVersion &gt;= 23"></a>targetSdkVersion &gt;= 23</h2><ol>
<li>将权限分为了<code>普通权限</code>和<code>隐私权限</code>，普通权限在清单文件中声明则直接获取。隐私权限也需要在清单文件中声明，但是在安装完成后，所有的隐私权限都为拒绝状态，需要在用到隐私权限时判断权限是否开启，否则项目直接发生Crash。</li>
<li>第一次使用隐私权限时直接弹出系统的权限授权弹窗，用户授权则永久授权，拒绝则无法使用此权限。第二次或者之后用到此权限我们需要做一个自己的弹窗来描述该权限的作用，然后关闭我们自己的弹窗后会弹出系统的权限授权弹窗，此时弹窗上会有不再提醒的提示文字，如果用户勾选了不再提醒则再也不会提醒并且权限关闭。</li>
<li>检测权限关闭并且勾选了不再提醒我们可以提示用户到设置中心中手动打开权限。用户如果打开则永久授权（当然还是可以再关闭的）。</li>
<li>权限组的概念也需要知道，比如获取写文件权限时，用户授权则会同时获取读文件的权限，因为他们属于同一个权限组。</li>
<li>综上，新版本权限的适配也很简单，主要工作是在所有用到隐私权限的地方添加权限是否授权的判断、后续的一些判断细节以及回调。Google写的权限工具<a href="https://github.com/googlesamples/easypermissions" target="_blank" rel="noopener">easypermissions</a>是我在权限改版时用的，还是非常好用的。demo可参考<a href="https://github.com/googlesamples/easypermissions" target="_blank" rel="noopener">官方demo</a>。</li>
</ol>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>推荐各位看官最好都及时地进行权限管理的高版本适配，毕竟用户对权限很敏感，这是一个趋势。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/08/Java_understanding-OO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="孟远">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孟远">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/08/Java_understanding-OO/" itemprop="url">理解面向对象</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-08T15:10:09+08:00">
                2017-05-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>面向对象是一种软件开发的方法，同类的还有面向过程。<br>面向对象指的是在程序设计中采用Java的封装、继承、多态、六大原则特性来设计代码。<br>它其实考验的是你审视代码的角度，运用这些特性，可以写出让人赏心悦目、简单易懂的代码。<br>不运用这些特性当然也可以进行开发。不过代码的可读性、扩展性、灵活性等会大大下降，冗余度、维护成本等会大大上升。</p>
<h2 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h2><ol>
<li>概念<br>在Java中，封装就是将一些通用、常用的功能方法写到一个新类中，那么当我们用到这些功能时，直接去调用这个新类中的方法即可。这就像是有一个人A，他拥有一些技能，当我用到这些技能时，不需要自己去学习这些技能，只需要去找A即可。</li>
<li>优点<br>提高代码的重用，减少重复代码，提高代码的可读性、方便理解。而且封装的思想也对应了Java中<strong>一处编程，到处执行</strong>的思想。</li>
<li>实例<br>实例就不用多说了，平时写代码我们总会自己创建一个utils包，存放一些自己或者别人写的utils类。</li>
</ol>
<h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><ol>
<li>概念<br>继承是从已有的类中派生出新的类，新的类能吸收已有类的数据属性和行为，并能扩展新的能力（来自<a href="http://baike.baidu.com/link?url=rbdZPwv35frNtyyl5BNnTXN2y9xCnTKldC3Bi4pyMySKda51KlD5Gk46IIUt1cNKrBiZoThiu0Rj76UmCJJXOFvv87kxMxSBYQtgrCbRA2u" target="_blank" rel="noopener">百度百科</a>）。<br>这种官方语言太难讲，而且各位看官也看着费劲。我还是直接说自己的理解吧。<br>首先继承的含义，就是一直我们口中所说的父类（基类）和子类。子类通过关键字<code>extends</code>继承父类，就可以拥有父类的非私有的属性和方法。<br><strong>在Java中，继承是单一继承+多层继承的。</strong></li>
<li>优点<br>提高代码的重用，减少重复的代码。增加了软件开发的灵活性。</li>
<li>缺点<br>由于多层继承的存在，所以无限使用继承特性的话，会造成子类的过度冗余。</li>
</ol>
<h2 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h2><ol>
<li>概念<br>多态指的是同一个方法，会因为对象的不同导致不同的结果。<br>没错，就是这样！<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/gaoxiao/heirenwenhao_2.jpg" alt=""><br>多态的三要素一定要知道。这个东西理解了自然就记住了。<br><strong>继承、重写、父类的引用指向子类的对象</strong>。<br>具体含义，还是在后面举个栗子来解释一下。</li>
<li>优点<br>增加了软件开发的灵活性，简化了编程和修改过程。</li>
<li><p>实例<br>首先我们定义了一个汽车接口<code>Car</code>，接口中有一个方法用来获取车的类型：</p>
 <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>Car &#123;</span><br><span class="line"></span><br><span class="line">    String getCarType();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，我们创建了兰博基尼，以及五菱宏光实现了这个接口。<br>五菱宏光：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WuLingHongGuang</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getCarType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="string">"五菱宏光"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>兰博基尼：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LanBoJiNi</span> <span class="keyword">implements</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCarType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"兰博基尼"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，我们利用多态的特性，来创建并执行接下来的代码：</p>
 <figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args)&#123;</span><br><span class="line">    Car car1 = <span class="keyword">new</span> LanBoJiNi();</span><br><span class="line">    Car car2 = <span class="keyword">new</span> WuLingHongGuang();</span><br><span class="line"></span><br><span class="line">    System.out.<span class="built_in">println</span>(<span class="string">"车1的类型："</span>+car1.getCarType());</span><br><span class="line">    System.out.<span class="built_in">println</span>(<span class="string">"车2的类型："</span>+car2.getCarType());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到控制台的结果：</p>
 <figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">车<span class="number">1</span>的类型：兰博基尼</span><br><span class="line">车<span class="number">2</span>的类型：五菱宏光</span><br></pre></td></tr></table></figure>
</li>
<li><p>总结<br>通过实例，再结合多态三要素：<strong>继承、重写、父类的引用指向子类的对象</strong>。<br>兰博基尼和五菱宏光实现了<code>Car</code>接口(继承)，重写了<code>Car</code>中的<code>getCarType()</code>(重写)，接下来最关键的要素，我们用父类的引用，创建子类的对象。<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/oo_duotai1.png" alt=""><br>那么接下来，当你去调用<code>getCarType()</code>时，Java会首先调用子类中的<code>getCarType()</code>，而不是父类<code>Car</code>中的。<br>其实这个实例，并不能帮你很好地理解多态。它只是很生硬地运用了多态的特性。在项目中运用多态非常的重要，这个需要自己实战才能好好理解。</p>
</li>
</ol>
<h2 id="六大原则"><a href="#六大原则" class="headerlink" title="六大原则"></a>六大原则</h2><p>六大原则包括：单一职责、开闭、里氏替换、依赖倒置、接口隔离、迪米特。接下来我们一个一个来理解这些原则的思想。</p>
<h3 id="单一职责原则-Single-Responsibility-Principle"><a href="#单一职责原则-Single-Responsibility-Principle" class="headerlink" title="单一职责原则(Single Responsibility Principle)"></a>单一职责原则(Single Responsibility Principle)</h3><ol>
<li>概念<br><strong>就一个类而言，应该仅有一个引起它变化的原因。</strong><br>非常容易理解的一个原则，并且非常重要！但这个原则是一个备受争议的原则，和别人争论这个原则，是屡试不爽的。<br><img src="http://7xvzby.com1.z0.glb.clouddn.com/gaoxiao/huxiangshanghai.jpg" alt=""><br>因为单一职责原则划分界限并不总是那么清晰，更多的时候是根据个人经验来界定的。</li>
</ol>
<h3 id="开闭原则-Open-Close-Principle"><a href="#开闭原则-Open-Close-Principle" class="headerlink" title="开闭原则(Open Close Principle)"></a>开闭原则(Open Close Principle)</h3><ol>
<li>概念<br><strong>就一个类或方法而言，应该对于扩展是开放的，对于修改是关闭的。</strong><br>软件也有自己的生命周期，越往后迭代，代码越多，冗余度也会随之提升，维护成本也就越来越高，可能一次不经意地bug修改就会破坏之前已经通过测试的代码。因此，当软件需要变化时，我们应该通过扩展的方式去实现，而不是通过修改原有代码来实现。<br>当然，这是理想愿景，在实际开发中往往是<strong>扩展</strong>和<strong>修改</strong>同时存在的，因为再好的代码，终有一天也会有无法适应的场景出现。所以，我们要做的，就是在开发新东西的时候，尽可能地考虑多的场景，尽可能降低修改的可能性。并且当我们发现代码有“腐朽”的味道时，应该尽早地进行代码重构，使代码恢复到正常的“进化”过程。</li>
</ol>
<h3 id="里氏替换原则-Liskov-Substitution-Principle"><a href="#里氏替换原则-Liskov-Substitution-Principle" class="headerlink" title="里氏替换原则(Liskov Substitution Principle)"></a>里氏替换原则(Liskov Substitution Principle)</h3><ol>
<li>概念<br><strong>所有引用父类的地方，都可以透明的传递子类对象。</strong><br>这个原则简直就是多态的完美体现。<br>这个原则强调的是运用多态时，应该注子类的适配，使之无论传递任何子类对象，都能完美适应父类引用，不会产生异常。</li>
<li><p>实例<br>我们继续引用多态的那个实例，在那个实例之上做些修改。<br>现在我们是汽车制造商，你只需要告诉我品牌，我就可以生产出对应品牌的车。<br>我们目前只能生产<code>兰博基尼</code>和<code>五菱宏光</code>，那么接下来我们改变一下main方法，生产一下这2辆车:</p>
 <figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) &#123;</span><br><span class="line">    <span class="comment">//创建兰博基尼</span></span><br><span class="line"> System.out.<span class="built_in">println</span>(<span class="string">"生产了一辆："</span> + createCar(<span class="keyword">new</span> LanBoJiNi()));</span><br><span class="line">    <span class="comment">//创建五菱宏光</span></span><br><span class="line">    System.out.<span class="built_in">println</span>(<span class="string">"生产了一辆："</span> + createCar(<span class="keyword">new</span> WuLingHongGuang()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">String</span> createCar(Car car) &#123;</span><br><span class="line">    <span class="built_in">return</span> car.getCarType();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 上面当中，我们通过<code>createCar(Car car)</code>来创建了<code>兰博基尼</code>和<code>五菱宏光</code>，虽然<code>createCar()</code>要求的参数是<code>Car</code>，但是我们传入了子类对象<code>兰博基尼</code>和<code>五菱宏光</code>。并且这2个类都做了很好的适配(一个栗子而已，大家就认为其实我的兰博基尼其实是经过500道独特工序才制造出来的，五菱宏光是另外的500道工序)，无论我传入谁，都可以完美生产，不会产生异常。这就是里氏替换原则！</p>
</li>
</ol>
<h3 id="依赖倒置原则-Dependence-Inversion-Principle"><a href="#依赖倒置原则-Dependence-Inversion-Principle" class="headerlink" title="依赖倒置原则(Dependence Inversion Principle)"></a>依赖倒置原则(Dependence Inversion Principle)</h3><ol>
<li>概念<br>依赖倒置原则指代了一种特定的解耦形式，使得高层次的模块不依赖低层次的模块去实现细节。主要关键点有以下3点：</li>
</ol>
<ul>
<li>高层模块不应该依赖低层模块，两者都应该依赖其抽象。</li>
<li>抽象不应该依赖细节。</li>
<li><p>细节应该依赖细节。</p>
<p>  在Java语言中，抽象指的就是接口或抽象类，两者都是不能直接被实例化的；细节就是实现类，实现接口或者继承抽象类而产生的类就是细节，可以直接被实例化。高层模块就是抽象，底层模块就是具体实现类。一句话概括的话就是：<strong>面向接口编程</strong>。面向接口编程是面向对象的精髓之一。</p>
</li>
</ul>
<h3 id="接口隔离原则-Interface-Segregation-Principles"><a href="#接口隔离原则-Interface-Segregation-Principles" class="headerlink" title="接口隔离原则(Interface Segregation Principles)"></a>接口隔离原则(Interface Segregation Principles)</h3><ol>
<li>概念<br><strong>类不应该依赖它不需要的接口。</strong><br>另一种定义是：类依赖的接口都应该是最小单位。<br>那么接口隔离原则其实就是要求我们将庞大、臃肿的接口按照某种规则，将其拆封成更小的、更具体的接口，这样客户端只需要依赖它需要的接口即可。<br>接口隔离原则的目的就是使系统解耦，从而更容易进行重构、更改等操作。</li>
</ol>
<h3 id="迪米特原则-Law-of-Demeter"><a href="#迪米特原则-Law-of-Demeter" class="headerlink" title="迪米特原则(Law of Demeter)"></a>迪米特原则(Law of Demeter)</h3><ol>
<li>概念<br><strong>一个对象应该对其他对象有最少的依赖。</strong><br>通俗地讲，一个类应该对自己需要耦合或调用的类知道得最少，类的内部如何实现与调用者或者依赖者没关系，调用者或依赖者只需要知道它需要的方法即可，其他的一概不用管。<br>如果两个对象的关系过于密切，那么当一个对象发生变化时，另一个对象就会产生不可预估的风险。</li>
</ol>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>在应用的开发过程中，最难的不是完成应用的开发工作，而是在后续的升级、维护过程中让应用系统能够拥抱变化。拥抱变化也就意味着在满足需求且不破坏系统稳定性的前提下保持高扩展性、高内聚、低耦合，在经历了各版本的变更之后依然保持清晰、灵活、稳定的系统架构。<br>当然这是一个理想的情况，但我们必须要朝着这个方向去努力，那么遵循面向对象思想就是我们走向理想的第一步。</p>
<h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><ol>
<li>《Android源码设计模式解析与实战》 何红辉、关爱民 著</li>
<li><a href="https://baike.baidu.com/" target="_blank" rel="noopener">百度百科</a></li>
</ol>
<blockquote>
<p>有任何问题都可以联系我：<a href="mailto:mengyuanzz@126.com" target="_blank" rel="noopener">mengyuanzz@126.com</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="孟远" />
            
              <p class="site-author-name" itemprop="name">孟远</p>
              <p class="site-description motion-element" itemprop="description">一名Android开发小将</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/YuanTiger" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mengyuantiger@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/YuanTiger/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-zhihu"></i>知乎</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/7b265b275ad0" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-jianshu"></i>简书</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">孟远</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
